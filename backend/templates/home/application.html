{% extends "layouts/base.html" %}

{% block title %} KG4DT {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} sidebar-mini sidebar-collapse {% endblock body_class %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/fontawesome-free/css/all.min.css') }}">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/select2/css/select2.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.css') }}">
  <!-- TagsInput -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/bootstrap4-tagsinput/tagsinput.css') }}">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css') }}">
  <!-- Bootstrap-select -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/bootstrap-select/dist/css/bootstrap-select.css') }}">
  <!-- iCheck -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css') }}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/jqvmap/jqvmap.min.css') }}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/adminlte.min.css') }}">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/overlayScrollbars/css/OverlayScrollbars.min.css') }}">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/daterangepicker/daterangepicker.css') }}">
  <!-- summernote -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/summernote/summernote-bs4.min.css') }}">
  <!-- jspreadsheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/jspreadsheet/jexcel.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/jspreadsheet/jsuites.css') }}">

{% endblock stylesheets %}

{% block content %}
  
  <div class="content-wrapper">

    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="row ml-1">
          <div class="col-sm-6">
            <h1 class="text-dark">KG4DT</h1>
          </div>
          <div class="col-sm-6">
            <div class="float-sm-right mr-2" style="display: flex">
              <select id="model-type" class="selectpicker">
                <option selected data-thumbnail="{{ url_for('static', filename='assets/img/model_type/scipy.png') }}">scipy</option>
              </select>
            </div>
          </div>
        </div>
    </div>
    <!-- /.content-header -->

    <section class="content">
      <div class="container-fluid">
        <div class="card mb-4">
          <div class="card-body">
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Species</b>
                <!-- : used as species identifier, name or formula, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="species"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Reaction</b>
                <!-- : reaction formula, A + 2 B > 3 C, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="reaction"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Stream</b>
                <!-- : used as stream identifier, stream 1, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="stream"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Solvent</b>
                <!-- : used as solvent identifier, water, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="solvent"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Catalyst</b>
                <!-- : used as catalyst identifier, Enzyme, e.g. -->
              </a>
              <input data-role="tagsinput" maxTags=1 id="catalyst"></input>
            </div>
          </div>
        </div>


        <div class="card mb-4">
          <div class="card-body mt-3">
            <div class="row">
              <div class="col-sm-6" style="display: flex;">
                <h5 class="ml-4 mr-4" style="height: 28px; padding-top: 7px;">Data</h5>
                <div style="display: flex; width: 500px;">
                  <select id="import" class="selectpicker" data-width="160px">
                    <option selected>website</option>
                    <option>local</option>
                  </select>
                  <div class="ml-3">
                    <input id="local-path" type="file" accept=".csv" style="display: none; margin-right: -50px; padding-top: 4.5px;">
                    <div>
                      <select id="website-case" class="selectpicker" data-width="221px" style="display: none;">
                        <option disabled selected hidden></option>
                        <option value="dushman/data.csv">dushman</option>
                        <option value="esterification/data_mecn_60-360rpm.csv">esterification_base_case</option>
                        <option value="esterification/data_mecn_0rpm.csv">esterification_0rpm_case</option>
                        <option value="esterification/data_toluene_360rpm.csv">esterification_toluene_case</option>
                      </select>
                    </div>
                  </div>
                </div>
                <button id="import-btn" class="btn btn-primary ml-3" style="height: 38px;">Import</button>
                <button id="save-btn" class="btn btn-primary ml-3" style="height: 38px;">Save</button>
              </div>
              <div class="col-sm-6">
                <div class="float-sm-right" style="display: flex">
                </div>
              </div>
            </div>
            <div id="input" class="ml-3 mt-3 mb-3">
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-body mt-3 mb-3">
            <div class="row mb-3">
              <div class="col-sm-6" style="display: flex;">
                <h5 class="ml-4 mr-4" style="margin-top: auto; margin-bottom: auto;">Calculation</h5>
                <select id="mode" data-placeholder="Select an option">
                  <option selected>simulation</option>
                  <option >calibration</option>
                </select>
                <button id="run-btn" class="btn btn-primary ml-3" style="height: 38px;">Run</button>
              </div>
            </div>
            <div class="row mb-4">
              <div class="mb-4" style="display: flex; width: 100%; padding-left: 7.5px">
                <h6 class="ml-4 mr-4" style="margin-top: auto; margin-bottom: auto; white-space: nowrap; width: 94px;">Parameter:</h6>
                <select id="parameter" class="select2 dropup" data-dropup-auto="false" multiple data-width="600px"></select>
              </div>
              <div style="display: flex;">
                <div id="parameter-form" class="ml-4" style="width: 100%;">
                  <div id="parameter-header" style="width: 100%; display: flex; border-top: 1px solid #e9ecef;">
                    <div class="mt-2" style="color: grey; display: flex;">
                      <div style="display: flex; padding-left: 7.5px;">
                        <div style="width: 220px; text-align: center;"><b>Parameter</b></div>
                        <div style="width: 180px; text-align: center;"><b>Reaction</b></div>
                        <div style="width: 120px; text-align: center;"><b>Solvent</b></div>
                        <div style="width: 120px; text-align: center;"><b>Species</b></div>
                      </div>
                      <div style="display: flex;">
                          <span id="init-header" style="margin-left: 4px; width: 120px; text-align: center;"><b>initial value</b></span>
                          <span id="min-header" style="margin-left: 4px; width: 120px; text-align: center;"><b>min</b></span>
                          <span id="max-header" style="margin-left: 4px; width: 120px; text-align: center;"><b>max</b></span>
                          <span id="value-header" style="margin-left: 4px; width: 120px; text-align: center;"><b>calibrated value</b></span>
                      </div>
                    </div>
                  </div>
                  <div id="parameter-line-template" style="width: 100%; display: none;">
                    <div class="mt-2" style="display: flex;">
                      <div style="display: flex; color: grey; padding-left: 7.5px;">
                        <div class="parameter-line-name-symbol-unit" style="width: 220px; text-align: center;">
                          <span style="white-space: nowrap;"></span>
                          <span></span>
                          <span></span>
                        </div>
                        <div class="parameter-line-reaction" style="width: 180px; text-align: center;">
                          <span></span>
                        </div>
                        <div class="parameter-line-solvent" style="width: 120px; text-align: center;">
                          <span></span>
                        </div>
                        <div class="parameter-line-species" style="width: 120px; text-align: center;">
                          <span></span>
                        </div>
                      </div>
                      <div class="parameter-line-value" style="display: flex;">
                        <input class="form-control init" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                        <input class="form-control min" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                        <input class="form-control max" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                        <input class="form-control value" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="plot" class="row" style="display: none; padding-top: 15px; border-top: 1px solid #e9ecef;">
              <div style="width: 33%; padding-left: 1%; padding-right: 1%;">
                <div style="text-align: center;">
                  <h5 class="plot-title" style="margin-bottom: 0; font-size: 22px;">Concentration Profile</h5>
                </div>
                <div id="profile" style="height: 400px; width: 100%; ">
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Sample:</div>
                  <select id="profile-sample" class="selectpicker dropup" data-dropup-auto="false" data-width="100%"></select>
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Variable:</div>
                  <select id="profile-variable" class="select2 dropup" data-dropup-auto="false" multiple data-width="100%"></select>
                </div>
              </div>
              <div style="width: 33%; padding-left: 1%; padding-right: 1%;">
                <div style="text-align: center;">
                  <h5 class="plot-title" style="margin-bottom: 0; font-size: 22px;">Inlet-Outlet Concentration</h5>
                </div>
                <div id="statistics" style="height: 400px; width: 100%;">
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Sample:</div>
                  <select id="statistics-sample" class="selectpicker dropup" data-dropup-auto="false" data-width="100%"></select>
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Species:</div>
                  <select id="statistics-species" class="select2 dropup" data-dropup-auto="false" multiple data-width="100%"></select>
                </div>
              </div>
              <div style="width: 33%; padding-left: 1%; padding-right: 1%;">
                <div style="text-align: center;">
                  <h5 class="plot-title" style="margin-bottom: 0; font-size: 22px;">Simulation vs. Experiment</h5>
                </div>
                <div id="parity" style="height: 400px; width: 100%;">
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Species:</div>
                  <select id="parity-sample" class="selectpicker dropup" data-dropup-auto="false" data-width="100%"></select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="height: 0.1px;"></div>
      </div>
    </section>
  </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- jQuery -->
  <script src="{{ url_for('static', filename='assets/plugins/jquery/jquery.min.js') }}"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="{{ url_for('static', filename='assets/plugins/jquery-ui/jquery-ui.min.js') }}"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>$.widget.bridge('uibutton', $.ui.button)</script>
  <!-- Bootstrap 4 -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
  <!-- Bootstrap-select -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap-select/dist/js/bootstrap-select.min.js') }}"></script>
  <!-- Select2 -->
  <script src="{{ url_for('static', filename='assets/plugins/select2/js/select2.full.min.js') }}"></script>
  <!-- TagsInput -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap4-tagsinput/tagsinput.js') }}"></script>
  <!-- Bootstrap4 Duallistbox -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js') }}"></script>
  <!-- InputMask -->
  <script src="{{ url_for('static', filename='assets/plugins/moment/moment.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/inputmask/jquery.inputmask.min.js') }}"></script>
  <!-- date-range-picker -->
  <script src="{{ url_for('static', filename='assets/plugins/daterangepicker/daterangepicker.js') }}"></script>
  <!-- bootstrap color picker -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js') }}"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="{{ url_for('static', filename='assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js') }}"></script>
  <!-- Bootstrap Switch -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap-switch/js/bootstrap-switch.min.js') }}"></script>
  <!-- ChartJS -->
  <script src="{{ url_for('static', filename='assets/plugins/chart.js/Chart.min.js') }}"></script>
  <!-- Sparkline -->
  <script src="{{ url_for('static', filename='assets/plugins/sparklines/sparkline.js') }}"></script>
  <!-- JQVMap -->
  <script src="{{ url_for('static', filename='assets/plugins/jqvmap/jquery.vmap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/jqvmap/maps/jquery.vmap.usa.js') }}"></script>
  <!-- jQuery Knob Chart -->
  <script src="{{ url_for('static', filename='assets/plugins/jquery-knob/jquery.knob.min.js') }}"></script>
  <!-- daterangepicker -->
  <script src="{{ url_for('static', filename='assets/plugins/moment/moment.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/daterangepicker/daterangepicker.js') }}"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="{{ url_for('static', filename='assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js') }}"></script>
  <!-- Summernote -->
  <script src="{{ url_for('static', filename='assets/plugins/summernote/summernote-bs4.min.js') }}"></script>
  <!-- overlayScrollbars -->
  <script src="{{ url_for('static', filename='assets/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js') }}"></script>
  <!-- jspreadsheet -->
  <script src="{{ url_for('static', filename='assets/plugins/jspreadsheet/jexcel.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/jspreadsheet/jsuites.js') }}"></script>
  <!-- flot -->
  <script src="{{ url_for('static', filename='assets/plugins/flot/lib/jquery.event.drag.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/lib/jquery.mousewheel.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.canvaswrapper.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.colorhelpers.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.axislabels.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.legend.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.saturated.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.browser.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.drawSeries.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.uiConstants.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.navigate.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.touchNavigate.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.hover.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.touch.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.selection.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.dashes.js') }}"></script>
  <!-- AdminLTE App -->
  <script src="{{ url_for('static', filename='assets/js/adminlte.js') }}"></script>

  <script type="text/javascript">{{ entity_json | safe }}</script>
  <script type="text/javascript">{{ model_context_json | safe }}</script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var inputs = document.querySelectorAll('input');
      inputs.forEach(function(input) {
        input.addEventListener('wheel', function(event) {
          event.preventDefault();
        });
      });
    });
  </script>

  <script>
    if (sessionStorage.getItem('modelContext')) {
      var modelContext = JSON.parse(sessionStorage.getItem('modelContext'));
      loadModelContext(modelContext);
    };
    $(document).on('click', '.top-down-rule-link', function() {
      sessionStorage.removeItem('modelContext');
    });
    $(document).on('click', '.top-down-exploration-link', function() {
      sessionStorage.removeItem('modelContext');
    });

    $('#model-type').find('option').each((idx, elem) => {
      if ($(elem).attr('data-thumbnail')) {
        $(elem).attr('data-content', '<img width="20px" src=' + $(elem).attr('data-thumbnail') + '/>&nbsp;&nbsp;&nbsp;' + $(elem).text());
      }
    });
    $('#model-type').selectpicker();
    $('#mode').selectpicker();
    $('#import').selectpicker();
    $('#local-path').selectpicker();

    $(document).on('change', '#import', function() {
      if ($('#import').val() == 'local') {
        $('#local-path').css('display', 'flex');
        $('#website-case').parent().css('display', 'none');
      }
      if ($('#import').val() == 'website') {
        $('#local-path').css('display', 'none');
        $('#website-case').parent().css('display', 'flex');
      }
    })
    setTimeout(function() {$('#import').val('website').trigger('change');}, 100);

    function speciesValid() {
      var species = $('#species').val().split(',');
      $('#species').prev().children().each(function(index, elem) {
        var symbol = document.createElement('a');
        var span = document.createElement('span');
        symbol.innerHTML = species[index];
        span.setAttribute('data-role', 'remove');
        $(elem).empty().append(symbol).append(span);
      })
    }
    $(document).on('change', '#species', speciesValid);

    function reactionValid() {
      var species = $('#species').val().split(',');
      var reactions = $('#reaction').val().split(',');
      var reactionVal = [];
      var re = new RegExp("^((\\d+ )?.+ \\+ )*(\\d+ )?.+ > ((\\d+ )?.+ \\+ )*(\\d+ )?.+$");
      var reNum = new RegExp("^\\d+$");
      $('#reaction').prev().children().each(function(index, elem) {
        var reaction = reactions[index];
        if (re.test(reaction)) {
          var lhs_species = $.map(reaction.split(' > ')[0].split(' + '), function(s, i) {
            if (reNum.test(s.split(' ')[0])) {
              return s.split(' ').slice(1).join(' ');
            } else {
              return s;
            }
          });
          var rhs_species = $.map(reaction.split(' > ')[1].split(' + '), function(s, i) {
            if (reNum.test(s.split(' ')[0])) {
              return s.split(' ').slice(1).join(' ');
            } else {
              return s;
            }
          });
          var reaction_species = $.merge(lhs_species, rhs_species);
          if (reaction_species.every(function(s) {return species.includes(s);})) {
            var formula = document.createElement('a');
            var span = document.createElement('span');
            formula.innerHTML = reaction;
            span.setAttribute('data-role', 'remove');
            $(elem).empty().append(formula).append(span);
            reactionVal.push(reaction);
          } else {
            $('#reaction').prev().remove(elem);
          }
        }
      })
      $('#reaction').val(reactionVal.join(','));
    }
    $(document).on('change', '#reaction', reactionValid)

    function catalystValid() {
      var catalysts = $('#catalyst').val().split(',');
      if (catalysts.length > 1) {
        $('#catalyst').val(catalysts[0]).trigger('change');
        $('#catalyst').prev().children('span').each(function(index, elem) {
          if (index > 0) {
            $(elem).remove();
          }
        });
      } else {
        $('#catalyst').prev().children().each(function(index, elem) {
          var symbol = document.createElement('a');
          var span = document.createElement('span');
          symbol.innerHTML = catalysts[index];
          span.setAttribute('data-role', 'remove');
          $(elem).empty().append(symbol).append(span);
        });
      }
    }
    $(document).on('change', '#catalyst', catalystValid);

    function loadModelContext(modelContext) {
      $('#species').val(modelContext['basic']['species']);
      $('#reaction').val(modelContext['basic']['reactions']);
      $('#stream').val(modelContext['basic']['streams']);
      $('#solvent').val(modelContext['basic']['solvents']);
      $('#catalyst').val(modelContext['basic']['catalysts']);
      $('#species').prop('disabled', true);
      $('#reaction').prop('disabled', true);
      $('#stream').prop('disabled', true);
      $('#solvent').prop('disabled', true);
      $('#catalyst').prop('disabled', true);
    }
    
    function convertParameterSymbol(symbol) {
      symbol = symbol.replaceAll('\n', '');
      symbol = symbol.replaceAll(' ', '');
      var subReg = new RegExp('<msub>[^<>]*?<mi>([^<>]*?)<\/mi>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<\/msub>');
      symbol = symbol.replace(subReg, '$1<sub>$2</sub>');
      var subReg = new RegExp('<msub>[^<>]*?<mi>([^<>]*?)<\/mi>[^<>]*?<msub><mtext>([^<>]*?)<\/mtext>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<\/msub>[^<>]*?<\/msub>');
      symbol = symbol.replace(subReg, '$1<sub>$2<sub>$3</sub></sub>');
      symbol = symbol.replace('<math>', '');
      symbol = symbol.replace('</math>', '');
      symbol = symbol.replace('<mrow>', '');
      symbol = symbol.replace('</mrow>', '');
      symbol = symbol.replace('<mtext>', '');
      symbol = symbol.replace('</mtext>', '');
      symbol = symbol.replace('<mi>', '');
      symbol = symbol.replace('</mi>', '');
      symbol = symbol.trim();
      return symbol;
    }
    function convertUnitSymbol(symbol) {
      symbol = symbol.replaceAll('\n', '');
      symbol = symbol.replaceAll(' ', '');
      var subReg = new RegExp('<msup>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<mn>([^<>]*?)<\/mn>[^<>]*?<\/msup>');
      symbol = symbol.replace(subReg, '$1<sup>$2</sup>');
      var subReg = new RegExp('<msup>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<\/msup>');
      symbol = symbol.replace(subReg, '$1<sup>$2</sup>');
      symbol = symbol.replaceAll('<math>', '');
      symbol = symbol.replaceAll('</math>', '');
      symbol = symbol.replaceAll('<mtext>', '');
      symbol = symbol.replaceAll('</mtext>', '');
      return symbol
    }    

    var table = null;
    var tableOriginalWidth;
    var minColumnWidth = 70;
    var tableMaxHeight = '400px';
    var symbol2parameter = {};
    symbol2parameter['c'] = 'Outlet_Concentration';
    function getElementWidth(text, minWidth) {
      $('body').append($('<span id="text-width">' + text + '</span>'));
      var width = $('#text-width')[0].getBoundingClientRect().width;
      $('#text-width').remove();
      return Math.max(width + 10, minWidth);
    }
    function loadInputSheet(modelContext, data) {
      var mode = $('#mode').val();
      var species = modelContext['basic']['species'];
      var liquidStreams = [], gaseousStreams = [];
      $.each(modelContext['information']['streams'], function(stream, streamDict) {
        if (streamDict['state'] == 'liquid') {
          liquidStreams.push(stream);
        }
        if (streamDict['state'] == 'gaseous') {
          gaseousStreams.push(stream);
        }
      });
      var catalysts = [];
      $.each(modelContext['information']['reactions'], function(reaction, reactionDict) {
        if (reactionDict['Catalyst'] && !catalysts.includes(reactionDict['Catalyst'])) {
          catalysts.push(reactionDict['Catalyst']);
        }
      });

      var phenomena = [];
      phenomena.push(modelContext['description']['accumulation']);
      phenomena.push(modelContext['description']['flow_pattern']);
      $.each(modelContext['description']['molecular_transport'], function(_, phenomenon) {
        phenomena.push(phenomenon)
      });
      $.each(modelContext['description']['reaction'], function(reaction, reactionPhenomena) {
        $.each(reactionPhenomena, function(_, phenomenon) {
          phenomena.push(phenomenon)
        });
      });
      phenomena = Array.from(new Set(phenomena));
      var operatingParameters = [];
      $.each(Object.assign({}, entity['law'], entity['definition']), function(law, lawDict) {
        if (phenomena.includes(lawDict['phenomenon'])) {
          $.each(lawDict['model_variables'], function(_, modelVariable) {
            if (entity['model_variable'][modelVariable]['class'] == 'OperatingParameter') {
              operatingParameters.push(modelVariable);
            }
          });
        }
      });
      operatingParameters = Array.from(new Set(operatingParameters));

      var tableMaxHeight = '400px';
      data = data ? data : [[]];
      var columns = [];
      var nestedHeaders = [[], []];
      $.each(operatingParameters, function(_, parameter) {
        var parameterDimensions = entity['model_variable'][parameter]['dimensions'];
        var symbol = entity['model_variable'][parameter]['symbol'];
        var unit = entity['model_variable'][parameter]['unit']
        if (unit) {
          symbol = convertParameterSymbol(symbol) + ' (' + convertUnitSymbol(entity['unit'][unit]['symbol']) + ')';
        } else {
          symbol = convertParameterSymbol(symbol);
        }
        symbol2parameter[symbol] = parameter;
        if (!parameterDimensions.includes('Stream') & !parameterDimensions.includes('Species')) {
          columns.push({'title': '-', 'width': getElementWidth(symbol, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
          nestedHeaders[0].push({'title': symbol, 'colspan': '1'});
          nestedHeaders[1].push({'title': '-', 'colspan': '1'});
        }
      });
      $.each(operatingParameters, function(_, parameter) {
        var parameterDimensions = entity['model_variable'][parameter]['dimensions'];
        var symbol = entity['model_variable'][parameter]['symbol'];
        var unit = entity['model_variable'][parameter]['unit']
        if (unit) {
          symbol = convertParameterSymbol(symbol) + ' (' + convertUnitSymbol(entity['unit'][unit]['symbol']) + ')';
        } else {
          symbol = convertParameterSymbol(symbol);
        }
        symbol2parameter[symbol] = parameter;
        if (parameterDimensions.includes('Stream') & !parameterDimensions.includes('Species')) {
          if (!parameter.includes('Gas')) {
            $.each(liquidStreams, function(_, stream) {
              columns.push({'title': '-', 'width': getElementWidth(stream, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
              nestedHeaders[1].push({'title': stream, 'colspan': '1'});
            });
            nestedHeaders[0].push({'title': symbol, 'colspan': liquidStreams.length.toString()});
          }
          if (parameter.includes('Gas')) {
            $.each(gaseousStreams, function(_, stream) {
              columns.push({'title': '-', 'width': getElementWidth(stream, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
              nestedHeaders[1].push({'title': stream, 'colspan': '1'});
            });
            nestedHeaders[0].push({'title': symbol, 'colspan': gaseousStreams.length.toString()});
          }
        }
      });
      $.each(operatingParameters, function(_, parameter) {
        var parameterDimensions = entity['model_variable'][parameter]['dimensions'];
        var symbol = entity['model_variable'][parameter]['symbol'];
        var unit = entity['model_variable'][parameter]['unit']
        if (unit) {
          symbol = convertParameterSymbol(symbol) + ' (' + convertUnitSymbol(entity['unit'][unit]['symbol']) + ')';
        } else {
          symbol = convertParameterSymbol(symbol);
        }
        symbol2parameter[symbol] = parameter;
        if (parameterDimensions.includes('Stream') & parameterDimensions.includes('Species')) {
          if (!parameter.includes('Gas')) {
            $.each(liquidStreams, function(_, stream) {
              $.each(species, function(_, s) {
                columns.push({'title': s, 'width': getElementWidth(s, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
              });
              nestedHeaders[1].push({'title': stream, 'colspan': species.length.toString()});
            });
            nestedHeaders[0].push({'title': symbol, 'colspan': (liquidStreams.length * species.length).toString()});
          }
        }
      });
      $.each(species, function(_, s) {
        columns.push({'title': s, 'width': getElementWidth(s, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
      })
      nestedHeaders[1].push({'title': 'Outlet stream', 'colspan': species.length.toString()});
      nestedHeaders[0].push({'title': 'c (mol/L)', 'colspan': species.length.toString()});
      let table = jspreadsheet(document.getElementById('input'), {
        data: data,
        csvFileName: 'data',
        columns: columns,
        columnResize: false,
        tableOverflow: true,
        allowRenameColumn: false,
        allowDeleteColumn: false,
        allowInsertColumn: false,
        nestedHeaders: nestedHeaders,
        includeHeadersOnDownload: true,
      });
      $(table.content).css('box-shadow', '');
      $(table.content).css('max-height', tableMaxHeight);
      $(table.thead).find('td').each(function(index, elem) {
        if (index > 0) {
          var symbol = $('<span>' + $(elem).text() + '</span>');
          $(elem).text(null);
          $(elem).append(symbol);
        }
      })
      tableOriginalWidth = $('#input')[0].getBoundingClientRect().width + 4;
      return table;
    }
    table = loadInputSheet(modelContext, null);

    function resizeTable() {
      if (table) {
        let cardWidth = $('#input').parent()[0].getBoundingClientRect().width;
        if (cardWidth - 100 < tableOriginalWidth) {
          table.content.style['overflow-x'] = 'auto';
          table.content.style.width = (cardWidth - 100).toString() + 'px';
        } else {
          table.content.style['overflow-x'] = null;
          table.content.style.width = tableOriginalWidth.toString() + 'px';
        }
      }
    }
    $('#pushmenu-btn').click(function() {setTimeout(resizeTable, 400);});
    $(window).resize(resizeTable);
    $(window).trigger('resize');
    $(window).resize(plotProfile);
    $(window).resize(plotStatistics);
    $(window).resize(plotParity);

    var dataText = null;
    function filterDataText(dataText) {
      var dataHeader = dataText.split('\r\n').slice(0, 3).map((x) => x.split(','));
      var tableHeader = table.copy(false, table.options.csvDelimiter, true, true, true).split('\r\n').slice(0, 3).map((x) => x.split(','));
      var columns = [];
      var preMatched = false;
      $.each(dataHeader[0], function(i, _) {
        if (preMatched && (dataHeader[0][i] == "")) {
          columns.push(i);
        } else {
          preMatched = false;
          $.each(tableHeader[0], function(j, _) {
            if ((tableHeader[0][j] == dataHeader[0][i]) && (tableHeader[1][j] == dataHeader[1][i]) && (tableHeader[2][j] == dataHeader[2][i])) {
              preMatched = true;
            }
          });
          if (preMatched) {
            columns.push(i);
          }
        }
      });
      var filterDataText = [];
      $.each(dataText.split('\r\n'), function(_, line) {
        var l = [];
        $.each(line.split(','), function(i, term) {
          if (columns.includes(i)) {
            l.push(term);
          }
        });
        l = l.join(',');
        filterDataText.push(l);
      });
      return filterDataText.join('\r\n');
    }
    function validateText(dataText) {
      var dataHeaderText = dataText.split('\r\n').slice(0, 3).join('\r\n');
      var tableHeaderText = table.copy(false, table.options.csvDelimiter, true, true, true).split('\r\n').slice(0, 3).join('\r\n');
      return dataHeaderText == tableHeaderText;
    }
    $(document).on('click', '#save-btn', function() {table.download();})
    $(document).on('change', '#local-path', function(e) {
      var file = e.target.files[0];
      var reader = new FileReader();
      reader.onload = function(e) {
        dataText = e.target.result;
      }
      reader.readAsText(file);
    })
    $(document).on('click', '#import-btn', function() {
      if ($('#import').val() == 'local') {
        if ($('#local-path')[0].files.length == 0) {
          alert('Select data path!');
        } else {
          $('#local-path').trigger('change');
          dataText = filterDataText(dataText);
          if (validateText(dataText)) {
            var lines = dataText.split('\r\n').slice(3);
            var data = lines.map(line => line.split(',').map(x => isNaN(parseFloat(x)) ? null : parseFloat(x)));
            table.setData(data);
          } else {
            alert('Table header not match!');
          }
        }
      } else {
        $.get(
          '{{ url_for("home.case_file", filepath="") }}' + $('#website-case').val(),
          function (dataText) {
            dataText = filterDataText(dataText);
            if (validateText(dataText)) {
              var lines = dataText.split('\r\n').slice(3);
              var data = lines.map(line => line.split(',').map(x => isNaN(parseFloat(x)) ? null : parseFloat(x)));
              table.setData(data);
            } else {
              alert('Table header not match!');
            }
          }
        ).fail(function(jqXHR, textStatus, errorThrown) {
          console.error('Data unavailable!');
        })
      }
    })

    var simulationResult = [];
    var previousProfilePoint = null;
    var previousStatisticsPoint = null;
    var previousParityPoint = null;
    function getData(includeOutletStream) {
      var rawData = table.getData();
      var data = [];
      $.each(rawData, function(_, line) {
        data.push($(line).map(function(_, value) {
          return value ? parseFloat(value) : value;
        }).toArray());
      });
      var tableHeader = table.copy(false, table.options.csvDelimiter, true, true, true).split('\r\n').slice(0, 2);
      tableHeader = tableHeader.map(line => line.split(','));
      tableHeader.push($(table.thead).find('tr:last td:gt(0)').map(function(index, elem) {return $(elem).attr('title');}).toArray());
      $(tableHeader[0]).each(function(i, s) {
        if (s in symbol2parameter) {
          tableHeader[0][i] = symbol2parameter[s];
        } else {
          tableHeader[0][i] = tableHeader[0][i-1];
        }
      });
      $(tableHeader[1]).each(function(i, s) {
        if (!s) {tableHeader[1][i] = tableHeader[1][i-1];}
        if (s == '-') {tableHeader[1][i] = null;}
      });
      $(tableHeader[2]).each(function(i, s) {if (s == '-') {tableHeader[2][i] = null;}});
      if (!includeOutletStream) {
        $(data).each(function(i, d) {data[i] = $.grep(d, function(e, j) {return tableHeader[1][j] != 'outlet stream'})});
        tableHeader[0]= $.grep(tableHeader[0], function(e, i) {return tableHeader[1][i] != 'outlet stream'});
        tableHeader[2]= $.grep(tableHeader[2], function(e, i) {return tableHeader[1][i] != 'outlet stream'});
        tableHeader[1]= $.grep(tableHeader[1], function(e, i) {return tableHeader[1][i] != 'outlet stream'});
      }
      var parameterKey = $(tableHeader[0]).map(function(i, e) {return Array([tableHeader[0][i], tableHeader[2][i], null, tableHeader[1][i], null])}).toArray();
      var parameterValue = data;
      return {'key': parameterKey, 'value': parameterValue};
    }
    
    function showTooltip(x, y, id, contents) {
      $('<div id="' + id + '">' + contents + '</div>').css({
        top: y,
        left: x,
      }).appendTo('body').fadeIn();
      $('#' + id).css('position', 'absolute');
      $('#' + id).css('padding', '5px');
      $('#' + id).css('border-radius', '5px');
      $('#' + id).css('background-color', 'white');
      $('#' + id).css('border', '1px solid #e1e1e1');
    }
    $('#profile').bind('plothover', function(event, pos, item) {
      if (item) {
        if (previousProfilePoint != item.dataIndex) {
          previousProfilePoint = item.dataIndex;
          $('#profile-tip').remove();
          var x = item.datapoint[0];
          var y = item.datapoint[1];
          showTooltip(item.pageX + 20, item.pageY - 16, 'profile-tip', '(' + x.toFixed(6).toString() + ', ' + y.toFixed(6).toString() + ')');
        }
      } else {
        $('#profile-tip').remove();
        previousProfilePoint = null;
      }
    });
    $('#statistics').bind('plothover', function(event, pos, item) {
      if (item) {
        if (previousStatisticsPoint != item.dataIndex) {
          previousStatisticsPoint = item.dataIndex;
          $('#statistics-tip').remove();
          var x = item.datapoint[0];
          var y = item.datapoint[1];
          showTooltip(item.pageX - 35, item.pageY - 40, 'statistics-tip', y.toFixed(6).toString());
        }
      } else {
        $('#statistics-tip').remove();
        previousStatisticsPoint = null;
      }
    });
    $('#parity').bind('plothover', function(event, pos, item) {
      if (item) {
        if (previousParityPoint != item.dataIndex) {
          previousParityPoint = item.dataIndex;
          $('#parity-tip').remove();
          var x = item.datapoint[0];
          var y = item.datapoint[1];
          var index = item.dataIndex + 1;
          showTooltip(item.pageX + 20, item.pageY - 16, 'parity-tip', 'Sample ' + index.toString() + ': (' + x.toFixed(6).toString() + ', ' + y.toFixed(6).toString() + ')');
        }
      } else {
        $('#parity-tip').remove();
        previousParityPoint = null;
      }
    });
    
    function plotProfile() {
      if (simulationResult.length == 0) {return;}
      var sampleSimulationResult = simulationResult[parseInt($('#profile-sample').val())];
      var sampleSimulationVariableIndices = $('#profile-variable').val().map(x => {return parseInt(x);});
      var plotSampleSimulationVariableData = $(sampleSimulationResult).filter(function(index, elem) {
        return sampleSimulationVariableIndices.includes(index);
      }).toArray();
      if (modelContext['description']['accumulation'] == 'Continuous') {
        var xLabel = 'x (m)';
        var lines = {show: true, lineWidth: 2};
        var points = {show: false};
        var dashes = {};
      }
      if (modelContext['description']['accumulation'] == 'Batch') {
        var showLine = true;
        var xLabel = 't (min)';
        var lines = {show: showLine, lineWidth: 2};
        var points = {show: false};
        var dashes = {};
      }
      if (modelContext['description']['accumulation'] == 'CSTR') {
        var xLabel = 'V (mL)';
        var lines = {show: false};
        var points = {show: true, radius: 5};
        var dashes = {show: true, lineWidth: 2, dashLength: 10};
      }
      if (plotSampleSimulationVariableData.length > 0) {
        var plot = $.plot('#profile',
          plotSampleSimulationVariableData, {
            series: {
              lines: lines,
              points: points,
              dashes: dashes,
            },
            grid: {
              hoverable: true,
            },
            xaxis: {
              ticks:6,
              tickDecimals: 4,
              axisLabel: xLabel,
            },
            yaxis: {
              ticks:6,
              tickDecimals: 5,
              axisLabel: 'c (mol/L)',
            },
            legend: {
              show: true,
            }
          }
        );
      } else {
        $.plot('#profile', 
          [{}], {
            xaxis: {
              ticks: 6,
              axisLabel: modelContext['description']['accumulation'] == 'Batch' ? 't (min)' : 'x (m)',
            },
            yaxis: {
              ticks: 6,
              tickDecimals: 4,
              axisLabel: 'c (mol/L)',
            },
          }
        );
      }
      var title_padding_left = $('#profile').parent().find('.flot-y-axis')[0].getBoundingClientRect().width + $('#profile').parent().find('.y1LabelLayer')[0].getBoundingClientRect().width;
      $('#profile').parent().find('.plot-title').css('padding-left', title_padding_left);
    }
    $(document).on('change', '#profile-variable', plotProfile);

    function plotStatistics() {
      if (simulationResult.length == 0) {return;}
      var sampleSimulationResult = simulationResult[parseInt($('#statistics-sample').val())];
      var sampleSimulationStatisticsInletData = [];
      var sampleSimulationStatisticsOutletData = [];
      var sampleSimulationSpeciesIndices = $('#statistics-species').val().map(x => {return parseInt(x);});
      if (sampleSimulationSpeciesIndices.length < 2) {
        var minBarWidth = 1;
      } else {
        var minBarWidth = sampleSimulationResult.length - 1;
      }
      $(sampleSimulationResult.slice(sampleSimulationResult.length - modelContext['basic']['species'].length)).each(function(index, variable) {
        if (sampleSimulationSpeciesIndices.includes(index)) {
          sampleSimulationStatisticsInletData.push([index, variable['data'][0][1]]);
          sampleSimulationStatisticsOutletData.push([index, variable['data'][variable['data'].length - 1][1]]);
          if (sampleSimulationStatisticsInletData.length > 1) {
            var len = sampleSimulationStatisticsInletData.length;
            minBarWidth = Math.min(minBarWidth, sampleSimulationStatisticsInletData[len-1][0] - sampleSimulationStatisticsInletData[len-2][0]);
          }
        }
      });
      var sampleSimulationStatisticsData = [
        {'label': 'Inlet', 'data': sampleSimulationStatisticsInletData},
        {'label': 'Outlet', 'data': sampleSimulationStatisticsOutletData},
      ];
      var xtickLabels = $(modelContext['basic']['species']).map(function(_, label) {
        label = label.replaceAll(/<\/sub>([^<>]+)</g, '</sub><tspan font-size="16">$1</tspan><');
        label = label.replaceAll(/<\/sup>([^<>]+)</g, '</sup><tspan font-size="16">$1</tspan><');
        label = label.replaceAll(/<sub>([^<>]?)<\/sub>/g, '<tspan dy="4" font-size="12">$1</tspan><tspan dy="-4" font-size="0.1"> </tspan>');
        label = label.replaceAll(/<sup>([^<>]?)<\/sup>/g, '<tspan dy="-7" font-size="12">$1</tspan><tspan dy="7" font-size="0.1"> </tspan>');
        return label;
      }).toArray();
      $.plot($('#statistics'), 
        sampleSimulationStatisticsData, {
          series: {
            bars: {show: true, barWidth: 0.6 / minBarWidth, align: 'center'},
          },
          grid: {
            hoverable: true,
          },
          xaxis: {
            autoScale: 'none',
            min: -0.6,
            max: modelContext['basic']['species'].length - 0.4,
            axisLabel: 'Species'
          },
          yaxis: {
            ticks:6,
            tickDecimals: 5,
            axisLabel: 'c (mol/L)',
          },
          legend: {
            show: true,
          }
      });
      $('#statistics').find('.flot-x-axis text').each(function(_, elem) {
        if (parseFloat($(elem).text()) % 1 == 0 && sampleSimulationSpeciesIndices.includes(parseInt($(elem).text()))) {
          var originalWidth = $(elem)[0].getBoundingClientRect().width;
          var label = '<tspan>' + xtickLabels[parseInt($(elem).text())] + '</tspan>';
          $(elem).html(label);
          var width = $(elem)[0].getBoundingClientRect().width;
          $(elem).attr('x', (parseFloat($(elem).attr('x')) + originalWidth / 2 - width / 2).toString());
        } else {
          $(elem).remove();
        }
      });
      var title_padding_left = $('#statistics').parent().find('.flot-y-axis')[0].getBoundingClientRect().width + $('#statistics').parent().find('.y1LabelLayer')[0].getBoundingClientRect().width;
      $('#statistics').parent().find('.plot-title').css('padding-left', title_padding_left);
    }
    $(document).on('change', '#statistics-species', plotStatistics);

    function plotParity() {
      if (simulationResult.length == 0) {return;}
      var speciesIndex = parseInt($('#parity-sample').val());
      var minVal = null;
      var maxVal = null;
      var simulationData = [];
      $(simulationResult).each(function(_, sampleSimulationResult) {
        var result = sampleSimulationResult.slice(sampleSimulationResult.length - modelContext['basic']['species'].length);
        if (speciesIndex && !isNaN(speciesIndex)) {
          var data = parseFloat(result[speciesIndex]['data'][result[speciesIndex]['data'].length - 1][1]);
          simulationData.push(data);
          minVal = data ? (minVal ? Math.min(minVal, data) : data) : minVal;
          maxVal = data ? (maxVal ? Math.max(maxVal, data) : data) : maxVal;
        }
      })
      var experimentData = [];
      $(table.getData()).each(function(_, sampleExperimentData) {
        var data = parseFloat(sampleExperimentData[sampleExperimentData.length - modelContext['basic']['species'].length + speciesIndex]);
        experimentData.push(data);
        minVal = data ? (minVal ? Math.min(minVal, data) : data) : minVal;
        maxVal = data ? (maxVal ? Math.max(maxVal, data) : data) : maxVal;
      })
      var gap = (maxVal - minVal) / 10;
      var leftVal = minVal - gap / 2;
      var rightVal = maxVal + gap / 2;
      minVal = minVal - gap;
      maxVal = maxVal + gap;
      var parityData = [
        {
          data: experimentData.map(function(d, i) {return [d, simulationData[i]];}), 
          points: {show: true, radius: 3, fill: true},
          lines: {show: false},
        }, {
          data: [[minVal, minVal], [maxVal, maxVal]],
          points: {show: false},
          lines: {show: true}
        }
      ];
      var rmse = 0;
      var mape = 0;
      $.each(parityData[0]['data'], function(_, d) {
        rmse = rmse + (d[0] - d[1]) ** 2;
        mape = mape + Math.abs(d[0] - d[1]) / d[0];
      })
      rmse = rmse / parityData[0]['data'].length;
      rmse = rmse ** 0.5
      mape = mape / parityData[0]['data'].length;
      console.log(rmse);
      console.log(mape);
      
      $.plot($('#parity'), 
        parityData, {
          grid: {
            hoverable: true,
          },
          xaxis: {
            ticks:6,
            tickDecimals: 4,
            axisLabel: 'Experiment c (mol/L)',
            autoScale: 'none',
            min: minVal,
            max: maxVal,
          },
          yaxis: {
            ticks:6,
            tickDecimals: 5,
            axisLabel: 'Simulation c (mol/L)',
            autoScale: 'none',
            min: minVal,
            max: maxVal,
          },
        }
      );
      var title_padding_left = $('#parity').parent().find('.flot-y-axis')[0].getBoundingClientRect().width + $('#parity').parent().find('.y1LabelLayer')[0].getBoundingClientRect().width;
      $('#parity').parent().find('.plot-title').css('padding-left', title_padding_left);
    }
    $(document).on('change', '#parity-sample', plotParity);

    $(document).on('click', '.select2', function() {
      $('.select2-container--open').find('li').each(function(_, li) {
        if ($(li).find('span').length == 0) {
          var text = '<span>' + $(li).text() + '</span>';
          $(li).html(null);
          $(li).append($(text));
        }
      })
    });

    $(document).on('click', '.select2-selection__choice__remove', function() {
      $('.select2-container--open').find('li').each(function(_, li) {
        if ($(li).find('span').length == 0) {
          var text = '<span>' + $(li).text() + '</span>';
          $(li).html(null);
          $(li).append($(text));
        }
      })
    });

    function initParamterSelect() {
      var parameters = [];
      var parameterSymbols = [];
      $.each(modelContext['information']['molecular_transport'], function(parameter, value) {
        if (parameter in entity['model_variable']) {
          if (!parameters.includes(parameter)) {
            var symbol = entity['model_variable'][parameter]['symbol'];
            var parameterSymbol = parameter.replaceAll('_', ' ') + '&nbsp;' + symbol;
            parameters.push(parameter);
            parameterSymbols.push(parameterSymbol);
          }
        }
      });
      $.each(modelContext['information']['reactions'], function(reaction, parameterValueDict) {
        $.each(parameterValueDict, function(parameter, value) {
          if (parameter in entity['model_variable']) {
            if (!parameters.includes(parameter)) {
              var symbol = entity['model_variable'][parameter]['symbol'];
              var parameterSymbol = parameter.replaceAll('_', ' ') + '&nbsp;' + symbol;
              parameters.push(parameter);
              parameterSymbols.push(parameterSymbol);
            }
          }
        });
      });
      var parameterData = [];
      $.each($(parameters), function(index, parameter) {
        parameterData.push({id: parameter, text: parameterSymbols[index]});
      });
      var parentElem = $('#parameter').parent();
      $('#parameter').remove();
      var select = $('<select></select>')
      $(select).addClass('select2');
      $(select).attr('id', 'parameter');
      $(select).attr('multiple', 'multiple');
      $(select).attr('style', 'width: 600px;');
      $(select).attr('data-placeholder', 'Select parameters');
      $(select).select2({data: parameterData});
      parentElem.append(select);
      $('#parameter').select2();
      $('#parameter').trigger('change');

      $(document).on('change', '#parameter', function() {
        $(this).next().find('.select2-selection__choice').each(function(_, li) {
          if ($(li).find('span').length == 1) {
            var remove = $(li).children()[0];
            var text = '<span>' + $(li).text().slice(1) + '</span>';
            $(li).html(null);
            $(li).append($(remove));
            $(li).append($(text));
          }
        })
      });

      $(document).on('change', '#parameter', function() {
        var selectedParameters = $('#parameter').val();
        if (selectedParameters.length > 0) {
          var selectedParameterSymbols = $(selectedParameters).map(function(_, parameter) {
            return parameter.replaceAll('_', ' ') + '&nbsp;' + convertParameterSymbol(entity['model_variable'][parameter]['symbol']);
          }).toArray().join(',&nbsp;');
          $('#parameter').next().find('.filter-option-inner-inner').html(selectedParameterSymbols);
        } else {
          $('#parameter').next().find('.filter-option-inner-inner').text('Select parameters');
        }
      });
    }
    setTimeout(function() {initParamterSelect()}, 100);

    function createParameterForm() {
      const eqSet = (xs, ys) => xs.size === ys.size && [...xs].every((x) => ys.has(x));
      $('#parameter-form').find('.parameter-line').remove();
      var parameters = $('#parameter').val();
      if (parameters.length == 0) {
        $('#parameter-header').css('display', 'none');
      } else {
        $('#parameter-header').css('display', 'flex');
      }
      $(parameters).each(function(_, parameter) {
        var parameterDimensionSet = new Set(entity['model_variable'][parameter]['dimensions']);
        if (eqSet(parameterDimensionSet, new Set([]))) {
          var parameterLine = $('#parameter-line-template').clone();
          $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(0)').text(parameter.replaceAll('_', ' '));
          $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(1)').html(entity['model_variable'][parameter]['symbol']);
          if (entity['model_variable'][parameter]['unit']) {
            $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(2)').html(entity['unit'][entity['model_variable'][parameter]['unit']]['symbol']);
          }
          $(parameterLine).removeAttr('id');
          $(parameterLine).addClass('parameter-line');
          $(parameterLine).css('display', 'flex');
          var initValue = parseFloat(modelContext['information']['molecular_transport'][parameter]);
          if (initValue) {$(parameterLine).find('input:eq(0)').val(initValue);}
          $('#parameter-form').append(parameterLine);
        }
        if (eqSet(parameterDimensionSet, new Set(['Reaction', 'Solvent']))) {
          $(modelContext['basic']['reactions']).each(function(_, reaction) {
            $(modelContext['basic']['solvents']).each(function(_, solvent) {
              if ((parameter in modelContext['information']['reactions'][reaction]) && (solvent in modelContext['information']['reactions'][reaction][parameter])) {
                var parameterLine = $('#parameter-line-template').clone();
                $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(0)').text(parameter.replaceAll('_', ' '));
                $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(1)').html(entity['model_variable'][parameter]['symbol']);
                if (entity['model_variable'][parameter]['unit']) {
                  $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(2)').html(entity['unit'][entity['model_variable'][parameter]['unit']]['symbol']);
                }
                $(parameterLine).find('.parameter-line-reaction').children(':eq(0)').html(reaction);
                $(parameterLine).find('.parameter-line-solvent').children(':eq(0)').text(solvent);
                $(parameterLine).removeAttr('id');
                $(parameterLine).addClass('parameter-line');
                $(parameterLine).css('display', 'flex');
                var initValue = parseFloat(modelContext['information']['reactions'][reaction][parameter][solvent]);
                if (initValue) {$(parameterLine).find('input:eq(0)').val(initValue);}
                $('#parameter-form').append(parameterLine);
              }
            });
          });
        }
        if (eqSet(parameterDimensionSet, new Set(['Reaction', 'Species']))) {
          $(modelContext['basic']['reactions']).each(function(_, reaction) {
            $(modelContext['basic']['species']).each(function(_, species) {
              if ((parameter in modelContext['information']['reactions'][reaction]) && (species in modelContext['information']['reactions'][reaction][parameter])) {
                var parameterLine = $('#parameter-line-template').clone();
                $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(0)').text(parameter.replaceAll('_', ' '));
                $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(1)').html(entity['model_variable'][parameter]['symbol']);
                if (entity['model_variable'][parameter]['unit']) {
                  $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(2)').html(entity['unit'][entity['model_variable'][parameter]['unit']]['symbol']);
                }
                $(parameterLine).find('.parameter-line-reaction').children(':eq(0)').html(reaction);
                $(parameterLine).find('.parameter-line-species').children(':eq(0)').html(species);
                $(parameterLine).removeAttr('id');
                $(parameterLine).addClass('parameter-line');
                $(parameterLine).css('display', 'flex');
                var initValue = parseFloat(modelContext['information']['reactions'][reaction][parameter][species]);
                if (initValue) {$(parameterLine).find('input:eq(0)').val(initValue);}
                $('#parameter-form').append(parameterLine);
              }
            });
          });
        }
      });
      $('#mode').trigger('change');
    }
    $(document).on('change', '#parameter', createParameterForm);

    function filterFormByMode() {
      if ($('#mode').val() == 'simulation') {
        $('.init').css('display', 'none');
        $('.min').css('display', 'none');
        $('.max').css('display', 'none');
        $('#init-header').css('display', 'none');
        $('#min-header').css('display', 'none');
        $('#max-header').css('display', 'none');
        $('#value-header').html('<b>value</b>');
        $('.parameter-line').each(function(_, line) {
          if (!$(line).find('.value').val()) {
            $(line).find('.value').val($(line).find('.init').val());
          }
        });
      }
      if ($('#mode').val() == 'calibration') {
        $('.init').css('display', 'initial');
        $('.min').css('display', 'initial');
        $('.max').css('display', 'initial');
        $('#init-header').css('display', 'initial');
        $('#min-header').css('display', 'initial');
        $('#max-header').css('display', 'initial');
        $('#value-header').html('<b>calibrated value</b>');
        $('.parameter-line').each(function(_, line) {
          $(line).find('.value').val(null);
        });
      }
    }
    $(document).on('change', '#mode', filterFormByMode);
  
    function getParameter() {
      var parameterDict = {'key': [], 'init': [], 'min': [], 'max': [], 'value': []};
      $('.parameter-line').map(function(_, line) {
        var parameter = $(line).find('.parameter-line-name-symbol-unit').children(':eq(0)').text().replaceAll(' ', '_').trim();
        var species = $(line).find('.parameter-line-species').children(':eq(0)').html().trim();
        var reaction = $(line).find('.parameter-line-reaction').children(':eq(0)').html().trim().replaceAll('&gt;', '>');
        var solvent = $(line).find('.parameter-line-solvent').children(':eq(0)').text().trim();
        species = species ? species : null;
        reaction = reaction ? reaction : null;
        solvent = solvent ? solvent : null;
        var init = parseFloat($(line).find('.init').val());
        var min = parseFloat($(line).find('.min').val());
        var max = parseFloat($(line).find('.max').val());
        var value = parseFloat($(line).find('.value').val());
        parameterDict['key'].push([parameter, species, reaction, null, solvent]);
        parameterDict['init'].push(init);
        parameterDict['min'].push(min);
        parameterDict['max'].push(max);
        parameterDict['value'].push(value);
      });
      return parameterDict;
    }

    function modelSimulation() {
      var data = getData(false);
      var parameter = getParameter();
      var simulationRequest = {
        'task': 'simulation',
        'data': data,
        'parameter': parameter,
        'model_type': $('#model-type').val(),
        'model_context': modelContext,
      }
      var simulationRequestJson = JSON.stringify(simulationRequest);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.model_simulation") }}', false);
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          simulationResult = JSON.parse(xhr.response);
          $('#plot').css('display', 'flex');
          
          // concentration profile
          $('#profile-sample').children().remove();
          $.each(simulationResult, function(index, elem) {
            if (index == 0) {
              $('#profile-sample').append($('<option value=' + index.toString() + ' selected>' + 'Sample ' + (index + 1).toString() + '</option>'))
            } else {
              $('#profile-sample').append($('<option value=' + index.toString() + '>' + 'Sample ' + (index + 1).toString() + '</option>'))
            }
          })
          $('#profile-sample').selectpicker('refresh').trigger('change');
          
          $(document).on('change', '#profile-sample', function() {
            var variableVal = $('#profile-variable').val();
            var variableData = [];
            var sampleSimulationResult = simulationResult[parseInt($('#profile-sample').val())]
            $.each($(sampleSimulationResult), function(index, elem) {
              variableData.push({id: index, text: elem['label']});
            });
            var parentElem = $('#profile-variable').parent();
            $('#profile-variable').remove();
            var select = $('<select></select>')
            $(select).addClass('select2');
            $(select).attr('id', 'profile-variable');
            $(select).attr('multiple', 'multiple');
            $(select).attr('style', 'width: 100%;');
            $(select).attr('data-placeholder', 'Select variables');
            $(select).select2({data: variableData});
            parentElem.append(select);
            $('#profile-variable').select2();
            $(document).on('change', '#profile-variable', function() {
              $(this).next().find('.select2-selection__choice').each(function(_, li) {
                if ($(li).find('span').length == 1) {
                  var remove = $(li).children()[0];
                  var text = '<span>' + $(li).text().slice(1) + '</span>';
                  $(li).html(null);
                  $(li).append($(remove));
                  $(li).append($(text));
                }
              })
            });
            $('#profile-variable').val(variableVal).trigger('change');
          })
          $('#profile-sample').trigger('change');

          // inlet-outlet concentration statistics
          $('#statistics-sample').children().remove();
          $.each(simulationResult, function(index, elem) {
            if (index == 0) {
              $('#statistics-sample').append($('<option value=' + index.toString() + ' selected>' + 'Sample ' + (index + 1).toString() + '</option>'))
            } else {
              $('#statistics-sample').append($('<option value=' + index.toString() + '>' + 'Sample ' + (index + 1).toString() + '</option>'))
            }
          })
          $('#statistics-sample').selectpicker('refresh').trigger('change');

          $(document).on('change', '#statistics-sample', function() {
            var speciesVal = $('#statistics-species').val();
            var speciesData = [];
            var sampleSimulationResult = simulationResult[parseInt($('#statistics-sample').val())]
            $.each($(modelContext['basic']['species']), function(index, elem) {
              speciesData.push({id: index, text: elem});
            });
            var parentElem = $('#statistics-species').parent();
            $('#statistics-species').remove();
            var select = $('<select></select>')
            $(select).addClass('select2');
            $(select).attr('id', 'statistics-species');
            $(select).attr('multiple', 'multiple');
            $(select).attr('style', 'width: 100%;');
            $(select).attr('data-placeholder', 'Select species');
            $(select).select2({data: speciesData});
            parentElem.append(select);
            $('#statistics-species').select2();
            $(document).on('change', '#statistics-species', function() {
              $(this).next().find('.select2-selection__choice').each(function(_, li) {
                if ($(li).find('span').length == 1) {
                  var remove = $(li).children()[0];
                  var text = '<span>' + $(li).text().slice(1) + '</span>';
                  $(li).html(null);
                  $(li).append($(remove));
                  $(li).append($(text));
                }
              })
            });
            $('#statistics-species').val(speciesVal).trigger('change');
          })
          $('#statistics-sample').trigger('change');
          $('#statistics-species').val(Array.from({length: modelContext['basic']['species'].length}, (_, i) => i.toString())).trigger('change');

          // simulation vs. experiment
          $('#parity-sample').children().remove();
          $.each($(modelContext['basic']['species']), function(index, elem) {
            $('#parity-sample').append($('<option value=' + index.toString() + '>' + elem + '</option>'))
          })
          $('#parity-sample').selectpicker('refresh').trigger('change');
          $('#parity-sample').next().find('.filter-option-inner-inner').text('Nothing selected');
          setTimeout(function() {
            $('#parity-sample').next().next().find('li a').each(function(index, elem) {
              $(elem).find('span').html(modelContext['basic']['species'][index]);
            })
          }, 100);
          $(document).on('change', '#parity-sample', function() {
            var sampleSimulationSpeciesIndex = $('#parity-sample').val();
            if (sampleSimulationSpeciesIndex) {
              var sampleSimulationSpeciesSymbol = modelContext['basic']['species'][sampleSimulationSpeciesIndex];
              $('#parity-sample').next().find('.filter-option-inner-inner').html(sampleSimulationSpeciesSymbol);
            } else {
              $('#parity-sample').next().find('.filter-option-inner-inner').text('Nothing selected');
            }
          })
          $('#parity-sample').selectpicker('refresh').trigger('change');
        } else {
          $('#simulation').children('div').css('display', 'none');
        }
      };
      xhr.send(simulationRequestJson);
    }
    
    function modelCalibration() {
      var data = getData(true);
      var parameter = getParameter();
      var calibrationRequest = {
        'task': 'calibration',
        'data': data,
        'parameter': parameter,
        'model_type': $('#model-type').val(),
        'model_context': modelContext,
      }
      var calibrationRequestJson = JSON.stringify(calibrationRequest);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.model_calibration") }}', true);
      xhr.timeout = 120000; // timeout in 2 minutes
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var calibrationResult = JSON.parse(xhr.response);
          simulationResult = calibrationResult['simulation'];
          $('.parameter-line .value').each(function(index, elem) {
            var value = calibrationResult['parameter']['value'][index].toFixed(6);
            if (value == 0) {
              $(elem).val(calibrationResult['parameter']['value'][index].toExponential(4));
            } else {
              $(elem).val(calibrationResult['parameter']['value'][index].toFixed(6));
            }
          });
          
          $('#plot').css('display', 'flex');
          $('#profile-sample').children().remove();
          $.each(simulationResult, function(index, elem) {
            if (index == 0) {
              $('#profile-sample').append($('<option value=' + index.toString() + ' selected>' + 'Sample ' + (index + 1).toString() + '</option>'))
            } else {
              $('#profile-sample').append($('<option value=' + index.toString() + '>' + 'Sample ' + (index + 1).toString() + '</option>'))
            }
          })
          $('#profile-sample').selectpicker('refresh').trigger('change');
          
          // concentration profile
          $(document).on('change', '#profile-sample', function() {
            var variableVal = $('#profile-variable').val();
            var variableData = [];
            var sampleSimulationResult = simulationResult[parseInt($('#profile-sample').val())]
            $.each($(sampleSimulationResult), function(index, elem) {
              variableData.push({id: index, text: elem['label']});
            });
            var parentElem = $('#profile-variable').parent();
            $('#profile-variable').remove();
            var select = $('<select></select>')
            $(select).addClass('select2');
            $(select).attr('id', 'profile-variable');
            $(select).attr('multiple', 'multiple');
            $(select).attr('style', 'width: 100%;');
            $(select).attr('data-placeholder', 'Select variables');
            $(select).select2({data: variableData});
            parentElem.append(select);
            $('#profile-variable').select2();
            $(document).on('change', '#profile-variable', function() {
              $(this).next().find('.select2-selection__choice').each(function(_, li) {
                if ($(li).find('span').length == 1) {
                  var remove = $(li).children()[0];
                  var text = '<span>' + $(li).text().slice(1) + '</span>';
                  $(li).html(null);
                  $(li).append($(remove));
                  $(li).append($(text));
                }
              })
            });
            $('#profile-variable').val(variableVal).trigger('change');
          })
          $('#profile-sample').trigger('change');

          // inlet-outlet concentration statistics
          $('#statistics-sample').children().remove();
          $.each(simulationResult, function(index, elem) {
            if (index == 0) {
              $('#statistics-sample').append($('<option value=' + index.toString() + ' selected>' + 'Sample ' + (index + 1).toString() + '</option>'))
            } else {
              $('#statistics-sample').append($('<option value=' + index.toString() + '>' + 'Sample ' + (index + 1).toString() + '</option>'))
            }
          })
          $('#statistics-sample').selectpicker('refresh').trigger('change');

          $(document).on('change', '#statistics-sample', function() {
            var speciesVal = $('#statistics-species').val();
            var speciesData = [];
            var sampleSimulationResult = simulationResult[parseInt($('#statistics-sample').val())]
            $.each($(modelContext['basic']['species']), function(index, elem) {
              speciesData.push({id: index, text: elem});
            });
            var parentElem = $('#statistics-species').parent();
            $('#statistics-species').remove();
            var select = $('<select></select>')
            $(select).addClass('select2');
            $(select).attr('id', 'statistics-species');
            $(select).attr('multiple', 'multiple');
            $(select).attr('style', 'width: 100%;');
            $(select).attr('data-placeholder', 'Select species');
            $(select).select2({data: speciesData});
            parentElem.append(select);
            $('#statistics-species').select2();
            $(document).on('change', '#statistics-species', function() {
              $(this).next().find('.select2-selection__choice').each(function(_, li) {
                if ($(li).find('span').length == 1) {
                  var remove = $(li).children()[0];
                  var text = '<span>' + $(li).text().slice(1) + '</span>';
                  $(li).html(null);
                  $(li).append($(remove));
                  $(li).append($(text));
                }
              })
            });
            $('#statistics-species').val(speciesVal).trigger('change');
          })
          $('#statistics-sample').trigger('change');
          $('#statistics-species').val(Array.from({length: modelContext['basic']['species'].length}, (_, i) => i.toString())).trigger('change');

          // simulation vs. experiment
          $('#parity-sample').children().remove();
          $.each($(modelContext['basic']['species']), function(index, elem) {
            $('#parity-sample').append($('<option value=' + index.toString() + '>' + elem + '</option>'))
          })
          $('#parity-sample').selectpicker('refresh').trigger('change');
          $('#parity-sample').next().find('.filter-option-inner-inner').text('Nothing selected');
          setTimeout(function() {
            $('#parity-sample').next().next().find('li a').each(function(index, elem) {
              $(elem).find('span').html(modelContext['basic']['species'][index]);
            })
          }, 100);
          $(document).on('change', '#parity-sample', function() {
            var sampleSimulationSpeciesIndex = $('#parity-sample').val();
            if (sampleSimulationSpeciesIndex) {
              var sampleSimulationSpeciesSymbol = modelContext['basic']['species'][sampleSimulationSpeciesIndex];
              $('#parity-sample').next().find('.filter-option-inner-inner').html(sampleSimulationSpeciesSymbol);
            } else {
              $('#parity-sample').next().find('.filter-option-inner-inner').text('Nothing selected');
            }
          })
          $('#parity-sample').selectpicker('refresh').trigger('change');


          $('input').attr('disabled', false);
          $('select').attr('disabled', false);
          $('button').attr('disabled', false);
        } else {
          $('input').attr('disabled', false);
          $('select').attr('disabled', false);
          $('button').attr('disabled', false);
        }
      };
      $('input').attr('disabled', true);
      $('select').attr('disabled', true);
      $('button').attr('disabled', true);
      xhr.send(calibrationRequestJson);
    }
  
    $(document).on('click', '#run-btn', function() {
      if ($('#mode').val() == 'simulation') {
        modelSimulation();
      }
      if ($('#mode').val() == 'calibration') {
        if ($('#parameter').val().length == 0) {
          alert('No parameter selected for calibration!');
        } else {
          modelCalibration();
        }
      }
    });
    setTimeout(function() {$('#mode').trigger('change');}, 100);
    setTimeout(function() {$('#parameter').trigger('change');}, 100);
  </script>

{% endblock javascripts %}
