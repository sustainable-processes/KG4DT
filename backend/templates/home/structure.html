{% extends "layouts/base.html" %}

{% block title %} KG4DT {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} sidebar-mini sidebar-collapse {% endblock body_class %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/fontawesome-free/css/all.min.css') }}">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/select2/css/select2.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.css') }}">
  <!-- TagsInput -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/bootstrap4-tagsinput/tagsinput.css') }}">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css') }}">
  <!-- Bootstrap-select -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/bootstrap-select/dist/css/bootstrap-select.css') }}">
  <!-- iCheck -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css') }}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/jqvmap/jqvmap.min.css') }}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/adminlte.min.css') }}">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/overlayScrollbars/css/OverlayScrollbars.min.css') }}">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/daterangepicker/daterangepicker.css') }}">
  <!-- summernote -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/summernote/summernote-bs4.min.css') }}">

{% endblock stylesheets %}

{% block content %}
  
  <div class="content-wrapper">

    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="row ml-1">
          <div class="col-sm-6">
            <h1 class="text-dark">KG4DT</h1>
          </div>
          <div class="col-sm-6">
            <div class="float-sm-right mr-2" style="display: flex">
            </div>
          </div>
        </div>
    </div>
    <!-- /.content-header -->

    <section class="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-body">
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Species</b>
                <!-- : used as species identifier, name or formula, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="species"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Reaction</b>
                <!-- : reaction formula, A + 2 B > 3 C, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="reaction"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Stream</b>
                <!-- : used as stream identifier, stream 1, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="stream"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Solvent</b>
                <!-- : used as solvent identifier, water, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="solvent"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Catalyst</b>
                <!-- : used as catalyst identifier, Enzyme, e.g. -->
              </a>
              <input data-role="tagsinput" maxTags=1 id="catalyst"></input>
            </div>
          </div>
        </div>

        <div id="chart-card-template" class="card card-primary" style="display: none;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h3 class="card-title">
              <span class="target-parameter"></span>
              <span>&nbsp;&nbsp;</span>
            </h3>
          </div>
          <div class="card-body" style="padding-top: 0.1rem; padding-bottom: 0.5rem;">
            <div style="padding-bottom: 0.2rem;">
              <span><b>Phenomenon:&nbsp;</b></span>
              <span class="phenomenon" style="text-align: center; font-size: 16px;"></span>
            </div>
            <div style="padding-bottom: 0.2rem;">
              <span><b>Reference:&nbsp;</b></span>
              <a class="doi" style="text-align: center; font-size: 15px;"></a>
            </div>
            <div style="padding-bottom: 0.4rem;">
              <span><b>Parameter:&nbsp;&nbsp;</b></span>
              <span class="parameter" style="text-align: center;"></span>
            </div>
            <a class="formula" data-toggle="collapse" href="#chart-template-detail-formula">
              <span>
                <span style="color: black;"><b>Formula:&nbsp;&nbsp;</b></span>
                <span class="concise-formula" style="text-align: center; font-size: 14px; color: black;"></span>
              </span>
              <div class="collapse detail-formula ml-4" style="font-size: 14px; margin-top: 0.5rem;">
              </div>
            </a>
          </div>
        </div>

        <div class="row" style="padding-right: 4%;">
          <div id="model-layer-0" class="col-md-4" style="padding-right: 4%; display: flex; flex-direction: column; justify-content: center;">
          </div>
          <div id="model-layer-1" class="col-md-4" style="padding-left: 2%; padding-right: 2%; display: flex; flex-direction: column; justify-content: center;">
          </div>
          <div id="model-layer-2" class="col-md-4" style="padding-left: 4%; display: flex; flex-direction: column; justify-content: center;">
          </div>
        </div>
      </div>
    </section>
  </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- jQuery -->
  <script src="{{ url_for('static', filename='assets/plugins/jquery/jquery.min.js') }}"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="{{ url_for('static', filename='assets/plugins/jquery-ui/jquery-ui.min.js') }}"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
  <!-- Bootstrap-select -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap-select/dist/js/bootstrap-select.min.js') }}"></script>
  <!-- Select2 -->
  <script src="{{ url_for('static', filename='assets/plugins/select2/js/select2.full.min.js') }}"></script>
  <!-- TagsInput -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap4-tagsinput/tagsinput.js') }}"></script>
  <!-- Bootstrap4 Duallistbox -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js') }}"></script>
  <!-- InputMask -->
  <script src="{{ url_for('static', filename='assets/plugins/moment/moment.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/inputmask/jquery.inputmask.min.js') }}"></script>
  <!-- date-range-picker -->
  <script src="{{ url_for('static', filename='assets/plugins/daterangepicker/daterangepicker.js') }}"></script>
  <!-- bootstrap color picker -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js') }}"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="{{ url_for('static', filename='assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js') }}"></script>
  <!-- Bootstrap Switch -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap-switch/js/bootstrap-switch.min.js') }}"></script>
  <!-- ChartJS -->
  <script src="{{ url_for('static', filename='assets/plugins/chart.js/Chart.min.js') }}"></script>
  <!-- Sparkline -->
  <script src="{{ url_for('static', filename='assets/plugins/sparklines/sparkline.js') }}"></script>
  <!-- JQVMap -->
  <script src="{{ url_for('static', filename='assets/plugins/jqvmap/jquery.vmap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/jqvmap/maps/jquery.vmap.usa.js') }}"></script>
  <!-- jQuery Knob Chart -->
  <script src="{{ url_for('static', filename='assets/plugins/jquery-knob/jquery.knob.min.js') }}"></script>
  <!-- daterangepicker -->
  <script src="{{ url_for('static', filename='assets/plugins/moment/moment.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/daterangepicker/daterangepicker.js') }}"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="{{ url_for('static', filename='assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js') }}"></script>
  <!-- Summernote -->
  <script src="{{ url_for('static', filename='assets/plugins/summernote/summernote-bs4.min.js') }}"></script>
  <!-- overlayScrollbars -->
  <script src="{{ url_for('static', filename='assets/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js') }}"></script>
  <!-- leader-line -->
  <script src="{{ url_for('static', filename='assets/plugins/leader-line/leader-line.min.js') }}"></script>
  <!-- AdminLTE App -->
  <script src="{{ url_for('static', filename='assets/js/adminlte.js') }}"></script>

  <script type="text/javascript">{{ entity_json | safe }}</script>
  <script type="text/javascript">{{ model_context_json | safe }}</script>

  <script>
    if (sessionStorage.getItem('modelContext')) {
      var modelContext = JSON.parse(sessionStorage.getItem('modelContext'));
      loadModelContext(modelContext);
    };

    $(document).on('click', '.top-down-rule-link', function() {
      sessionStorage.removeItem('modelContext');
    });

    $(document).on('click', '.top-down-exploration-link', function() {
      sessionStorage.removeItem('modelContext');
    });
    
    $('.select2').select2()

    function speciesValid() {
      var species = $('#species').val().split(',');
      $('#species').prev().children().each(function(index, elem) {
        var symbol = document.createElement('a');
        var span = document.createElement('span');
        symbol.innerHTML = species[index];
        span.setAttribute('data-role', 'remove');
        $(elem).empty().append(symbol).append(span);
      })
    }
    $(document).on('change', '#species', speciesValid);

    function reactionValid() {
      var species = $('#species').val().split(',');
      var reactions = $('#reaction').val().split(',');
      var reactionVal = [];
      var re = new RegExp("^((\\d+ )?.+ \\+ )*(\\d+ )?.+ > ((\\d+ )?.+ \\+ )*(\\d+ )?.+$");
      var reNum = new RegExp("^\\d+$");
      $('#reaction').prev().children().each(function(index, elem) {
        var reaction = reactions[index];
        if (re.test(reaction)) {
          var lhs_species = $.map(reaction.split(' > ')[0].split(' + '), function(s, i) {
            if (reNum.test(s.split(' ')[0])) {
              return s.split(' ').slice(1).join(' ');
            } else {
              return s;
            }
          });
          var rhs_species = $.map(reaction.split(' > ')[1].split(' + '), function(s, i) {
            if (reNum.test(s.split(' ')[0])) {
              return s.split(' ').slice(1).join(' ');
            } else {
              return s;
            }
          });
          var reaction_species = $.merge(lhs_species, rhs_species);
          if (reaction_species.every(function(s) {return species.includes(s);})) {
            var formula = document.createElement('a');
            var span = document.createElement('span');
            formula.innerHTML = reaction;
            span.setAttribute('data-role', 'remove');
            $(elem).empty().append(formula).append(span);
            reactionVal.push(reaction);
          } else {
            $('#reaction').prev().remove(elem);
          }
        }
      })
      $('#reaction').val(reactionVal.join(','));
    }
    $(document).on('change', '#reaction', reactionValid)

    function catalystValid() {
      var catalysts = $('#catalyst').val().split(',');
      if (catalysts.length > 1) {
        $('#catalyst').val(catalysts[0]).trigger('change');
        $('#catalyst').prev().children('span').each(function(index, elem) {
          if (index > 0) {
            $(elem).remove();
          }
        });
      } else {
        $('#catalyst').prev().children().each(function(index, elem) {
          var symbol = document.createElement('a');
          var span = document.createElement('span');
          symbol.innerHTML = catalysts[index];
          span.setAttribute('data-role', 'remove');
          $(elem).empty().append(symbol).append(span);
        });
      }
    }
    $(document).on('change', '#catalyst', catalystValid);

    function loadModelContext(modelContext) {
      $('#species').val(modelContext['basic']['species']);
      $('#reaction').val(modelContext['basic']['reactions']);
      $('#stream').val(modelContext['basic']['streams']);
      $('#solvent').val(modelContext['basic']['solvents']);
      $('#catalyst').val(modelContext['basic']['catalysts']);
      $('#species').prop('disabled', true);
      $('#reaction').prop('disabled', true);
      $('#stream').prop('disabled', true);
      $('#solvent').prop('disabled', true);
      $('#catalyst').prop('disabled', true);
    }

    var cards = [];
    var lines = [];

    function loadFlowchartCard(flowchart) {
      var colors = ['rgb(11, 118, 160)', 'rgb(88, 186, 224)', 'rgb(166, 202, 236)']
      var reactionIndex = 0;
      $(flowchart['chart']).each(function(index, charts) {
        var div = $('#model-layer-' + index.toString());
        $(charts).each(function(_, chart) {
          var chartCard = $('#chart-card-template').clone();
          var phenomenon = chart['phenomena'].join(', ').replaceAll('_', ' ');
          var doi = 'doi' in chart ? chart['doi'] : null;
          var detailFormulaId = chart['target_parameter'].replaceAll('_', '-').toLowerCase() + '-detail-formula';
          if ('reaction' in chart) {
            detailFormulaId = detailFormulaId + '-' + reactionIndex.toString();
            reactionIndex = reactionIndex + 1;
          }
          chartCard.css('display', 'flex');
          chartCard.attr('id', 'chart-card-' + chart['target_parameter'].replaceAll('_', '-').toLowerCase());
          $(chartCard).find('.card-header').css('background-color', colors[index]);
          $(chartCard).find('.detail-formula').attr('id', detailFormulaId);
          $(chartCard).find('.detail-formula').parent().attr('href', '#' + detailFormulaId);
          $(chartCard).find('.target-parameter').text(chart['target_parameter'].replaceAll('_', ' '));
          $(chartCard).find('.phenomenon').text(phenomenon);
          if (doi) {
            $(chartCard).find('.doi').text(doi);
            $(chartCard).find('.doi').attr('href', 'https://doi.org/' + doi);
          } else {
            $(chartCard).find('.doi').parent().css('display', 'none');
          }
          $(chartCard).find('.card-title').append($(chart['target_symbol']));
          $(chartCard).find('.parameter').append($(chart['symbols'].join(', ')));
          $(chartCard).find('.concise-formula').append($(chart['formula']['concise_formula']));
          $(chartCard).find('.detail-formula').append($(chart['formula']['detail_formula']));
          if (!chart['formula']['detail_formula']) {
            $(chartCard).find('.detail-formula').remove();
          }
          if ('reaction' in chart) {
            $(chartCard).find('.card-title').append($('<span>&nbsp;&nbsp;&nbsp;</span>'));
            $(chartCard).find('.card-title').append($('<span>(' + chart['reaction'] + ')</span>'));
          }
          if (!phenomenon) {
            $(chartCard).find('.phenomenon').parent().remove();
          }
          if (phenomenon == 'Instantaneous') {
            $(chartCard).find('.parameter').parent().remove();
            $(chartCard).find('.concise-formula').parent().parent().remove();
          }
          div.append(chartCard);
          cards.push(chartCard);
        });
      });
    }

    function loadFlowchartLine(flowchart) {
      $(document).ready(function() {
        $(flowchart['link']).each(function(index, link) {
          var l_pos = link[0];
          var r_pos = link[1];
          var l_elem = $('#model-layer-' + l_pos[0].toString()).children(':eq(' + l_pos[1].toString() + ')')[0];
          var r_elem = $('#model-layer-' + r_pos[0].toString()).children(':eq(' + r_pos[1].toString() + ')')[0];
          var line = new LeaderLine(l_elem, r_elem);
          line.size = 3;
          line.path = 'fluid';
          line.startSocketGravity = 30;
          line.endSocketGravity = 70;
          if (l_pos[0] < r_pos[0]) {
            line.setOptions({startSocket: 'right', endSocket: 'left', endPlugSize: 1.25});
          } else if (l_pos[0] > r_pos[0]) {
            line.setOptions({startSocket: 'left', endSocket: 'right', endPlugSize: 1.25});
            line.startSocketGravity = 130;
            line.endSocketGravity = 70;
          } else {
            line.setOptions({startSocket: 'right', endSocket: 'right', endPlugSize: 1.25});
          }
          lines.push(line);
        });
      });
    }

    function addEventListenerFlowchartLine(flowchart) {
      $('#pushmenu-btn')[0].addEventListener('click', function() {
        $(lines).each(function(_, line) {line.remove();});
        lines = [];
        setTimeout(function() {
          loadFlowchartLine(flowchart);
        }, 400);
      });
      $('.formula').each(function(_, formula) {
        $(formula)[0].addEventListener('click', function() {
          $(lines).each(function(_, line) {line.remove();});
          lines = [];
          setTimeout(function() {
            loadFlowchartLine(flowchart);
          }, 400);
        });
      });
    }

    function getFlowchart(modelContextJson) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.model_structure") }}', false);
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var flowchart = JSON.parse(xhr.response);
          loadFlowchartCard(flowchart);
          loadFlowchartLine(flowchart);
          addEventListenerFlowchartLine(flowchart);
        }
      };
      xhr.send(modelContextJson);
    }
    getFlowchart(JSON.stringify(modelContext));
  </script>

{% endblock javascripts %}
