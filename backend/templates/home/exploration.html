{% extends "layouts/base.html" %}

{% block title %} KG4DT {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} sidebar-mini sidebar-collapse {% endblock body_class %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/fontawesome-free/css/all.min.css') }}">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/select2/css/select2.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.css') }}">
  <!-- TagsInput -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/bootstrap4-tagsinput/tagsinput.css') }}">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css') }}">
  <!-- Bootstrap-select -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/bootstrap-select/dist/css/bootstrap-select.css') }}">
  <!-- iCheck -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css') }}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/jqvmap/jqvmap.min.css') }}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/adminlte.min.css') }}">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/overlayScrollbars/css/OverlayScrollbars.min.css') }}">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/daterangepicker/daterangepicker.css') }}">
  <!-- summernote -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/summernote/summernote-bs4.min.css') }}">
  <!-- jspreadsheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/jspreadsheet/jexcel.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/plugins/jspreadsheet/jsuites.css') }}">

{% endblock stylesheets %}

{% block content %}
  
  <div class="content-wrapper">

    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="row ml-1">
        <div class="col-sm-6">
          <h1 class="text-dark">KG4DT</h1>
        </div>
        <div class="col-sm-6">
          <div class="float-sm-right mr-2" style="display: flex">
            <select id="model-type">
              <option selected data-thumbnail="../../static/assets/img/model_type/scipy.png">scipy</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <!-- /.content-header -->

    <section class="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-body">

            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Species</b>
                <!-- : used as species identifier, name or formula, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="species"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Reaction</b>
                <!-- : reaction formula, A + 2 B > 3 C, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="reaction"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Stream</b>
                <!-- : used as stream identifier, stream 1, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="stream"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Solvent</b>
                <!-- : used as solvent identifier, water, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="solvent"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Catalyst</b>
                <!-- : used as catalyst identifier, Enzyme, e.g. -->
              </a>
              <input data-role="tagsinput" maxTags=1 id="catalyst"></input>
            </div>
            <div style="text-align: right;" class="mb-2">
              <button id="generate-button" class="btn btn-primary">Generate</button>
            </div>
          </div>
        </div>

        <div id="solvent-miscibility" class="card card-primary card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#solvent-miscibility-body" aria-expanded="true" style="color: black; display: flex;">
                Solvent Miscibility
              </a>
            </h4>
          </div>
          <div id="solvent-miscibility-body" class="collapse">
            <div class="card-body" style="display: flex;">
              <ul class="mb-2">
                <li>
                  <div style="display: flex;">
                    <a id="solvent-miscibility-reference" class="mr-4" style="color: black; display: block;">
                      Sigma Aldrich
                      <img src="{{ url_for('static', filename='assets/img/data_source/sigma_aldrich.png') }}" class="ml-1" style="height: 24px;">
                    </a>
                    <div id="solvent-miscibility-value"></div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div id="solute-solubility" class="card card-primary card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#solute-solubility-body" aria-expanded="true" style="color: black; display: flex;">
                Solute Solubility
              </a>
            </h4>
          </div>
          <div id="solute-solubility-body" class="collapse">
            <div class="card-body" style="display: flex;">
              <ul class="mb-2">
                <div style="display: block;">
                  <li>
                    <div class="mb-2">
                      <a id="solute-solubility-rmg-reference" class="mr-2" style="color: black;">
                        RMG
                        <img src="{{ url_for('static', filename='assets/img/ai_model/rmg.png') }}" class="ml-1" style="height: 24px;">
                      </a>
                      <span style="color: #999;" class="mr-4">(mol/L)</span>
                      <span style="color: #999;">temperature: 25 °C</span>
                    </div>
                    <div id="solute-solubility-rmg-value"></div>
                  </li>
                </div>
              </ul>
            </div>
          </div>
        </div>

        <div id="physical-property-pubchem" class="card card-warning card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#physical-property-pubchem-body" aria-expanded="true" style="color: black; display: flex;">
                PubChem
                <img src="{{ url_for('static', filename='assets/img/data_source/pubchem.png') }}" class="ml-2" style="height: 24px;">
              </a>
            </h4>
          </div>
          <div id="physical-property-pubchem-body" class="collapse">
            <div id="physical-property-pubchem-value" class="card-body"></div>
          </div>
        </div>

        <div id="physical-property-chemspider" class="card card-warning card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#physical-property-chemspider-body" aria-expanded="true" style="color: black; display: flex;">
                ChemSpider
                <img src="{{ url_for('static', filename='assets/img/data_source/chemspider.png') }}" class="ml-2" style="height: 24px;">
              </a>
            </h4>
          </div>
          <div id="physical-property-chemspider-body" class="collapse">
            <div id="physical-property-chemspider-value" class="card-body"></div>
          </div>
        </div>

        <div id="physical-property-wikipedia" class="card card-warning card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#physical-property-wikipedia-body" aria-expanded="true" style="color: black; display: flex;">
                Wikipedia
                <img src="{{ url_for('static', filename='assets/img/data_source/wikipedia.png') }}" class="ml-2" style="height: 24px;">
              </a>
            </h4>
          </div>
          <div id="physical-property-wikipedia-body" class="collapse">
            <div id="physical-property-wikipedia-value" class="card-body"></div>
          </div>
        </div>

        <div class="row">
          <!-- Phenomenon -->
          <div class="col-md-6">
            <blockquote class="quote-info mt-0">
              <h5>Description</h5>
            </blockquote>

            <div class="card card-info">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Accumulation</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <select id="accumulation-select" class="select2" style="width: 100%;" data-placeholder="Select an option">
                    <option disabled hidden selected></option>
                    {% for k, attr in entity["phenomenon"].items() %}
                      {% if attr["class"] == "Accumulation" %}
                      <option value="{{ k }}">{{ k.replace("_", " ") }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>

            <div class="card card-info">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Flow Pattern</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <select id="flow-pattern-select" class="select2" multiple="multiple" style="width: 100%;" data-placeholder="Select flow patterns">
                    {% for k, attr in entity["phenomenon"].items() %}
                      {% if attr["class"] == "FlowPattern" %}
                      <option value="{{ k }}">{{ k.replace("_", " ") }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>

            <div class="card card-info">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Molecular Transport</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <select id="molecular-transport-select" class="select2" multiple="multiple" style="width: 100%;" data-placeholder="Select options">
                  </select>
                </div>
              </div>
            </div>

            <div class="card card-info">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Model Law</h3>
              </div>
              <div class="card-body">
                <div class="form-group" id="model-laws">
                </div>
              </div>
            </div>

            <div id="reaction-cards">
            </div>

            <div id="reaction-card-template" class="card card-info" style="display: none;">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Chemical Reaction Template</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <select class="reaction-select select2" multiple="multiple" style="width: 100%;" data-placeholder="Select options">
                    {% for k, attr in entity["phenomenon"].items() %}
                      {% if attr["class"] == "ChemicalReactionPhenomenon" %}
                      <option value="{{ k }}">{{ k.replace("_", " ") }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Information -->
          <div class="col-md-6">
            <blockquote class="quote-success mt-0">
              <h5>Information</h5>
            </blockquote>

            <div id="species-info-card" class="card card-success">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Species</h3>
              </div>
              <div class="card-body">
                <form>
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["PhysicalParameter"] and "Species" in attr["dimensions"] %}
                    <div class="species-info-parameter" style="display: none;">
                      <div class="mb-1" style="width: 45%; display: flex;">
                        <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                        <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                      </div>
                      <div class="mb-2 parameter-value" style="width: 55%;">
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </form>
              </div>
            </div>

            <div id="reactor-info-card" class="card card-success">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Reactor</h3>
              </div>
              <div class="card-body">
                <form>
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["ReactorParameter"] %}
                    <div class="reactor-info-parameter" style="display: none;">
                      <div class="mb-1" style="width: 45%; display: flex;">
                        <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                        <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                      </div>
                      <div style="position: relative; width: 55%; display: flex;">
                        <div style="width: 100%;">
                          <input type="number" class="form-control" style="width: 100%; height: 24px; padding-left: 2px;" step="any">
                        </div>
                        <a class="unit" style="text-align: center; width: 60px; height: 24px; color: #999;"></a>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </form>
              </div>
            </div>

            <div id="stream-info-cards">
            </div>

            <div id="stream-info-card-template" class="card card-success" style="display: none;">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem">
                <h3 class="card-title">Stream Template</h3>
              </div>
              <div class="card-body">
                <div class="stream-info-input">
                  <div style="display: flex; vertical-align: middle;">
                    <div style="display: flex; width: 50%;">
                      <p class="mt-1 mb-0" style="padding-right: 10px;">State</p>
                      <select class="select2 stream-info-state-select" style="width: 100%;" data-placeholder="Select an option">
                        <option selected>liquid</option>
                        <option>gaseous</option>
                      </select>
                    </div>
                    <div style="display: flex; width: 50%; padding-left: 10px;">
                      <p class="mt-1 mb-0" style="padding-right: 10px;">Solvent</p>
                      <select class="select2 stream-info-solvent-select" style="width: 100%;">
                      </select>
                    </div>
                  </div>
                  <div class="mt-2 mb-2" style="display: flex; vertical-align: middle;">
                    <p class="mt-1 mb-0" style="padding-right: 10px;">Reaction</p>
                    <select class="select2 stream-info-reaction-select" multiple="multiple" style="width: 100%;" data-placeholder="Select options"></select>
                  </div>
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["PhysicalParameter"] and "Stream" in attr["dimensions"] and not attr["definition"] %}
                      {% if "Gas" in k %}
                      <div class="stream-info-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div style="position: relative; width: 55%; display: flex;">
                          <div style="width: 100%;">
                            <input type="number" class="form-control" style="width: 100%; height: 24px; padding-left: 2px;" step="any">
                          </div>
                          <a class="unit" style="text-align: center; width: 60px; height: 24px; color: #999;"></a>
                        </div>
                      </div>
                      {% else %}
                      <div class="stream-info-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div style="position: relative; width: 55%; display: flex;">
                          <div style="width: 100%;">
                            <input type="number" class="form-control" style="width: 100%; height: 24px; padding-left: 2px;" step="any">
                          </div>
                          <a class="unit" style="text-align: center; width: 60px; height: 24px; color: #999;"></a>
                        </div>
                      </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <div class="card mb-4">
          <div class="card-body mt-3">
            <div class="row">
              <div class="col-sm-6" style="display: flex;">
                <h5 class="ml-4 mr-4" style="height: 28px; padding-top: 7px;">Data</h5>
                <div style="display: flex;">
                  <select id="import" class="selectpicker" data-width="160px">
                    <option selected>website</option>
                    <option>local</option>
                  </select>
                  <div class="ml-3">
                    <input id="local-path" type="file" accept=".csv" style="display: none; margin-right: -50px; padding-top: 4.5px;">
                    <div>
                      <select id="website-case" class="selectpicker" data-width="221px" style="display: none;">
                        <option disabled selected hidden></option>
                        <option value="dushman/data.csv">dushman</option>
                        <option value="esterification/data_mecn_60-360rpm.csv">esterification_base_case</option>
                        <option value="esterification/data_mecn_0rpm.csv">esterification_0rpm_case</option>
                        <option value="esterification/data_toluene_360rpm.csv">esterification_toluene_case</option>
                      </select>
                    </div>
                  </div>
                </div>
                <button id="import-btn" class="btn btn-primary ml-3" style="height: 38px;">Import</button>
                <button id="save-btn" class="btn btn-primary ml-3" style="height: 38px;">Save</button>
              </div>
              <div class="col-sm-6">
                <div class="float-sm-right" style="display: flex">
                </div>
              </div>
            </div>
            <div id="input" class="ml-3 mt-3 mb-3">
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-body mt-3 mb-3">
            <div class="row mb-3">
              <div class="col-sm-6" style="display: flex;">
                <h5 class="ml-4 mr-4" style="margin-top: auto; margin-bottom: auto;">Exploration Input</h5>
                <button id="exploration-generate-button" class="btn btn-primary ml-3" style="height: 38px;">Generate</button>
              </div>
            </div>
            <div class="ml-2" style="display: flex;">
              <div class="row mb-4">
                <div id="model-law-parameter-form" class="ml-4" style="width: 100%;">
                  <div style="font-size: 18px; color: #0069d9;"><b>Law Parameter</b></div>
                  <form>
                  {% for law, lawDict in entity["law"].items() %}
                    {% set lawParameters = [] %}
                    {% for k in lawDict["model_variables"] %}
                      {% if entity["model_variable"][k]["class"] in ["MolecularTransportParameter"] and entity["model_variable"][k]["laws"] == [] %}
                        {% set _ = lawParameters.append(k) %}
                      {% endif %}
                    {% endfor %}
                    {% if lawParameters|length > 0 %}
                    <div class="model-law-parameter-div" law="{{ law }}" style="display: none; border-top: 1px solid #e9ecef; padding-top: 6px; padding-bottom: 12px;">
                      <div>⦁&nbsp;&nbsp;{{ law.replace('_', ' ') }}</div>
                      <div class="model-law-parameter-header ml-4" style="width: 100%;">
                        <div class="mt-2" style="color: grey; display: flex;">
                          <div style="display: flex; padding-left: 7.5px;">
                            <div style="width: 200px; text-align: center;"><b>Parameter</b></div>
                            <div style="width: 420px; text-align: center;"><b>Reaction</b></div>
                            <div style="width: 160px; text-align: center;"><b>Solvent</b></div>
                            <div style="width: 160px; text-align: center;"><b>Species</b></div>
                          </div>
                          <div style="display: flex;">
                              <span style="margin-left: 4px; width: 120px; text-align: center;"><b>initial value</b></span>
                              <span style="margin-left: 4px; width: 120px; text-align: center;"><b>min</b></span>
                              <span style="margin-left: 4px; width: 120px; text-align: center;"><b>max</b></span>
                          </div>
                        </div>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                    <div id="model-law-parameter-line-template" class="mt-2 ml-4" style="display: none; font-size: 14px;">
                      <div style="display: flex; color: grey; padding-left: 7.5px;">
                        <div class="parameter-line-name-symbol-unit" style="width: 200px; text-align: center; padding-top: 5px;">
                          <span style="white-space: nowrap;"></span>
                          <span></span>
                          <span></span>
                        </div>
                        <div class="parameter-line-reaction" style="width: 420px; text-align: center; padding-top: 5px;">
                          <span></span>
                        </div>
                        <div class="parameter-line-solvent" style="width: 160px; text-align: center; padding-top: 5px;">
                          <span></span>
                        </div>
                        <div class="parameter-line-species" style="width: 160px; text-align: center; padding-top: 5px;">
                          <span></span>
                        </div>
                      </div>
                      <div class="parameter-line-value" style="display: flex;">
                        <input class="form-control init" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                        <input class="form-control min" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                        <input class="form-control max" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                      </div>
                    </div>
                  </form>
                  
                  <div class="mt-4" style="font-size: 18px; color: #0069d9;"><b>Reaction Parameter</b></div>
                  <div style="display: flex;">
                    <div style="border-top: 1px solid #e9ecef;">
                      <div id="reaction-parameter-form" class="ml-4" style="width: 100%;">
                        <div class="reaction-parameter-header" style="width: 100%; display: none;">
                          <div class="mt-2" style="color: grey; display: flex;">
                            <div style="display: flex; padding-left: 7.5px;">
                              <div style="width: 200px; text-align: center;"><b>Parameter</b></div>
                              <div style="width: 420px; text-align: center;"><b>Reaction</b></div>
                              <div style="width: 160px; text-align: center;"><b>Solvent</b></div>
                              <div style="width: 160px; text-align: center;"><b>Species</b></div>
                            </div>
                            <div style="display: flex;">
                                <span style="margin-left: 4px; width: 120px; text-align: center;"><b>initial value</b></span>
                                <span style="margin-left: 4px; width: 120px; text-align: center;"><b>min</b></span>
                                <span style="margin-left: 4px; width: 120px; text-align: center;"><b>max</b></span>
                            </div>
                          </div>
                        </div>
                        <div id="reaction-parameter-line-template" style="width: 100%; display: none; font-size: 14px;">
                          <div class="mt-2" style="display: flex;">
                            <div style="display: flex; color: grey; padding-left: 7.5px;">
                              <div class="parameter-line-name-symbol-unit" style="width: 200px; text-align: center; padding-top: 5px;">
                                <span style="white-space: nowrap;"></span>
                                <span></span>
                                <span></span>
                              </div>
                              <div class="parameter-line-reaction" style="width: 420px; text-align: center; padding-top: 5px;">
                                <span></span>
                              </div>
                              <div class="parameter-line-solvent" style="width: 160px; text-align: center; padding-top: 5px;">
                                <span></span>
                              </div>
                              <div class="parameter-line-species" style="width: 160px; text-align: center; padding-top: 5px;">
                                <span></span>
                              </div>
                            </div>
                            <div class="parameter-line-value" style="display: flex;">
                              <input class="form-control init" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                              <input class="form-control min" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                              <input class="form-control max" type="number" style="padding-left: 2px; margin-left: 4px; width: 120px; height: 28px" step="any" onmousewheel="return false;">
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-sm-6" style="display: flex;">
                <button id="exploration-run-button" class="btn btn-primary ml-3" style="height: 38px;">Run Model Exploration</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-body mt-3 mb-3">
            <div class="row mb-3">
              <div class="col-sm-6" style="display: flex;">
                <h5 class="ml-4 mr-4" style="margin-top: auto; margin-bottom: auto;">Exploration Result</h5>
                <select id="model" title="Select a model">
                </select>
                <button id="export-model" class="btn btn-primary ml-3">Export</button>
              </div>
            </div>
            <div id="result" class="row mb-3" style="display: none; padding-top: 15px;">
              <div style="width: 33%; padding-left: 1%; padding-right: 1%; padding-top: 12px; border-top: 1px solid #e9ecef;">
                <div style="text-align: center;">
                  <h5 class="plot-title" style="margin-bottom: 0; font-size: 22px;">Model Exploration Result</h5>
                </div>
                <div id="rmse" style="height: 400px; width: 100%; ">
                </div>
              </div>
              <div style="padding-top: 12px; border-top: 1px solid #e9ecef;">
                <ul id="result-parameter-law">
                </ul>
                <span id="result-rmse" style="display: none;" class="ml-4">Model RMSE (mol/L):&nbsp;&nbsp;<b style="color: dodgerblue;"></b></span>
              </div>
            </div>
            <div id="plot" class="row" style="display: none; padding-top: 15px; border-top: 1px solid #e9ecef;">
              <div style="width: 33%; padding-left: 1%; padding-right: 1%;">
                <div style="text-align: center;">
                  <h5 class="plot-title" style="margin-bottom: 0; font-size: 22px;">Concentration Profile</h5>
                </div>
                <div id="profile" style="height: 400px; width: 100%; ">
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Sample:</div>
                  <select id="profile-sample" class="selectpicker dropup" data-dropup-auto="false" data-width="100%"></select>
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Variable:</div>
                  <select id="profile-variable" class="select2 dropup" data-dropup-auto="false" multiple data-width="100%"></select>
                </div>
              </div>
              <div style="width: 33%; padding-left: 1%; padding-right: 1%;">
                <div style="text-align: center;">
                  <h5 class="plot-title" style="margin-bottom: 0; font-size: 22px;">Inlet-Outlet Concentration</h5>
                </div>
                <div id="statistics" style="height: 400px; width: 100%;">
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Sample:</div>
                  <select id="statistics-sample" class="selectpicker dropup" data-dropup-auto="false" data-width="100%"></select>
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Species:</div>
                  <select id="statistics-species" class="select2 dropup" data-dropup-auto="false" multiple data-width="100%"></select>
                </div>
              </div>
              <div style="width: 33%; padding-left: 1%; padding-right: 1%;">
                <div style="text-align: center;">
                  <h5 class="plot-title" style="margin-bottom: 0; font-size: 22px;">Simulation vs. Experiment</h5>
                </div>
                <div id="parity" style="height: 400px; width: 100%;">
                </div>
                <div style="display: flex;" class="mt-3">
                  <div style="width: 80px; padding-top: 6px;">Species:</div>
                  <select id="parity-sample" class="selectpicker dropup" data-dropup-auto="false" data-width="100%"></select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="height: 0.1px;"></div>
      </div>
    </section>
  </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- jQuery -->
  <script src="{{ url_for('static', filename='assets/plugins/jquery/jquery.min.js') }}"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="{{ url_for('static', filename='assets/plugins/jquery-ui/jquery-ui.min.js') }}"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
  <!-- Bootstrap-select -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap-select/dist/js/bootstrap-select.min.js') }}"></script>
  <!-- Select2 -->
  <script src="{{ url_for('static', filename='assets/plugins/select2/js/select2.full.min.js') }}"></script>
  <!-- TagsInput -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap4-tagsinput/tagsinput.js') }}"></script>
  <!-- Bootstrap4 Duallistbox -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js') }}"></script>
  <!-- InputMask -->
  <script src="{{ url_for('static', filename='assets/plugins/moment/moment.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/inputmask/jquery.inputmask.min.js') }}"></script>
  <!-- date-range-picker -->
  <script src="{{ url_for('static', filename='assets/plugins/daterangepicker/daterangepicker.js') }}"></script>
  <!-- bootstrap color picker -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js') }}"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="{{ url_for('static', filename='assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js') }}"></script>
  <!-- Bootstrap Switch -->
  <script src="{{ url_for('static', filename='assets/plugins/bootstrap-switch/js/bootstrap-switch.min.js') }}"></script>
  <!-- ChartJS -->
  <script src="{{ url_for('static', filename='assets/plugins/chart.js/Chart.min.js') }}"></script>
  <!-- Sparkline -->
  <script src="{{ url_for('static', filename='assets/plugins/sparklines/sparkline.js') }}"></script>
  <!-- JQVMap -->
  <script src="{{ url_for('static', filename='assets/plugins/jqvmap/jquery.vmap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/jqvmap/maps/jquery.vmap.usa.js') }}"></script>
  <!-- jQuery Knob Chart -->
  <script src="{{ url_for('static', filename='assets/plugins/jquery-knob/jquery.knob.min.js') }}"></script>
  <!-- daterangepicker -->
  <script src="{{ url_for('static', filename='assets/plugins/moment/moment.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/daterangepicker/daterangepicker.js') }}"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="{{ url_for('static', filename='assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js') }}"></script>
  <!-- Summernote -->
  <script src="{{ url_for('static', filename='assets/plugins/summernote/summernote-bs4.min.js') }}"></script>
  <!-- overlayScrollbars -->
  <script src="{{ url_for('static', filename='assets/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js') }}"></script>
  <!-- jspreadsheet -->
  <script src="{{ url_for('static', filename='assets/plugins/jspreadsheet/jexcel.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/jspreadsheet/jsuites.js') }}"></script>
  <!-- flot -->
  <script src="{{ url_for('static', filename='assets/plugins/flot/lib/jquery.event.drag.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/lib/jquery.mousewheel.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.canvaswrapper.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.colorhelpers.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.axislabels.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.legend.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.saturated.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.browser.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.drawSeries.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.uiConstants.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.navigate.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.touchNavigate.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.hover.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.touch.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/plugins/flot/source/jquery.flot.selection.js') }}"></script>
  <!-- AdminLTE App -->
  <script src="{{ url_for('static', filename='assets/js/adminlte.js') }}"></script>

  <script type="text/javascript">{{ entity_json | safe }}</script>
  <script type="text/javascript">{{ model_context_json | safe }}</script>

  <script>
    if (modelContext) {
      loadModelContext(modelContext);
    }
    $(document).on('click', '.bottom-up-link', function() {
      sessionStorage.removeItem('modelContext');
    });
    $(document).on('click', '.top-down-rule-link', function() {
      sessionStorage.removeItem('modelContext');
    });
    $(document).on('click', '.top-down-exploration-link', function() {
      sessionStorage.setItem('modelContext', JSON.stringify(getModelContext()));
    });

    var generateState = false;

    $('.select2').select2()

    $('#model-type').find('option').each((idx, elem) => {
      if ($(elem).attr('data-thumbnail')) {
        $(elem).attr('data-content', '<img width="20px" src=' + $(elem).attr('data-thumbnail') + '/>&nbsp;&nbsp;&nbsp;' + $(elem).text());
      }
    });
    $('#model-type').selectpicker();
    $('#model').selectpicker();

    $(document).ready(function() {
      $('.reactor-info-parameter').each(function(index, parameterNode) {
        var parameter = $(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_');
        var unit = entity['model_variable'][parameter]['unit'];
        if (unit)
          $(parameterNode).find('.unit').html(entity['unit'][unit]['symbol']);
      });
      $('.model-law-info-parameter').each(function(index, parameterNode) {
        var parameter = $(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_');
        var unit = entity['model_variable'][parameter]['unit'];
        if (unit)
          $(parameterNode).find('.unit').html(entity['unit'][unit]['symbol']);
      });
      $('.stream-info-parameter').each(function(index, parameterNode) {
        var parameter = $(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_');
        var unit = entity['model_variable'][parameter]['unit'];
        if (unit)
          $(parameterNode).find('.unit').html(entity['unit'][unit]['symbol']);
      });
    })

    function speciesValid() {
      var species = $('#species').val().split(',');
      $('#species').prev().children().each(function(index, elem) {
        var symbol = document.createElement('a');
        var span = document.createElement('span');
        symbol.innerHTML = species[index];
        span.setAttribute('data-role', 'remove');
        $(elem).empty().append(symbol).append(span);
      })
    }
    $(document).on('change', '#species', speciesValid);

    function reactionValid() {
      var species = $('#species').val().split(',');
      var reactions = $('#reaction').val().split(',');
      var reactionVal = [];
      var re = new RegExp("^((\\d+ )?.+ \\+ )*(\\d+ )?.+ > ((\\d+ )?.+ \\+ )*(\\d+ )?.+$");
      var reNum = new RegExp("^\\d+$");
      $('#reaction').prev().children().each(function(index, elem) {
        var reaction = reactions[index];
        if (re.test(reaction)) {
          var lhs_species = $.map(reaction.split(' > ')[0].split(' + '), function(s, i) {
            if (reNum.test(s.split(' ')[0])) {
              return s.split(' ').slice(1).join(' ');
            } else {
              return s;
            }
          });
          var rhs_species = $.map(reaction.split(' > ')[1].split(' + '), function(s, i) {
            if (reNum.test(s.split(' ')[0])) {
              return s.split(' ').slice(1).join(' ');
            } else {
              return s;
            }
          });
          var reaction_species = $.merge(lhs_species, rhs_species);
          if (reaction_species.every(function(s) {return species.includes(s);})) {
            var formula = document.createElement('a');
            var span = document.createElement('span');
            formula.innerHTML = reaction;
            span.setAttribute('data-role', 'remove');
            $(elem).empty().append(formula).append(span);
            reactionVal.push(reaction);
          } else {
            $('#reaction').prev().remove(elem);
          }
        }
      })
      $('#reaction').val(reactionVal.join(','));
    }
    $(document).on('change', '#reaction', reactionValid);
    
    function catalystValid() {
      var catalysts = $('#catalyst').val().split(',').filter((x) => {return x;});
      if (catalysts.length > 1) {
        $('#catalyst').val(catalysts[0]).trigger('change');
        $('#catalyst').prev().children('span').each(function(index, elem) {
          if (index > 0) {
            $(elem).remove();
          }
        });
      } else {
        $('#catalyst').prev().children().each(function(index, elem) {
          var symbol = document.createElement('a');
          var span = document.createElement('span');
          symbol.innerHTML = catalysts[index];
          span.setAttribute('data-role', 'remove');
          $(elem).empty().append(symbol).append(span);
        });
      }
    }
    $(document).on('change', '#catalyst', catalystValid);

    $(document).on('change', '#species', function() {generateState = false;})
    $(document).on('change', '#reacton', function() {generateState = false;})
    $(document).on('change', '#stream', function() {generateState = false;})
    $(document).on('change', '#solvent', function() {generateState = false;})
    $(document).on('change', '#catalyst', function() {generateState = false;})

    function getPubChemPhysicalProperty() {
      var solvents = $('#solvent').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      if (!solvents) {
        $('#physical-property-pubchem').css('display', 'none');
      };
      var physicalPropertyRequestJson = JSON.stringify(solvents);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.physical_property_pubchem") }}', true);
      xhr.timeout = 30000; // timeout in 30 seconds
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var physicalPropertyResult = JSON.parse(xhr.response);
          $('#physical-property-pubchem-value').children().remove();
          for (var solvent in physicalPropertyResult) {
            var solventPhysicalPropertyResult = physicalPropertyResult[solvent];
            var solventDiv = $('<div class="ml-3 mb-3"></div>');
            var solventHeadDiv = $('<div style="display: flex"></div>');
            $(solventHeadDiv).append($('<label style="margin-bottom: 0;">' + solvent + '</label>'));
            $(solventHeadDiv).append($('<span class="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;</span>'));
            $(solventHeadDiv).append($('<span style="color: #999">SMILES: ' + physicalPropertyResult[solvent]['canonical_smiles'] + '</span>'));
            $(solventDiv).append(solventHeadDiv);
            for (var solventPhysicalProperty in solventPhysicalPropertyResult['property']) {
              var solventPhysicalPropertyDiv = $('<div class="ml-3"></div>');
              var solventPhysicalPropertyList = solventPhysicalPropertyResult['property'][solventPhysicalProperty];
              $(solventPhysicalPropertyDiv).append($('<a>' + solventPhysicalProperty + '</a>'));
              var solventPhysicalPropertyUL = $('<ul class="mb-0"></ul>');
              for (var i in solventPhysicalPropertyList) {
                var solventPhysicalPropertyLI = $('<li></li>');
                $(solventPhysicalPropertyLI).append($('<div>' + solventPhysicalPropertyList[i]['value'] + '</div>'));
                $(solventPhysicalPropertyLI).append($('<div style="color: #999;">' + solventPhysicalPropertyList[i]['reference'] + '</div>'));
                $(solventPhysicalPropertyUL).append(solventPhysicalPropertyLI);
              }
              $(solventPhysicalPropertyDiv).append(solventPhysicalPropertyUL);
              $(solventDiv).append(solventPhysicalPropertyDiv);
            }
            $('#physical-property-pubchem-value').append(solventDiv);
          }
          $('#physical-property-pubchem').css('display', 'block')
        } else {
          $('#physical-property-pubchem').css('display', 'none');
        }
      };
      xhr.send(physicalPropertyRequestJson);
    }

    function getChemSpiderPhysicalProperty() {
      var solvents = $('#solvent').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      if (!solvents) {
        $('#physical-property-chemspider').css('display', 'none');
      };
      var physicalPropertyRequestJson = JSON.stringify(solvents);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.physical_property_chemspider") }}', true);
      xhr.timeout = 30000; // timeout in 30 seconds
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var physicalPropertyResult = JSON.parse(xhr.response);
          $('#physical-property-chemspider-value').children().remove();
          for (var solvent in physicalPropertyResult) {
            var solventPhysicalPropertyResult = physicalPropertyResult[solvent];
            var solventDiv = $('<div class="ml-3 mb-3"></div>');
            var solventHeadDiv = $('<div style="display: flex"></div>');
            $(solventHeadDiv).append($('<label style="margin-bottom: 0;">' + solvent + '</label>'));
            $(solventHeadDiv).append($('<span class="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;</span>'));
            $(solventHeadDiv).append($('<span style="color: #999">SMILES: ' + physicalPropertyResult[solvent]['canonical_smiles'] + '</span>'));
            $(solventDiv).append(solventHeadDiv);
            for (var solventPhysicalProperty in solventPhysicalPropertyResult['property']) {
              var solventPhysicalPropertyDiv = $('<div class="ml-3"></div>');
              var solventPhysicalPropertyList = solventPhysicalPropertyResult['property'][solventPhysicalProperty];
              $(solventPhysicalPropertyDiv).append($('<a>' + solventPhysicalProperty + '</a>'));
              var solventPhysicalPropertyUL = $('<ul class="mb-0"></ul>');
              for (var i in solventPhysicalPropertyList) {
                var solventPhysicalPropertyLI = $('<li></li>');
                $(solventPhysicalPropertyLI).append($('<div>' + solventPhysicalPropertyList[i]['value'] + '</div>'));
                $(solventPhysicalPropertyLI).append($('<div style="color: #999;">' + solventPhysicalPropertyList[i]['reference'] + '</div>'));
                $(solventPhysicalPropertyUL).append(solventPhysicalPropertyLI);
              }
              $(solventPhysicalPropertyDiv).append(solventPhysicalPropertyUL);
              $(solventDiv).append(solventPhysicalPropertyDiv);
            }
            $('#physical-property-chemspider-value').append(solventDiv);
          }
          $('#physical-property-chemspider').css('display', 'block')
        } else {
          $('#physical-property-chemspider').css('display', 'none');
        }
      };
      xhr.send(physicalPropertyRequestJson);
    }

    function getWikipediaPhysicalProperty() {
      var solvents = $('#solvent').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      if (!solvents) {
        $('#physical-property-wikipedia').css('display', 'none');
      };
      var physicalPropertyRequestJson = JSON.stringify(solvents);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.physical_property_wikipedia") }}', true);
      xhr.timeout = 30000; // timeout in 30 seconds
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var physicalPropertyResult = JSON.parse(xhr.response);
          $('#physical-property-wikipedia-value').children().remove();
          for (var solvent in physicalPropertyResult) {
            var solventPhysicalPropertyResult = physicalPropertyResult[solvent];
            var solventDiv = $('<div class="ml-3 mb-3"></div>');
            var solventHeadDiv = $('<div style="display: flex"></div>');
            $(solventHeadDiv).append($('<label style="margin-bottom: 0;">' + solvent + '</label>'));
            $(solventHeadDiv).append($('<span class="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;</span>'));
            $(solventHeadDiv).append($('<span style="color: #999">SMILES: ' + physicalPropertyResult[solvent]['canonical_smiles'] + '</span>'));
            $(solventDiv).append(solventHeadDiv);
            for (var solventPhysicalProperty in solventPhysicalPropertyResult['property']) {
              var solventPhysicalPropertyDiv = $('<div class="ml-3"></div>');
              var solventPhysicalPropertyList = solventPhysicalPropertyResult['property'][solventPhysicalProperty];
              $(solventPhysicalPropertyDiv).append($('<a>' + solventPhysicalProperty + '</a>'));
              var solventPhysicalPropertyUL = $('<ul class="mb-0"></ul>');
              for (var i in solventPhysicalPropertyList) {
                var solventPhysicalPropertyLI = $('<li></li>');
                $(solventPhysicalPropertyLI).append($('<div>' + solventPhysicalPropertyList[i]['value'] + '</div>'));
                $(solventPhysicalPropertyLI).append($('<div style="color: #999;">' + solventPhysicalPropertyList[i]['reference'] + '</div>'));
                $(solventPhysicalPropertyUL).append(solventPhysicalPropertyLI);
              }
              $(solventPhysicalPropertyDiv).append(solventPhysicalPropertyUL);
              $(solventDiv).append(solventPhysicalPropertyDiv);
            }
            $('#physical-property-wikipedia-value').append(solventDiv);
          }
          $('#physical-property-wikipedia').css('display', 'block')
        } else {
          $('#physical-property-wikipedia').css('display', 'none');
        }
      };
      xhr.send(physicalPropertyRequestJson);
    }

    function getSolventMiscibility() {
      var solvents = $('#solvent').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      if (!solvents) {
        $('#solvent-miscibility').css('display', 'none');
      };
      var solventMiscibilityRequestJson = JSON.stringify(solvents);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.solvent_miscibility") }}', true);
      xhr.timeout = 30000; // timeout in 30 seconds
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var solventMiscibilityResult = JSON.parse(xhr.response);
          $('#solvent-miscibility-value').text(solventMiscibilityResult[0]);
          $('#solvent-miscibility-reference').attr('href', solventMiscibilityResult[1]);
          if (solventMiscibilityResult[1]) {
            $('#solvent-miscibility-reference').css('display', 'block')
          } else {
            $('#solvent-miscibility-reference').css('display', 'none')
          }
          $('#solvent-miscibility').css('display', 'block');
        } else {
          $('#solvent-miscibility').css('display', 'none');
        }
      };
      xhr.send(solventMiscibilityRequestJson);
    }

    function getSoluteSolubility() {
      var solvents = $('#solvent').val().split(',');
      var solutes = $('#species').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      solutes = $(solutes).filter(function(index, solute) {return solute.length > 0}).toArray();
      if (!solvents || !solutes) {
        $('#solute-solubility').css('display', 'none');
      };
      var soluteSolubilityRequestJson = JSON.stringify({"solvents": solvents, "solutes": solutes});
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.solute_solubility") }}', true);
      xhr.timeout = 120000; // timeout in 2 minutes
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var soluteSolubilityResult = JSON.parse(xhr.response);
          $('#solute-solubility-rmg-reference').closest('div').css('display', 'block');
          $('#solute-solubility-rmg-reference').attr('href', soluteSolubilityResult["reference"]);
          $('#solute-solubility-rmg-value').children().remove();
          var table = $('<table class="table table-bordered" style="color: black; text-align: center"><thead><tr><th></th></tr></thead></table>')
          $(solutes).each(function(_, solute) {
            $(table).find('thead').find('tr').append($('<th style="font-weight: normal;">' + solute + '</th>'));
          });
          var tbody = $('<tbody></tbody>');
          $(solvents).each(function(index, solvent) {
            $(tbody).append($('<tr>' + solvent + '</tr>'));
            $(tbody).find('tr:eq(' + index.toString() + ')').append($('<td>' + solvent + '</td>'))
            $(soluteSolubilityResult["value"][index]).each(function(_, value) {
              $(tbody).find('tr:eq(' + index.toString() + ')').append($('<td>' + value + '</td>'))
            });
          });
          $(table).append(tbody);
          $('#solute-solubility-rmg-value').append(table);
          $('#solute-solubility').css('display', 'block');
        } else {
          $('#solute-solubility').css('display', 'none');
        }
      };
      xhr.send(soluteSolubilityRequestJson);
    }

    $(document).on('click', '#generate-button', function() {
      $('#accumulation-select').val(null).trigger('change');
      $('#flow-pattern-select').val(null).trigger('change');
      $('#molecular-transport-select').val(null).trigger('change');
      $('#reaction-cards').empty();
      $.each($('#reaction').val().split(','), function(index, reaction) {
        var reactionCard = $('#reaction-card-template').clone();
        reactionCard.attr('id', 'reaction-card-' + index);
        reactionCard.attr('style', '');
        reactionCard.find('span').remove();
        reactionCard.find('.select2').select2();
        var formula = document.createElement('a');
        formula.innerHTML = reaction;
        reactionCard.find('.card-title').first().text('Chemical Reaction: ');
        $(formula).appendTo(reactionCard.find('.card-title').first());
        reactionCard.appendTo("#reaction-cards");
      });

      $('#species-info-card').find('input').val(null).trigger('change');
      $('.species-info-parameter').css('display', 'none').trigger('change');
      var reactionData = []
      $.each($('#reaction').val().split(','), function(index, reaction) {
        reactionData.push({id: reaction, text: '<a>' + reaction + '</a>'});
      })
      $('#stream-info-cards').empty();
      $.each($('#stream').val().split(','), function(index, stream) {
        var streamInfoCard = $('#stream-info-card-template').clone();
        streamInfoCard.attr('id', 'stream-info-card-' + index);
        streamInfoCard.attr('style', '');
        streamInfoCard.find('span').remove();
        streamInfoCard.find('.select2').select2();
        streamInfoCard.find('.card-title').first().text('Stream: ' + stream);
        $.each($('#solvent').val().split(','), function(index, solvent) {
          var solventOption = new Option(solvent, solvent);
          streamInfoCard.find('.stream-info-solvent-select').first().append(solventOption);
        })
        streamInfoCard.find('.stream-info-solvent-select').val(null);
        streamInfoCard.find('.stream-info-reaction-select').select2({
          data: reactionData,
          templateResult: function (d) { return $(d.text); },
          templateSelection: function (d) { return $(d.text); },
        })
        streamInfoCard.find('.stream-info-reaction-select').val(null);
        streamInfoCard.appendTo("#stream-info-cards");
      });

      getSolventMiscibility();
      getSoluteSolubility();
      getPubChemPhysicalProperty();
      getChemSpiderPhysicalProperty();
      getWikipediaPhysicalProperty();

      generateState = true;
    })

    $(document).on('change', '#accumulation-select', function() {
      var accumulationPhenomenon = $('#accumulation-select').val()
      if (accumulationPhenomenon) {
        accumulationPhenomenon = accumulationPhenomenon.replaceAll(' ', '_');
        var flowPatternPhenomena = entity['phenomenon'][accumulationPhenomenon]['flow_patterns'];
        var phenomenonData = [];
        $.each(flowPatternPhenomena, function(_, phenomenon) {
          phenomenonData.push({id: phenomenon, text: phenomenon.replaceAll('_', ' ')});
        });
        var parentElem = $('#flow-pattern-select').parent();
        $('#flow-pattern-select').remove();
        var select = $('<select></select>')
        $(select).addClass('select2');
        $(select).attr('id', 'flow-pattern-select');
        $(select).attr('multiple', 'multiple');
        $(select).attr('style', 'width: 100%;');
        $(select).attr('data-placeholder', 'Select phenomena');
        $(select).select2({data: phenomenonData});
        parentElem.append(select);
        $('#flow-pattern-select').select2();
        $(document).on('change', '#flow-pattern-select', triggerFlowPattern);
        $('#flow-pattern-select').val(null).trigger('change');
      }
    })

    function triggerFlowPattern() {
      var flowPatternPhenomena = $('#flow-pattern-select').val();
      if (flowPatternPhenomena) {
        flowPatternPhenomena = flowPatternPhenomena.map((x) => {return x.replaceAll(' ', '_');});
        var molecularTransportPhenomena = [];
        $.each(flowPatternPhenomena, function(_, flowPatternPhenomenon) {
          $.each(entity['phenomenon'][flowPatternPhenomenon]['molecular_transport_phenomena'].slice(), function(_, molecularTransportPhenomenon) {
            if (!molecularTransportPhenomena.includes(molecularTransportPhenomenon)) {
              molecularTransportPhenomena.push(molecularTransportPhenomenon);
            }
          });
        });
        var phenomenonData = [];
        $.each(molecularTransportPhenomena, function(_, phenomenon) {
          phenomenonData.push({id: phenomenon, text: phenomenon.replaceAll('_', ' ')});
        });
        var parentElem = $('#molecular-transport-select').parent();
        $('#molecular-transport-select').remove();
        var select = $('<select></select>')
        $(select).addClass('select2');
        $(select).attr('id', 'molecular-transport-select');
        $(select).attr('multiple', 'multiple');
        $(select).attr('style', 'width: 100%;');
        $(select).attr('data-placeholder', 'Select phenomena');
        $(select).select2({data: phenomenonData});
        parentElem.append(select);
        $('#molecular-transport-select').select2();
        $(document).on('change', '#molecular-transport-select', triggerParameterLaw);
        $('#molecular-transport-select').val(null).trigger('change');
      }
    }
    $(document).on('change', '#flow-pattern-select', triggerFlowPattern);

    function triggerParameterLaw() {
      $('#model-laws').children().remove();
      if ($('#molecular-transport-select').val().length == 0) return;
      var flowPatternPhenomena = $('#flow-pattern-select').val();
      if (flowPatternPhenomena) {
        flowPatternPhenomena = flowPatternPhenomena.map((x) => {return x.replaceAll(' ', '_');});
        var molecularTransportPhenomena = [];
        $.each(flowPatternPhenomena, function(_, flowPatternPhenomenon) {
          $.each(entity['phenomenon'][flowPatternPhenomenon]['molecular_transport_phenomena'].slice(), function(_, molecularTransportPhenomenon) {
            if (!molecularTransportPhenomena.includes(molecularTransportPhenomenon)) {
              molecularTransportPhenomena.push(molecularTransportPhenomenon);
            }
          });
        });
        var parameters = [];
        $.each(entity['law'], function(law, lawDict) {
          if (flowPatternPhenomena.includes(lawDict['phenomenon'])) {
            parameters = parameters.concat(lawDict['model_variables']);
          }
        });
        $.each(entity['law'], function(law, lawDict) {
          if (molecularTransportPhenomena.includes(lawDict['phenomenon'])) {
            parameters = parameters.concat(lawDict['model_variables']);
          }
        });
        parameters = new Set(parameters);
        parameters = Array.from(parameters);
        parameters = parameters.filter((parameter) => {
          var lawWithRules = entity['model_variable'][parameter]['laws'].filter((law) => {
            return entity['law'][law]['rule'];
          })
          return lawWithRules.length > 0;
        });
        var phenomena = molecularTransportPhenomena.concat(flowPatternPhenomena);
        phenomena = new Set(phenomena);

        var parameterLawDict = {};
        $(parameters).each(function(_, parameter) {
          var laws = [];
          $.each(entity['model_variable'][parameter]['laws'], function(_, law) {
            var lawRule = entity['law'][law]['rule'];
            var lawRulePhenomena = new Set(entity['rule'][lawRule]['phenomena']);
            if (lawRulePhenomena.isSubsetOf(phenomena)) {
              laws.push(law);
            }
          });
          if (laws.length > 0) {
            parameterLawDict[parameter] = laws;
          }
        });

        $.each(parameterLawDict, function(parameter, laws) {
          var parameterDiv = $('<div class="mt-2"><div>' + parameter.replaceAll('_', ' ') + '&nbsp;&nbsp;' + entity['model_variable'][parameter]['symbol'] + '</div></div>');
          var lawData = [];
          $.each(laws, function(_, law) {
            var text = law.split('by_')[0].replaceAll('_', ' ') + '(' + law.split('by_')[1].replaceAll('_', ' ') + ')';
            lawData.push({id: law, text: text});
          })
          var lawSelect = $('<select></select>')
          $(lawSelect).addClass('select2');
          $(lawSelect).attr('id', parameter.replaceAll('_', '-').toLowerCase() + '-law-select');
          $(lawSelect).attr('multiple', 'multiple');
          $(lawSelect).attr('parameter', parameter);
          $(lawSelect).attr('class', 'model-law');
          $(lawSelect).attr('style', 'width: 100%;');
          $(lawSelect).attr('data-placeholder', 'Select an option');
          $(lawSelect).select2({data: lawData});
          $(lawSelect).val(null);
          lawSelect.appendTo(parameterDiv);
          parameterDiv.appendTo('#model-laws');
          $('#' + parameter.replaceAll('_', '-').toLowerCase() + '-law-select').select2();
        });
        $('#model-laws').find('div:eq(0)').removeClass('mt-2');
        $(document).on('change', '.model-law', triggerReactorInfoCard);
        // $(document).on('change', '.model-law', triggerModelLawParameterInfoCard);
      }
    }
    $(document).on('change', '#molecular-transport-select', triggerParameterLaw);

    function triggerReactorInfoCard() {
      $('.reactor-info-parameter').find('input').val(null);
      $('.reactor-info-parameter').css('display', 'none');

      var parameters = [];
      var laws = [];
      var accumulationPhenomenon = $('#accumulation-select').val()
      if (accumulationPhenomenon) {
        accumulationPhenomenon = accumulationPhenomenon.replaceAll(' ', '_');
        for (var li in entity['law']) {
          var law = entity['law'][li];
          if (law['phenomenon'] == accumulationPhenomenon) {
            for (var pi in law['model_variables']) {
              var parameter = law['model_variables'][pi]
              if (!parameters.includes(parameter))
                parameters.push(parameter);
            }
          }
        }
      }
      $.each($('.model-law'), function(_, elem) {
        $.each($(elem).val(), function(_, law){
          laws.push(law);
          for (var pi in entity['law'][law]['model_variables']) {
            var parameter = entity['law'][law]['model_variables'][pi]
            if (!parameters.includes(parameter))
              parameters.push(parameter);
          }
        });
      });

      $.each($('.reactor-info-parameter'), function(index, parameterNode) {
        if (parameters.includes($(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_')))
          parameterNode.style.display = 'flex';
      })
    };
    $(document).on('change', '#accumulation-select', triggerReactorInfoCard);
    $(document).on('change', '#flow-pattern-select', triggerReactorInfoCard);

    // function triggerModelLawParameterInfoCard() {
    //   $('.model-law-info-parameter').find('input').val(null);
    //   $('.model-law-info-div').css('display', 'none');

    //   $.each($('.model-law'), function(_, elem) {
    //     $.each($(elem).val(), function(_, law) {
    //       $.each($('.model-law-info-div'), function(_, lawDiv) {
    //         if ($(lawDiv).attr('law') == law) {
    //           $(lawDiv).css('display', '');
    //         }
    //       });
    //     });
    //   });
    // }

    function triggerStreamInfoCard() {
      $('.stream-info-parameter').find('input').val(null);
      $('.stream-info-parameter').css('display', 'none');

      var parameters = [];
      var laws = [];
      var flowPatternPhenomena = $('#flow-pattern-select').val()
      if (flowPatternPhenomena) {
        flowPatternPhenomena = flowPatternPhenomena.map((x) => {return x.replaceAll(' ', '_');});
        for (var law in entity['law']) {
          if (flowPatternPhenomena.includes(entity['law'][law]['phenomenon'])) {
            for (var pi in entity['law'][law]['model_variables']) {
              var parameter = entity['law'][law]['model_variables'][pi]
              if (!parameters.includes(parameter))
                parameters.push(parameter);
            }
            laws.push(law);
          }
        }
        for (var pi in parameters) {
          parameter = parameters[pi];
          var intersect = $.grep(entity.model_variable[parameter]['laws'], function(element) {
            return $.inArray(element, laws) != -1;
          });
          if (intersect.length > 0)
            parameters.splice(parameters.indexOf(parameter), 1);
        }
      }

      var re = new RegExp('Gas');
      $.each($('.stream-info-parameter'), function(index, parameterNode) {
        var streamState = $(parameterNode).closest('.stream-info-input').find('.stream-info-state-select').val();
        var parameter = $(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_');
        if (streamState == 'gaseous' & re.test(parameter) & parameters.includes(parameter)) {
          parameterNode.style.display = 'flex';
        }
        if (streamState == 'liquid' & !re.test(parameter) & parameters.includes(parameter)) {
          parameterNode.style.display = 'flex';
        }
      })
    }
    $(document).on('change', '#flow-pattern-select', triggerStreamInfoCard)

    $(document).on('change', '.reaction-select', function() {
      var reactionPhenomena = $(this).val().map((x) => {return x.replaceAll(' ', '_')});
      var reactionInfoCard = $('#reaction-info-card-' + $('.reaction-select').index($(this)).toString());
      var reaction = $('#reaction').val().split(',')[$('.reaction-select').index($(this))];
      var reNum = new RegExp("^\\d+$");
      var reagents = $.map(reaction.split(' > ')[0].split(' + '), function(s, i) {
        if (reNum.test(s.split(' ')[0])) {
          return s.split(' ').slice(1).join(' ');
        } else {
          return s;
        }
      });
      var solvents = $('#solvent').val().split(',');

      // reaction info card
      $(reactionInfoCard).find('.reaction-info-parameter').val(null);
      $(reactionInfoCard).find('.reaction-info-parameter').css('display', 'none');
      var parameters = [];
      for (var li in entity['law']) {
        var law = entity['law'][li];
        if (reactionPhenomena.includes(law['phenomenon'])) {
          for (var pi in law['model_variables']) {
            parameter = law['model_variables'][pi];
            if (!parameters.includes(parameter) & !entity.model_variable[parameter]['definition'])
              parameters.push(parameter);
            if (entity.model_variable[parameter]['definition']) {
              var definition = entity.model_variable[parameter]['definition'];
              for (var dpi in entity.definition[definition]['model_variables']) {
                dparameter = entity.definition[definition]['model_variables'][dpi];
                if (!parameters.includes(dparameter))
                  parameters.push(dparameter);
              }
            }
          }
        }
      }

      $.each($(reactionInfoCard).find('.reaction-info-parameter'), function(index, parameterNode) {
        var parameterName = $(parameterNode).find('.parameter-name:eq(0)').text().replaceAll(' ', '_');
        if (parameters.includes(parameterName))
          parameterNode.style.display = 'flex';
      })

      $(reactionInfoCard).find('.reaction-info-species-parameter .parameter-value').empty();
      $(reactionInfoCard).find('.reaction-info-species-parameter').css('display', 'none');
      $.each($(reactionInfoCard).find('.reaction-info-species-parameter'), function(index, parameterNode) {
        var parameterName = $(parameterNode).find('.parameter-name:eq(0)').text().replaceAll(' ', '_');
        if (parameters.includes(parameterName)) {
          parameterNode.style.display = 'flex';
          var parameterValueDiv = $(parameterNode).children('div:eq(1)');
          $.each($(reagents), function(index, reagent) {
            var div = document.createElement('div');
            div.style.display = 'flex';
            div.style.float = 'left';
            div.style.width = '100%';
            div.classList.add('mb-1');
            $(div).append($('<a style="width: 50%; color: #999; text-align: center;"></a>'));
            $(div).append($('<input class="form-control" type="number" style="width: 50%; padding-left: 2px; margin-left: 4px; height: 24px" step="any"/>'));
            div.childNodes[0].innerHTML = reagent;
            parameterValueDiv.append(div)
          })
        }
      })

      $(reactionInfoCard).find('.reaction-info-solvent-parameter .parameter-value').empty();
      $(reactionInfoCard).find('.reaction-info-solvent-parameter').css('display', 'none');
      $.each($(reactionInfoCard).find('.reaction-info-solvent-parameter'), function(index, parameterNode) {
        var parameterName = $(parameterNode).find('.parameter-name:eq(0)').text().replaceAll(' ', '_');
        if (parameters.includes(parameterName)) {
          parameterNode.style.display = 'flex';
          var parameterValueDiv = $(parameterNode).children('div:eq(1)');
          $.each($(solvents), function(index, solvent) {
            var div = document.createElement('div');
            div.style.display = 'flex';
            div.style.float = 'left';
            div.style.width = '100%';
            div.classList.add('mb-1');
            $(div).append($('<a style="width: 50%; color: #999; text-align: center;"></a>'));
            $(div).append($('<input class="form-control" type="number" style="width: 50%; padding-left: 2px; margin-left: 4px; height: 24px" step="any"/>'));
            div.childNodes[0].innerHTML = solvent;
            if (solvents.length > 1) {
              if (index % 2 == 0) {
                div.style.marginRight = '8px';
              } else if (index % 2 == 1) {
                div.style.marginLeft = '8px';
              } else {
                div.style.marginLeft = '8px';
                div.style.marginRight = '8px';
              }
            }
            parameterValueDiv.append(div)
          })
        }
      })

      $(reactionInfoCard).find('.reaction-info-specific-law textarea').val(null);
      $(reactionInfoCard).find('.reaction-info-specific-law').css('display', 'none');
      $.each($(reactionInfoCard).find('.reaction-info-specific-law'), function(index, lawNode) {
        var lawPhenomenon = $(lawNode).find('.law-phenomenon').first().text().substring(4).replaceAll(' ', '_');
        if (reactionPhenomena.includes(lawPhenomenon))
          lawNode.style.display = 'flex';
      })

      // species info card
      $.each($('.species-info-parameter'), function(index, parameterNode) {
        var parameterName = $(parameterNode).find('.parameter-name:eq(0)').text().replaceAll(' ', '_');
        if (parameters.includes(parameterName)) {
          parameterNode.style.display = 'flex';
          var parameterValueDiv = $(parameterNode).children('div:eq(1)');
          $(parameterValueDiv).children().remove();
          $.each($('#species').val().split(','), function(index, species) {
            var div = document.createElement('div');
            div.style.display = 'flex';
            div.style.float = 'left';
            div.style.width = '30%';
            div.classList.add('mb-1');
            $(div).append($('<a style="width: 50%; color: #999; text-align: center;"></a>'));
            $(div).append($('<input class="form-control" type="number" style="width: 50%; padding-left: 2px; margin-left: 4px; height: 24px" step="any"/>'));
            div.childNodes[0].innerHTML = species;
            if ($('#species').val().split(',').length > 1) {
              if (index % 3 == 0) {
                div.style.marginRight = '8px';
              } else if (index % 3 == 2) {
                div.style.marginLeft = '8px';
              } else {
                div.style.marginLeft = '8px';
                div.style.marginRight = '8px';
              }
            }
            parameterValueDiv.append(div)
          })
        }
      })
    })

    $(document).on('change', '.stream-info-state-select', function() {
      if ($(this).closest('.stream-info-input').find('.stream-info-state-select').first().val() == 'gaseous') {
        $(this).closest('.stream-info-input').find('.stream-info-solvent-select').prop("disabled", true).val(null).trigger('change');
        $(this).closest('.stream-info-input').find('.stream-info-reaction-select').prop("disabled", true).val(null).trigger('change');
        $(this).closest('.stream-info-input').find('input').val(null).trigger('change');
        var re = new RegExp("Gas");
        $.each($(this).closest('.stream-info-input').find('.stream-info-parameter'), function(index, streamParameterNode) {
          if (re.test($(streamParameterNode).find('.parameter-name').first().text())) {
            streamParameterNode.style.display = "flex";
          }
          else
            streamParameterNode.style.display = "none";
        })
      }
      else {
        $(this).closest('.stream-info-input').find('.stream-info-solvent-select').prop("disabled", false).val(null).trigger('change');
        $(this).closest('.stream-info-input').find('.stream-info-reaction-select').prop("disabled", false).val(null).trigger('change');
        $(this).closest('.stream-info-input').find('input').val(null).trigger('change');
        var re = new RegExp("Gas");
        $.each($(this).closest('.stream-info-input').find('.stream-info-parameter'), function(index, streamParameterNode) {
          if (re.test($(streamParameterNode).find('.parameter-name').first().text()))
            streamParameterNode.style.display = "none";
          else
            streamParameterNode.style.display = "flex";
        })
      }
    })
    
    // TODO
    function checkValidation() {
      return true;
    }

    function loadModelContext(modelContext) {
      isDictionary = function (obj) {
          if(!obj) return false;
          if(Array.isArray(obj)) return false;
          if(obj.constructor != Object) return false;
          return true;
      };
      $('#species').val(modelContext['basic']['species']);
      $('#reaction').val(modelContext['basic']['reactions']);
      $('#stream').val(modelContext['basic']['streams']);
      $('#solvent').val(modelContext['basic']['solvents']);
      $('#catalyt').val(modelContext['basic']['catalysts']);
      setTimeout(function() {
        $('#generate-button').click();
        $('#accumulation-select').val(modelContext['description']['accumulation']).trigger('change');
        $('#flow-pattern-select').val(modelContext['description']['flow_pattern']).trigger('change');
        $('#molecular-transport-select').val(modelContext['description']['molecular_transport']).trigger('change');
        $.each(modelContext['description']['model_law'], function(parameter, law) {
          $('#' + parameter.replaceAll('_', '-').toLowerCase() + '-law-select').val(law).trigger('change');
        });
        $.each(modelContext['basic']['reactions'], function(index, reaction) {
          $('#reaction-card-' + index.toString()).find('.reaction-select').val(
            $.map(modelContext['description']['reaction'][reaction], (x) => {return x})
          ).trigger('change');
        });
        $.each(modelContext['information']['species'], function(parameterName, parameterValue) {
          $('.species-info-parameter').each(function(_, parameterDiv) {
            if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
              $(parameterDiv).find('.parameter-value input').each(function(index, parameterInput){
                $(parameterInput).val(parameterValue[modelContext['basic']['species'][index]]);
              });
            }
          });
        });
        $.each(modelContext['information']['reactor'], function(parameterName, parameterValue) {
          $('.reactor-info-parameter').each(function(_, parameterDiv) {
            if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
              $(parameterDiv).find('input').val(parameterValue);
            }
          });
        });
        $.each(Object.keys(modelContext['information']['streams']), function(streamIndex, stream) {
          var streamValue = modelContext['information']['streams'][stream];
          var streamInfoCard = $('#stream-info-card-' + streamIndex.toString());
          $(streamInfoCard).find('.stream-info-state-select').val(streamValue['state']).trigger('change');
          $(streamInfoCard).find('.stream-info-solvent-select').val(streamValue['solvent']);
          $(streamInfoCard).find('.stream-info-reaction-select').val(streamValue['reactions']).trigger('change');
          $.each(streamValue, function(parameterName, parameterValue) {
            $(streamInfoCard).find('.stream-info-parameter').each(function(_, parameterDiv) {
              if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
                $(parameterDiv).find('input').val(parameterValue);
              }
            });
          });
        });
        $.each(Object.keys(modelContext['information']['reactions']), function(reactionIndex, reaction) {
          var reactionValue = modelContext['information']['reactions'][reaction];
          var reactionInfoCard = $('#reaction-info-card-' + reactionIndex.toString());
          $.each(reactionValue, function(parameterName, parameterValue) {
            $(reactionInfoCard).find('.reaction-info-species-parameter').each(function(_, parameterDiv) {
              if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
                $(parameterDiv).find('.parameter-value').children().each(function(_, parameterSpeciesInputDiv){
                  $(parameterSpeciesInputDiv).find('input').val(parameterValue[$(parameterSpeciesInputDiv).children(':eq(0)').html()]);
                });
              }
            });
            $(reactionInfoCard).find('.reaction-info-solvent-parameter').each(function(_, parameterDiv) {
              if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
                $(parameterDiv).find('.parameter-value').children().each(function(_, parameterSolventInputDiv){
                  $(parameterSolventInputDiv).find('input').val(parameterValue[$(parameterSolventInputDiv).children(':eq(0)').html()]);
                });
              }
            });
            $(reactionInfoCard).find('.reaction-info-parameter').each(function(_, parameterDiv) {
              if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
                $(parameterDiv).find('input').val(parameterValue);
              }
            });
            $(reactionInfoCard).find('.reaction-info-specific-law').each(function(_, LawDiv) {
              if ($(LawDiv).find('.law-phenomenon').text().substring(4).replaceAll(' ', '_') == parameterName) {
                $(LawDiv).find('textarea').val(parameterValue);
              }
            });
          });
        });
        $('#exploration-generate-button').click();
        $.each(modelContext['information']['model_law_parameters'], function(law, lawDict) {
          $.each($('.model-law-parameter-div'), function(_, lawDiv) {
            if ($(lawDiv).attr('law') == law) {
              $.each(lawDict, function(parameter, value) {
                $.each($(lawDiv).find('.model-law-parameter-line'), function(_, line) {
                  if ($(line).attr('parameter') == parameter) {
                    $(line).find('.init').val(value["init"]);
                    $(line).find('.min').val(value["min"]);
                    $(line).find('.max').val(value["max"]);
                  }
                });
              })
            }
          });
        });
        $('#reaction-parameter').val(modelContext['information']['reaction_parameters']).trigger('change');
        $.each(modelContext['information']['reactions'], function(reaction, reactionDict) {
          $.each(reactionDict, function(parameter, parameterDict) {
            $.each(parameterDict, function(s, value) {
              $.each($('.reaction-parameter-line'), function(_, line) {
                if ($(line).attr('parameter') == parameter && $(line).attr('reaction') == reaction && $(line).attr('solvent') == s) {
                  $(line).find('.init').val(value["init"]);
                  $(line).find('.min').val(value["min"]);
                  $(line).find('.max').val(value["max"]);
                }
                if ($(line).attr('parameter') == parameter && $(line).attr('reaction') == reaction && $(line).attr('species') == s) {
                  $(line).find('.init').val(value["init"]);
                  $(line).find('.min').val(value["min"]);
                  $(line).find('.max').val(value["max"]);
                }
              });
            });
          });
        });
      }, 100);
    }

    function getModelContext() {
      var species = $('#species').val().split(',');
      var reactions = $('#reaction').val().split(',');
      var streams = $('#stream').val().split(',');
      var solvents = $('#solvent').val().split(',');
      var accumulationPhenomenon = $('#accumulation-select').val();
      accumulationPhenomenon = accumulationPhenomenon ? accumulationPhenomenon.replaceAll(' ', '_') : accumulationPhenomenon;
      var flowPatternPhenomena = $('#flow-pattern-select').val()
      flowPatternPhenomena = flowPatternPhenomena ? flowPatternPhenomena.map((x) => {return x.replaceAll(' ', '_');}) : flowPatternPhenomena;
      var molecularTransportPhenomena = $('#molecular-transport-select').val().map((x) => {return x.replaceAll(' ', '_')});
      var modelLaw = {};
      $('.model-law').each(function(_, law) {
        modelLaw[$(law).attr('parameter')] = $(law).val();
      });
      var reactionPhenomena = {};
      $(reactions).each(function(index, reaction) {
        reactionPhenomena[reactions[index]] = $('#reaction-card-' + index.toString()).find('.reaction-select').val().map((x) => {return x.replaceAll(' ', '_')});
      })

      var speciesParameter = {}
      $('.species-info-parameter[style*="display: flex"]').each(function(_, parameter) {
        var p = $(parameter).find('.parameter-name').text().replaceAll(' ', '_');
        var v = {};
        $(parameter).find('.parameter-value').children().each(function (_, div) {
          v[$(div).children(':eq(0)').html()] = parseFloat($(div).children(':eq(1)').val());
        })
        speciesParameter[p] = v;
      })
      var reactorParameter = {};
      $('.reactor-info-parameter[style*="display: flex"]').each(function(_, parameter) {
        var p = $(parameter).find('.parameter-name').text().replaceAll(' ', '_');
        var v = parseFloat($(parameter).find('input').val());
        reactorParameter[p] = v;
      })
      var modelLawParameter = {};
      $.each($('.model-law-parameter-div'), function(_, lawDiv) {
        if ($(lawDiv).css('display') != 'none') {
          modelLawParameter[$(lawDiv).attr('law')] = {};
          $.each($(lawDiv).find('.model-law-parameter-line'), function(_, parameter) {
            modelLawParameter[$(lawDiv).attr('law')][$(parameter).attr('parameter')] = {
              init: parseFloat($(parameter).find('.init').val()),
              min: parseFloat($(parameter).find('.min').val()),
              max: parseFloat($(parameter).find('.max').val()),
            };
          });
        }
      })
      var streamParameter = {};
      $('#stream-info-cards').children().each(function(_, streamInfoCard) {
        var stream = $.trim($(streamInfoCard).find('.card-title').text().split(':').slice(-1));
        var streamDict = {};
        streamDict['state'] = $(streamInfoCard).find('.stream-info-state-select').val();
        streamDict['solvent'] = $(streamInfoCard).find('.stream-info-solvent-select').val();
        streamDict['reactions'] = $(streamInfoCard).find('.stream-info-reaction-select').val().map((x) => {return x.replaceAll('&gt;', '>')});
        $(streamInfoCard).find('.stream-info-parameter[style*="display: flex"]').each(function(_, elem) {
          streamDict[$(elem).find('.parameter-name').text().replaceAll(' ', '_')] = parseFloat($(elem).find('input').val());
        });
        streamParameter[stream] = streamDict;
      });
      var reactionParameter = {};
      $.each($('.reaction-parameter-line'), function(_, reactionParameterLine) {
        var reaction = $(reactionParameterLine).attr('reaction');
        var parameter = $(reactionParameterLine).attr('parameter');
        var species = $(reactionParameterLine).attr('species');
        var solvent = $(reactionParameterLine).attr('solvent');
        if (!reactionParameter[reaction]) {
          reactionParameter[reaction] = {};
        }
        if (!reactionParameter[reaction][parameter]) {
          reactionParameter[reaction][parameter] = {};
        }
        if (species) {
          reactionParameter[reaction][parameter][species] = {
            init: parseFloat($(reactionParameterLine).find('.init').val()),
            min: parseFloat($(reactionParameterLine).find('.min').val()),
            max: parseFloat($(reactionParameterLine).find('.max').val()),
          };
        }
        if (solvent) {
          reactionParameter[reaction][parameter][solvent] = {
            init: parseFloat($(reactionParameterLine).find('.init').val()),
            min: parseFloat($(reactionParameterLine).find('.min').val()),
            max: parseFloat($(reactionParameterLine).find('.max').val()),
          };
        }
      })

      var model_context = {
        'method': 'top-down-exploration',
        'basic': {
          'species': species,
          'reactions': reactions,
          'streams': streams,
          'solvents': solvents,
        },
        'description': {
          'accumulation': accumulationPhenomenon,
          'flow_pattern': flowPatternPhenomena,
          'molecular_transport': molecularTransportPhenomena,
          'model_law': modelLaw,
          'reaction': reactionPhenomena,
        },
        'information': {
          'species': speciesParameter,
          'reactor': reactorParameter,
          'model_law_parameters': modelLawParameter,
          'streams': streamParameter,
          'reactions': reactionParameter,
        }
      };
      return model_context;
    }

    function getParameter() {
      var parameterDict = {
        'law': {}, 
        'reaction': {'key': [], 'init': [], 'min': [], 'max': []}
      }
      $.each($('.model-law-parameter-div'), function(_, lawParameterDiv) {
        if ($(lawParameterDiv).css('display') != 'none') {
          var lawParameterDict = {'key': [], 'init': [], 'min': [], 'max': []};
          $(lawParameterDiv).find('.model-law-parameter-line').map(function(_, line) {
            var parameter = $(line).find('.parameter-line-name-symbol-unit').children(':eq(0)').text().replaceAll(' ', '_').trim();
            var reaction = $(line).attr('reaction') ? $(line).attr('reaction') : null;
            var species = $(line).attr('species') ? $(line).attr('species') : null;
            var solvent = $(line).attr('solvent') ? $(line).attr('solvent') : null;
            var init = parseFloat($(line).find('.init').val());
            var min = parseFloat($(line).find('.min').val());
            var max = parseFloat($(line).find('.max').val());
            lawParameterDict['key'].push([parameter, species, reaction, null, solvent]);
            lawParameterDict['init'].push(init);
            lawParameterDict['min'].push(min);
            lawParameterDict['max'].push(max);
          });
          parameterDict['law'][$(lawParameterDiv).attr('law')] = lawParameterDict;
        }
      });
      $('.reaction-parameter-line').map(function(_, line) {
        var parameter = $(line).find('.parameter-line-name-symbol-unit').children(':eq(0)').text().replaceAll(' ', '_').trim();
        var reaction = $(line).attr('reaction') ? $(line).attr('reaction') : null;
        var species = $(line).attr('species') ? $(line).attr('species') : null;
        var solvent = $(line).attr('solvent') ? $(line).attr('solvent') : null;
        var init = parseFloat($(line).find('.init').val());
        var min = parseFloat($(line).find('.min').val());
        var max = parseFloat($(line).find('.max').val());
        parameterDict['reaction']['key'].push([parameter, species, reaction, null, solvent]);
        parameterDict['reaction']['init'].push(init);
        parameterDict['reaction']['min'].push(min);
        parameterDict['reaction']['max'].push(max);
      });
      return parameterDict;
    }

    function getData(includeOutletStream) {
      var rawData = table.getData();
      var data = [];
      $.each(rawData, function(_, line) {
        data.push($(line).map(function(_, value) {
          return value ? parseFloat(value) : value;
        }).toArray());
      });
      var tableHeader = table.copy(false, table.options.csvDelimiter, true, true, true).split('\r\n').slice(0, 2);
      tableHeader = tableHeader.map(line => line.split(','));
      tableHeader.push($(table.thead).find('tr:last td:gt(0)').map(function(index, elem) {return $(elem).attr('title');}).toArray());
      $(tableHeader[0]).each(function(i, s) {
        if (s in symbol2parameter) {
          tableHeader[0][i] = symbol2parameter[s];
        } else {
          tableHeader[0][i] = tableHeader[0][i-1];
        }
      });
      $(tableHeader[1]).each(function(i, s) {
        if (!s) {tableHeader[1][i] = tableHeader[1][i-1];}
        if (s == '-') {tableHeader[1][i] = null;}
      });
      $(tableHeader[2]).each(function(i, s) {if (s == '-') {tableHeader[2][i] = null;}});
      if (!includeOutletStream) {
        $(data).each(function(i, d) {data[i] = $.grep(d, function(e, j) {return tableHeader[1][j] != 'Outlet stream'})});
        tableHeader[0]= $.grep(tableHeader[0], function(e, i) {return tableHeader[1][i] != 'Outlet stream'});
        tableHeader[2]= $.grep(tableHeader[2], function(e, i) {return tableHeader[1][i] != 'Outlet stream'});
        tableHeader[1]= $.grep(tableHeader[1], function(e, i) {return tableHeader[1][i] != 'Outlet stream'});
      }
      var parameterKey = $(tableHeader[0]).map(function(i, e) {return Array([tableHeader[0][i], tableHeader[2][i], null, tableHeader[1][i], null])}).toArray();
      var parameterValue = data;
      return {'key': parameterKey, 'value': parameterValue};
    }
    
    function convertParameterSymbol(symbol) {
      symbol = symbol.replaceAll('\n', '');
      symbol = symbol.replaceAll(' ', '');
      var subReg = new RegExp('<msub>[^<>]*?<mi>([^<>]*?)<\/mi>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<\/msub>');
      symbol = symbol.replace(subReg, '$1<sub>$2</sub>');
      var subReg = new RegExp('<msub>[^<>]*?<mi>([^<>]*?)<\/mi>[^<>]*?<msub><mtext>([^<>]*?)<\/mtext>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<\/msub>[^<>]*?<\/msub>');
      symbol = symbol.replace(subReg, '$1<sub>$2<sub>$3</sub></sub>');
      symbol = symbol.replace('<math>', '');
      symbol = symbol.replace('</math>', '');
      symbol = symbol.replace('<mrow>', '');
      symbol = symbol.replace('</mrow>', '');
      symbol = symbol.replace('<mtext>', '');
      symbol = symbol.replace('</mtext>', '');
      symbol = symbol.replace('<mi>', '');
      symbol = symbol.replace('</mi>', '');
      symbol = symbol.trim();
      return symbol;
    }
    function convertUnitSymbol(symbol) {
      symbol = symbol.replaceAll('\n', '');
      symbol = symbol.replaceAll(' ', '');
      var subReg = new RegExp('<msup>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<mn>([^<>]*?)<\/mn>[^<>]*?<\/msup>');
      symbol = symbol.replace(subReg, '$1<sup>$2</sup>');
      var subReg = new RegExp('<msup>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<mtext>([^<>]*?)<\/mtext>[^<>]*?<\/msup>');
      symbol = symbol.replace(subReg, '$1<sup>$2</sup>');
      symbol = symbol.replaceAll('<math>', '');
      symbol = symbol.replaceAll('</math>', '');
      symbol = symbol.replaceAll('<mtext>', '');
      symbol = symbol.replaceAll('</mtext>', '');
      return symbol
    }    

    var table = null;
    var tableOriginalWidth;
    var minColumnWidth = 70;
    var tableMaxHeight = '400px';
    var symbol2parameter = {};
    symbol2parameter['c'] = 'Outlet_Concentration';
    function getElementWidth(text, minWidth) {
      $('body').append($('<span id="text-width">' + text + '</span>'));
      var width = $('#text-width')[0].getBoundingClientRect().width;
      $('#text-width').remove();
      return Math.max(width + 10, minWidth);
    }
    function loadInputSheet(modelContext, data) {
      var species = modelContext['basic']['species'];
      var liquidStreams = [], gaseousStreams = [];
      $.each(modelContext['information']['streams'], function(stream, streamDict) {
        if (streamDict['state'] == 'liquid') {
          liquidStreams.push(stream)
        }
        if (streamDict['state'] == 'gaseous') {
          gaseousStreams.push(stream)
        }
      });

      var phenomena = [];
      phenomena.push(modelContext['description']['accumulation']);
      phenomena = phenomena.concat(modelContext['description']['flow_pattern']);
      phenomena = phenomena.concat(modelContext['description']['molecular_transport']);
      $.each(modelContext['description']['reaction'], function(_, reactionPhenomena) { phenomena = phenomena.concat(reactionPhenomena); });
      phenomena = Array.from(new Set(phenomena));
      var operatingParameters = [];
      $.each(Object.assign({}, entity['law'], entity['definition']), function(law, lawDict) {
        if (phenomena.includes(lawDict['phenomenon'])) {
          $.each(lawDict['model_variables'], function(_, modelVariable) {
            if (entity['model_variable'][modelVariable]['class'] == 'OperatingParameter') {
              operatingParameters.push(modelVariable);
            }
          });
        }
      });
      operatingParameters = Array.from(new Set(operatingParameters));

      var tableMaxHeight = '400px';
      data = data ? data : [[]];
      var columns = [];
      var nestedHeaders = [[], []];
      $.each(operatingParameters, function(_, parameter) {
        var parameterDimensions = entity['model_variable'][parameter]['dimensions'];
        var symbol = entity['model_variable'][parameter]['symbol'];
        var unit = entity['model_variable'][parameter]['unit']
        if (unit) {
          symbol = convertParameterSymbol(symbol) + ' (' + convertUnitSymbol(entity['unit'][unit]['symbol']) + ')';
        } else {
          symbol = convertParameterSymbol(symbol);
        }
        symbol2parameter[symbol] = parameter;
        if (!parameterDimensions.includes('Stream') & !parameterDimensions.includes('Species')) {
          columns.push({'title': '-', 'width': getElementWidth(symbol, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
          nestedHeaders[0].push({'title': symbol, 'colspan': '1'});
          nestedHeaders[1].push({'title': '-', 'colspan': '1'});
        }
      });
      $.each(operatingParameters, function(_, parameter) {
        var parameterDimensions = entity['model_variable'][parameter]['dimensions'];
        var symbol = entity['model_variable'][parameter]['symbol'];
        var unit = entity['model_variable'][parameter]['unit']
        if (unit) {
          symbol = convertParameterSymbol(symbol) + ' (' + convertUnitSymbol(entity['unit'][unit]['symbol']) + ')';
        } else {
          symbol = convertParameterSymbol(symbol);
        }
        symbol2parameter[symbol] = parameter;
        if (parameterDimensions.includes('Stream') & !parameterDimensions.includes('Species')) {
          if (!parameter.includes('Gas')) {
            $.each(liquidStreams, function(_, stream) {
              columns.push({'title': '-', 'width': getElementWidth(stream, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
              nestedHeaders[1].push({'title': stream, 'colspan': '1'});
            });
            nestedHeaders[0].push({'title': symbol, 'colspan': liquidStreams.length.toString()});
          }
          if (parameter.includes('Gas')) {
            $.each(gaseousStreams, function(_, stream) {
              columns.push({'title': '-', 'width': getElementWidth(stream, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
              nestedHeaders[1].push({'title': stream, 'colspan': '1'});
            });
            nestedHeaders[0].push({'title': symbol, 'colspan': gaseousStreams.length.toString()});
          }
        }
      });
      $.each(operatingParameters, function(_, parameter) {
        var parameterDimensions = entity['model_variable'][parameter]['dimensions'];
        var symbol = entity['model_variable'][parameter]['symbol'];
        var unit = entity['model_variable'][parameter]['unit']
        if (unit) {
          symbol = convertParameterSymbol(symbol) + ' (' + convertUnitSymbol(entity['unit'][unit]['symbol']) + ')';
        } else {
          symbol = convertParameterSymbol(symbol);
        }
        symbol2parameter[symbol] = parameter;
        if (parameterDimensions.includes('Stream') & parameterDimensions.includes('Species')) {
          if (!parameter.includes('Gas')) {
            $.each(liquidStreams, function(_, stream) {
              $.each(species, function(_, s) {
                columns.push({'title': s, 'width': getElementWidth(s, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
              });
              nestedHeaders[1].push({'title': stream, 'colspan': species.length.toString()});
            });
            nestedHeaders[0].push({'title': symbol, 'colspan': (liquidStreams.length * species.length).toString()});
          }
        }
      });
      $.each(species, function(_, s) {
        columns.push({'title': s, 'width': getElementWidth(s, minColumnWidth), 'type': 'number', 'options': {'notation': 'compact'}});
      })
      nestedHeaders[1].push({'title': 'Outlet stream', 'colspan': species.length.toString()});
      nestedHeaders[0].push({'title': 'c (mol/L)', 'colspan': species.length.toString()});
      let table = jspreadsheet(document.getElementById('input'), {
        data: data,
        csvFileName: 'data',
        columns: columns,
        columnResize: false,
        tableOverflow: true,
        allowRenameColumn: false,
        allowDeleteColumn: false,
        allowInsertColumn: false,
        nestedHeaders: nestedHeaders,
        includeHeadersOnDownload: true,
      });
      $(table.content).css('box-shadow', '');
      $(table.content).css('max-height', tableMaxHeight);
      $(table.thead).find('td').each(function(index, elem) {
        if (index > 0) {
          var symbol = $('<span>' + $(elem).text() + '</span>');
          $(elem).text(null);
          $(elem).append(symbol);
        }
      })
      tableOriginalWidth = $('#input')[0].getBoundingClientRect().width + 4;
      return table;
    }

    $(document).on('change', '#import', function() {
      if ($('#import').val() == 'local') {
        $('#local-path').css('display', 'flex');
        $('#website-case').parent().css('display', 'none');
      }
      if ($('#import').val() == 'website') {
        $('#local-path').css('display', 'none');
        $('#website-case').parent().css('display', 'flex');
      }
    });
    setTimeout(function() {$('#import').val('website').trigger('change');}, 100);

    function resizeTable() {
      if (table) {
        let cardWidth = $('#input').parent()[0].getBoundingClientRect().width;
        if (cardWidth - 100 < tableOriginalWidth) {
          table.content.style['overflow-x'] = 'auto';
          table.content.style.width = (cardWidth - 100).toString() + 'px';
        } else {
          table.content.style['overflow-x'] = null;
          table.content.style.width = tableOriginalWidth.toString() + 'px';
        }
      }
    }
    $('#pushmenu-btn').click(function() {setTimeout(resizeTable, 400);});
    $(window).resize(resizeTable);
    $(window).trigger('resize');

    var dataText = null;
    function validateText(dataText) {
      var dataHeaderText = dataText.split('\r\n').slice(0, 3).join('\r\n');
      var tableHeaderText = table.copy(false, table.options.csvDelimiter, true, true, true).split('\r\n').slice(0, 3).join('\r\n');
      return dataHeaderText == tableHeaderText;
    }
    $(document).on('click', '#save-btn', function() {table.download();})
    $(document).on('change', '#local-path', function(e) {
      var file = e.target.files[0];
      var reader = new FileReader();
      reader.onload = function(e) {
        dataText = e.target.result;
      }
      reader.readAsText(file);
    })
    $(document).on('click', '#import-btn', function() {
      if ($('#import').val() == 'local') {
        if ($('#local-path')[0].files.length == 0) {
          alert('Select data path!');
        } else {
          $('#local-path').trigger('change');
          if (validateText(dataText)) {
            var lines = dataText.split('\r\n').slice(3);
            var data = lines.map(line => line.split(',').map(x => isNaN(parseFloat(x)) ? null : parseFloat(x)));
            table.setData(data);
          } else {
            alert('Table header not match!');
          }
        }
      } else {
        $.get(
          '{{ url_for("home.case_file", filepath="") }}' + $('#website-case').val(),
          function (dataText) {
            if (validateText(dataText)) {
              var lines = dataText.split('\r\n').slice(3);
              var data = lines.map(line => line.split(',').map(x => isNaN(parseFloat(x)) ? null : parseFloat(x)));
              table.setData(data);
            } else {
              alert('Table header not match!');
            }
          }
        ).fail(function(jqXHR, textStatus, errorThrown) {
          console.error('Data unavailable!');
        })
      }
    })

    $(document).on('click', '.select2', function() {
      $('.select2-container--open').find('li').each(function(_, li) {
        if ($(li).find('span').length == 0) {
          var text = '<span>' + $(li).text() + '</span>';
          $(li).html(null);
          $(li).append($(text));
        }
      })
    });

    $(document).on('click', '.select2-selection__choice__remove', function() {
      $('.select2-container--open').find('li').each(function(_, li) {
        if ($(li).find('span').length == 0) {
          var text = '<span>' + $(li).text() + '</span>';
          $(li).html(null);
          $(li).append($(text));
        }
      })
    });

    // function initReactionParamterSelect() {
    //   var parameters = [];
    //   var parameterSymbols = [];
    //   $.each($('#reaction').val().split(','), function(index, reaction) {
    //     $.each($('#reaction-card-' + index.toString() + ' .reaction-select').val(), function(_, phenomenon) {
    //       $.each(entity['law'], function(law, lawDict) {
    //         if (lawDict['phenomenon'] == phenomenon.replaceAll(' ', '_')) {
    //           $.each(lawDict['model_variables'], function(_, parameter) {
    //             if (entity['model_variable'][parameter]['class'] == 'ReactionParameter' && !parameters.includes(parameter)) {
    //               var symbol = entity['model_variable'][parameter]['symbol'];
    //               var parameterSymbol = parameter.replaceAll('_', ' ') + '&nbsp;' + symbol;
    //               parameters.push(parameter);
    //               parameterSymbols.push(parameterSymbol);
    //             }
    //           });
    //         }
    //       });
    //     })
    //   })
    //   var parameterData = [];
    //   $.each($(parameters), function(index, parameter) {
    //     parameterData.push({id: parameter, text: parameterSymbols[index]});
    //   });
    //   var parentElem = $('#reaction-parameter').parent();
    //   $('#reaction-parameter').remove();
    //   var select = $('<select></select>')
    //   $(select).addClass('select2');
    //   $(select).attr('id', 'reaction-parameter');
    //   $(select).attr('multiple', 'multiple');
    //   $(select).attr('style', 'width: 600px;');
    //   $(select).attr('data-placeholder', 'Select parameters');
    //   $(select).select2({data: parameterData});
    //   parentElem.append(select);
    //   $('#reaction-parameter').select2();
    //   $('#reaction-parameter').trigger('change');

    //   $(document).on('change', '#reaction-parameter', function() {
    //     $(this).next().find('.select2-selection__choice').each(function(_, li) {
    //       if ($(li).find('span').length == 1) {
    //         var remove = $(li).children()[0];
    //         var text = '<span>' + $(li).text().slice(1) + '</span>';
    //         $(li).html(null);
    //         $(li).append($(remove));
    //         $(li).append($(text));
    //       }
    //     })
    //   });

    //   $(document).on('change', '#reaction-parameter', function() {
    //     var selectedParameters = $('#reaction-parameter').val();
    //     if (selectedParameters.length > 0) {
    //       var selectedParameterSymbols = $(selectedParameters).map(function(_, parameter) {
    //         return parameter.replaceAll('_', ' ') + '&nbsp;' + convertParameterSymbol(entity['model_variable'][parameter]['symbol']);
    //       }).toArray().join(',&nbsp;');
    //       $('#reaction-parameter').next().find('.filter-option-inner-inner').html(selectedParameterSymbols);
    //     } else {
    //       $('#reaction-parameter').next().find('.filter-option-inner-inner').text('Select parameters');
    //     }
    //   });
    // }
    // $(document).on('click', '#exploration-generate-button', initReactionParamterSelect);

    function createReactionParameterForm() {
      var parameters = [];
      $.each($('#reaction').val().split(','), function(index, reaction) {
        $.each($('#reaction-card-' + index.toString() + ' .reaction-select').val(), function(_, phenomenon) {
          $.each(entity['law'], function(law, lawDict) {
            if (lawDict['phenomenon'] == phenomenon.replaceAll(' ', '_')) {
              $.each(lawDict['model_variables'], function(_, parameter) {
                if (entity['model_variable'][parameter]['class'] == 'ReactionParameter' && !parameters.includes(parameter)) {
                  var symbol = entity['model_variable'][parameter]['symbol'];
                  parameters.push(parameter);
                }
              });
            }
          });
        })
      })

      const eqSet = (xs, ys) => xs.size === ys.size && [...xs].every((x) => ys.has(x));
      $('#reaction-parameter-form').find('.reaction-parameter-line').remove();
      if (parameters.length == 0) {
        $('#reaction-parameter-header').css('display', 'none');
      } else {
        $('#reaction-parameter-header').css('display', 'flex');
      }
      $.each(parameters, function(_, parameter) {
        var parameterDimensionSet = new Set(entity['model_variable'][parameter]['dimensions']);
        if (eqSet(parameterDimensionSet, new Set(['Reaction', 'Solvent']))) {
          $.each($('#reaction').val().split(','), function(index, reaction) {
            var reactionLaws = [];
            $.each($('#reaction-card-' + index.toString()).find('.reaction-select').val(), function(_, phenomenon) {
              $.each(entity['law'], function(law, lawDict) {
                if (lawDict['phenomenon'] == phenomenon) {
                  reactionLaws.push(law);
                }
              });
            });
            if (reactionLaws) {
              $.each($('#solvent').val().split(','), function(_, solvent) {
                var parameterLine = $('#reaction-parameter-line-template').clone();
                $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(0)').text(parameter.replaceAll('_', ' '));
                $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(1)').html(entity['model_variable'][parameter]['symbol']);
                if (entity['model_variable'][parameter]['unit']) {
                  $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(2)').html(entity['unit'][entity['model_variable'][parameter]['unit']]['symbol']);
                }
                $(parameterLine).find('.parameter-line-reaction').children(':eq(0)').html(reaction);
                $(parameterLine).find('.parameter-line-solvent').children(':eq(0)').text(solvent);
                $(parameterLine).removeAttr('id');
                $(parameterLine).addClass('reaction-parameter-line');
                $(parameterLine).attr('parameter', parameter);
                $(parameterLine).attr('reaction', reaction);
                $(parameterLine).attr('solvent', solvent);
                $(parameterLine).css('display', 'flex');
                $('#reaction-parameter-form').append(parameterLine);
              });
            }
          });
        }
        if (eqSet(parameterDimensionSet, new Set(['Reaction', 'Species']))) {
          $.each($('#reaction').val().split(','), function(index, reaction) {
            var reactionLaws = [];
            $.each($('#reaction-card-' + index.toString()).find('.reaction-select').val(), function(_, phenomenon) {
              $.each(entity['law'], function(law, lawDict) {
                if (lawDict['phenomenon'] == phenomenon) {
                  reactionLaws.push(law);
                }
              });
            });
            if (reactionLaws) {
              $.each($('#species').val().split(','), function(_, species) {
                if (reaction.split(' > ')[0].includes(species)) {
                  var parameterLine = $('#reaction-parameter-line-template').clone();
                  $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(0)').text(parameter.replaceAll('_', ' '));
                  $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(1)').html(entity['model_variable'][parameter]['symbol']);
                  if (entity['model_variable'][parameter]['unit']) {
                    $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(2)').html(entity['unit'][entity['model_variable'][parameter]['unit']]['symbol']);
                  }
                  $(parameterLine).find('.parameter-line-reaction').children(':eq(0)').html(reaction);
                  $(parameterLine).find('.parameter-line-species').children(':eq(0)').html(species);
                  $(parameterLine).removeAttr('id');
                  $(parameterLine).addClass('reaction-parameter-line');
                  $(parameterLine).attr('parameter', parameter);
                  $(parameterLine).attr('reaction', reaction);
                  $(parameterLine).attr('species', species);
                  $(parameterLine).css('display', 'flex');
                  $('#reaction-parameter-form').append(parameterLine);
                }
              });
            }
          });
        }
      });
    }
    $(document).on('click', '#exploration-generate-button', createReactionParameterForm);

    function createModelLawParameterForm() {
      const eqSet = (xs, ys) => xs.size === ys.size && [...xs].every((x) => ys.has(x));
      $('.model-law-parameter-div').css('display', 'none');
      $('.model-law-parameter-line').remove();
      $.each($('.model-law'), function(_, modelLaw) {
        $.each($(modelLaw).val(), function(_, law) {
          $.each($('.model-law-parameter-div'), function(_, parameterDiv) {
            if ($(parameterDiv).attr('law') == law) {
              $(parameterDiv).css('display', '');
              $.each(entity['law'][law]['model_variables'], function(_, parameter) {
                if (entity['model_variable'][parameter]['class'] == 'MolecularTransportParameter') {
                  var parameterDimensions = new Set(entity['model_variable'][parameter]['dimensions']);
                  if (eqSet(parameterDimensions, new Set([]))) {
                    var parameterLine = $('#model-law-parameter-line-template').clone(true, true);
                    $(parameterLine).removeAttr('id');
                    $(parameterLine).addClass('model-law-parameter-line');
                    $(parameterLine).css('display', 'flex');
                    $(parameterLine).attr('parameter', parameter);
                    $(parameterLine).find('.parameter-line-name-symbol-unit').find('span:eq(0)').text(parameter.replaceAll('_', ' '));
                    $(parameterLine).find('.parameter-line-name-symbol-unit').find('span:eq(1)').html(entity['model_variable'][parameter]['symbol']);
                    if (entity['model_variable'][parameter]['unit']) {
                      $(parameterLine).find('.parameter-line-name-symbol-unit').find('span:eq(2)').html(entity['unit'][entity['model_variable'][parameter]['unit']]['symbol']);
                    }
                    $(parameterDiv).append(parameterLine);
                  }
                }
              })
            }
          });
        });
      });

      // const eqSet = (xs, ys) => xs.size === ys.size && [...xs].every((x) => ys.has(x));
      // $('#parameter-form').find('.parameter-law').remove();
      // $('#parameter-form').find('.parameter-header').remove();
      // $('#parameter-form').find('.parameter-line').remove();
      
      // var parameters = $('#reaction-parameter').val();
      // if (parameters.length == 0) {
      //   $('#parameter-header').css('display', 'none');
      // } else {
      //   $('#parameter-header').css('display', 'flex');
      // }
      // var dimensionSets = [
      //   new Set([]),
      //   new Set(['Reaction', 'Solvent']),
      //   new Set(['Reaction', 'Species']),
      //   new Set(['Solvent', 'Species']),
      //   new Set(['Species']),
      // ];
      // $(dimensionSets).each(function(_, dimensionSet) {
      //   $(parameters).each(function(_, parameter) {
      //     var parameterDimensionSet = new Set(entity['model_variable'][parameter]['dimensions']);
      //     if (eqSet(parameterDimensionSet, dimensionSet)) {
      //       if (eqSet(dimensionSet, new Set([]))) {
      //         var parameterLine = $('#parameter-line-template').clone();
      //         $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(0)').text(parameter.replaceAll('_', ' '));
      //         $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(1)').html(entity['model_variable'][parameter]['symbol']);
      //         if (entity['model_variable'][parameter]['unit']) {
      //           $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(2)').html(entity['unit'][entity['model_variable'][parameter]['unit']]['symbol']);
      //         }
      //         if (entity['model_variable'][parameter]['unit'])
      //         $(parameterLine).removeAttr('id');
      //         $(parameterLine).addClass('parameter-line');
      //         $(parameterLine).css('display', 'flex');
      //         var initValue = parseFloat(modelContext['information']['molecular_transport'][parameter]);
      //         if (initValue) {$(parameterLine).find('input:eq(0)').val(initValue);}
      //         $('#parameter-form').append(parameterLine);
      //       }
      //       if (eqSet(dimensionSet, new Set(['Reaction', 'Solvent']))) {
      //         $(modelContext['basic']['reactions']).each(function(_, reaction) {
      //           $(modelContext['basic']['solvents']).each(function(_, solvent) {
      //             if ((parameter in modelContext['information']['reactions'][reaction]) && (solvent in modelContext['information']['reactions'][reaction][parameter])) {
      //               var parameterLine = $('#parameter-line-template').clone();
      //               $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(0)').text(parameter.replaceAll('_', ' '));
      //               $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(1)').html(entity['model_variable'][parameter]['symbol']);
      //               if (entity['model_variable'][parameter]['unit']) {
      //                 $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(2)').html(entity['unit'][entity['model_variable'][parameter]['unit']]['symbol']);
      //               }
      //               $(parameterLine).find('.parameter-line-reaction').children(':eq(0)').html(reaction);
      //               $(parameterLine).find('.parameter-line-solvent').children(':eq(0)').text(solvent);
      //               $(parameterLine).removeAttr('id');
      //               $(parameterLine).addClass('parameter-line');
      //               $(parameterLine).css('display', 'flex');
      //               var initValue = parseFloat(modelContext['information']['reactions'][reaction][parameter][solvent]);
      //               if (initValue) {$(parameterLine).find('input:eq(0)').val(initValue);}
      //               $('#parameter-form').append(parameterLine);
      //             }
      //           });
      //         });
      //       }
      //       if (eqSet(dimensionSet, new Set(['Reaction', 'Species']))) {
      //         $(modelContext['basic']['reactions']).each(function(_, reaction) {
      //           $(modelContext['basic']['species']).each(function(_, species) {
      //             if ((parameter in modelContext['information']['reactions'][reaction]) && (species in modelContext['information']['reactions'][reaction][parameter])) {
      //               var parameterLine = $('#parameter-line-template').clone();
      //               $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(0)').text(parameter.replaceAll('_', ' '));
      //               $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(1)').html(entity['model_variable'][parameter]['symbol']);
      //               if (entity['model_variable'][parameter]['unit']) {
      //                 $(parameterLine).find('.parameter-line-name-symbol-unit').children(':eq(2)').html(entity['unit'][entity['model_variable'][parameter]['unit']]['symbol']);
      //               }
      //               $(parameterLine).find('.parameter-line-reaction').children(':eq(0)').html(reaction);
      //               $(parameterLine).find('.parameter-line-species').children(':eq(0)').html(species);
      //               $(parameterLine).removeAttr('id');
      //               $(parameterLine).addClass('parameter-line');
      //               $(parameterLine).css('display', 'flex');
      //               var initValue = parseFloat(modelContext['information']['reactions'][reaction][parameter][species]);
      //               if (initValue) {$(parameterLine).find('input:eq(0)').val(initValue);}
      //               $('#parameter-form').append(parameterLine);
      //             }
      //           });
      //         });
      //       }
      //     }
      //   });
      // });
    }
    $(document).on('click', '#exploration-generate-button', createModelLawParameterForm);
  
    var simulationResult = [];
    var previousRMSEPoint = null;
    var previousProfilePoint = null;
    var previousStatisticsPoint = null;
    var previousParityPoint = null;
    function showTooltip(x, y, id, contents) {
      $('<div id="' + id + '">' + contents + '</div>').css({
        top: y,
        left: x,
      }).appendTo('body').fadeIn();
      $('#' + id).css('position', 'absolute');
      $('#' + id).css('padding', '5px');
      $('#' + id).css('border-radius', '5px');
      $('#' + id).css('background-color', 'white');
      $('#' + id).css('border', '1px solid #e1e1e1');
    }
    $('#rmse').bind('plothover', function(event, pos, item) {
      if (item) {
        if (previousRMSEPoint != item.dataIndex) {
          previousRMSEPoint = item.dataIndex;
          $('#rmse-tip').remove();
          var x = item.datapoint[0];
          var y = item.datapoint[1];
          showTooltip(item.pageX - 35, item.pageY - 40, 'rmse-tip', y.toFixed(6).toString());
        }
      } else {
        $('#rmse-tip').remove();
        previousRMSEPoint = null;
      }
    });
    $('#profile').bind('plothover', function(event, pos, item) {
      if (item) {
        if (previousProfilePoint != item.dataIndex) {
          previousProfilePoint = item.dataIndex;
          $('#profile-tip').remove();
          var x = item.datapoint[0];
          var y = item.datapoint[1];
          showTooltip(item.pageX + 20, item.pageY - 16, 'profile-tip', '(' + x.toFixed(6).toString() + ', ' + y.toFixed(6).toString() + ')');
        }
      } else {
        $('#profile-tip').remove();
        previousProfilePoint = null;
      }
    });
    $('#statistics').bind('plothover', function(event, pos, item) {
      if (item) {
        if (previousStatisticsPoint != item.dataIndex) {
          previousStatisticsPoint = item.dataIndex;
          $('#statistics-tip').remove();
          var x = item.datapoint[0];
          var y = item.datapoint[1];
          showTooltip(item.pageX - 35, item.pageY - 40, 'statistics-tip', y.toFixed(6).toString());
        }
      } else {
        $('#statistics-tip').remove();
        previousStatisticsPoint = null;
      }
    });
    $('#parity').bind('plothover', function(event, pos, item) {
      if (item) {
        if (previousParityPoint != item.dataIndex) {
          previousParityPoint = item.dataIndex;
          $('#parity-tip').remove();
          var x = item.datapoint[0];
          var y = item.datapoint[1];
          var index = item.dataIndex + 1;
          showTooltip(item.pageX + 20, item.pageY - 16, 'parity-tip', 'Sample ' + index.toString() + ': (' + x.toFixed(6).toString() + ', ' + y.toFixed(6).toString() + ')');
        }
      } else {
        $('#parity-tip').remove();
        previousParityPoint = null;
      }
    });
 
    var explorationResult = null;
    function plotRMSE() {
      if (!explorationResult) {return;}
      var RMSEData = [{'label': 'RMSE', 'data': []}];
      $.each(explorationResult['model_calibration_results'], function(index, result) {
        RMSEData[0]['data'].push([index, result['rmse']]);
      })
      var xtickLabels = $(explorationResult['model_calibration_results']).map((index) => (index + 1).toString()).toArray();
      $.plot($('#rmse'), 
          RMSEData, {
          series: {
            bars: {show: true, barWidth: 0.6, align: 'center'},
          },
          grid: {
            hoverable: true,
          },
          xaxis: {
            autoScale: 'none',
            min: -0.6,
            max: explorationResult['model_calibration_results'].length - 0.4,
            axisLabel: 'Model'
          },
          yaxis: {
            ticks:6,
            tickDecimals: 5,
            axisLabel: 'Concentration RMSE (mol/L)',
          },
          legend: {
            show: true,
          }
      });
      $('#rmse').find('.flot-x-axis text').each(function(_, elem) {
        if (parseFloat($(elem).text()) % 1 == 0) {
          var originalWidth = $(elem)[0].getBoundingClientRect().width;
          var label = '<tspan>' + xtickLabels[parseInt($(elem).text())] + '</tspan>';
          $(elem).html(label);
          var width = $(elem)[0].getBoundingClientRect().width;
          $(elem).attr('x', (parseFloat($(elem).attr('x')) + originalWidth / 2 - width / 2).toString());
        } else {
          $(elem).remove();
        }
      });
      var title_padding_left = $('#rmse').parent().find('.flot-y-axis')[0].getBoundingClientRect().width + $('#rmse').parent().find('.y1LabelLayer')[0].getBoundingClientRect().width;
      $('#rmse').parent().find('.plot-title').css('padding-left', title_padding_left);
    }

    function plotProfile() {
      if (simulationResult.length == 0) {return;}
      var sampleSimulationResult = simulationResult[parseInt($('#profile-sample').val())];
      var sampleSimulationVariableIndices = $('#profile-variable').val().map(x => {return parseInt(x);});
      var plotSampleSimulationVariableData = $(sampleSimulationResult).filter(function(index, elem) {
        return sampleSimulationVariableIndices.includes(index);
      }).toArray();
      if (plotSampleSimulationVariableData.length > 0) {
        var plot = $.plot('#profile',
          plotSampleSimulationVariableData, {
            series: {
              lines: {show: true, lineWidth: 2},
              points: {show: false},
            },
            grid: {
              hoverable: true,
            },
            xaxis: {
              ticks:6,
              tickDecimals: 4,
              axisLabel: modelContext['description']['accumulation'] == 'Continuous' ? 'x (m)' : 't (s)',
            },
            yaxis: {
              ticks:6,
              tickDecimals: 5,
              axisLabel: 'c (mol/L)',
            },
            legend: {
              show: true,
            }
          }
        );
      } else {
        $.plot('#profile', 
          [{}], {
            xaxis: {
              ticks: 6,
              axisLabel: modelContext['description']['accumulation'] == 'Batch' ? 't (s)' : 'x (m)',
            },
            yaxis: {
              ticks: 6,
              tickDecimals: 4,
              axisLabel: 'c (mol/L)',
            },
          }
        );
      }
      var title_padding_left = $('#profile').parent().find('.flot-y-axis')[0].getBoundingClientRect().width + $('#profile').parent().find('.y1LabelLayer')[0].getBoundingClientRect().width;
      $('#profile').parent().find('.plot-title').css('padding-left', title_padding_left);
    }
    $(document).on('change', '#profile-variable', plotProfile);

    function plotStatistics() {
      if (simulationResult.length == 0) {return;}
      var sampleSimulationResult = simulationResult[parseInt($('#statistics-sample').val())];
      var sampleSimulationStatisticsInletData = [];
      var sampleSimulationStatisticsOutletData = [];
      var sampleSimulationSpeciesIndices = $('#statistics-species').val().map(x => {return parseInt(x);});
      if (sampleSimulationSpeciesIndices.length < 2) {
        var minBarWidth = 1;
      } else {
        var minBarWidth = sampleSimulationResult.length - 1;
      }
      $(sampleSimulationResult.slice(sampleSimulationResult.length - modelContext['basic']['species'].length)).each(function(index, variable) {
        if (sampleSimulationSpeciesIndices.includes(index)) {
          sampleSimulationStatisticsInletData.push([index, variable['data'][0][1]]);
          sampleSimulationStatisticsOutletData.push([index, variable['data'][variable['data'].length - 1][1]]);
          if (sampleSimulationStatisticsInletData.length > 1) {
            var len = sampleSimulationStatisticsInletData.length;
            minBarWidth = Math.min(minBarWidth, sampleSimulationStatisticsInletData[len-1][0] - sampleSimulationStatisticsInletData[len-2][0]);
          }
        }
      });
      var sampleSimulationStatisticsData = [
        {'label': 'Inlet', 'data': sampleSimulationStatisticsInletData},
        {'label': 'Outlet', 'data': sampleSimulationStatisticsOutletData},
      ];
      var xtickLabels = $(modelContext['basic']['species']).map(function(_, label) {
        label = label.replaceAll(/<\/sub>([^<>]+)</g, '</sub><tspan font-size="16">$1</tspan><');
        label = label.replaceAll(/<\/sup>([^<>]+)</g, '</sup><tspan font-size="16">$1</tspan><');
        label = label.replaceAll(/<sub>([^<>]?)<\/sub>/g, '<tspan dy="4" font-size="12">$1</tspan><tspan dy="-4" font-size="0.1"> </tspan>');
        label = label.replaceAll(/<sup>([^<>]?)<\/sup>/g, '<tspan dy="-7" font-size="12">$1</tspan><tspan dy="7" font-size="0.1"> </tspan>');
        return label;
      }).toArray();
      $.plot($('#statistics'), 
        sampleSimulationStatisticsData, {
          series: {
            bars: {show: true, barWidth: 0.6 / minBarWidth, align: 'center'},
          },
          grid: {
            hoverable: true,
          },
          xaxis: {
            autoScale: 'none',
            min: -0.6,
            max: modelContext['basic']['species'].length - 0.4,
            axisLabel: 'Species'
          },
          yaxis: {
            ticks:6,
            tickDecimals: 5,
            axisLabel: 'c (mol/L)',
          },
          legend: {
            show: true,
          }
      });
      $('#statistics').find('.flot-x-axis text').each(function(_, elem) {
        if (parseFloat($(elem).text()) % 1 == 0 && sampleSimulationSpeciesIndices.includes(parseInt($(elem).text()))) {
          var originalWidth = $(elem)[0].getBoundingClientRect().width;
          var label = '<tspan>' + xtickLabels[parseInt($(elem).text())] + '</tspan>';
          $(elem).html(label);
          var width = $(elem)[0].getBoundingClientRect().width;
          $(elem).attr('x', (parseFloat($(elem).attr('x')) + originalWidth / 2 - width / 2).toString());
        } else {
          $(elem).remove();
        }
      });
      var title_padding_left = $('#statistics').parent().find('.flot-y-axis')[0].getBoundingClientRect().width + $('#statistics').parent().find('.y1LabelLayer')[0].getBoundingClientRect().width;
      $('#statistics').parent().find('.plot-title').css('padding-left', title_padding_left);
    }
    $(document).on('change', '#statistics-species', plotStatistics);

    function plotParity() {
      if (simulationResult.length == 0) {return;}
      var speciesIndex = parseInt($('#parity-sample').val());
      var minVal = null;
      var maxVal = null;
      var simulationData = [];
      $(simulationResult).each(function(_, sampleSimulationResult) {
        var result = sampleSimulationResult.slice(sampleSimulationResult.length - modelContext['basic']['species'].length);
        if (speciesIndex && !isNaN(speciesIndex)) {
          var data = parseFloat(result[speciesIndex]['data'][result[speciesIndex]['data'].length - 1][1]);
          simulationData.push(data);
          minVal = data ? (minVal ? Math.min(minVal, data) : data) : minVal;
          maxVal = data ? (maxVal ? Math.max(maxVal, data) : data) : maxVal;
        }
      })
      var experimentData = [];
      $(table.getData()).each(function(_, sampleExperimentData) {
        var data = parseFloat(sampleExperimentData[sampleExperimentData.length - modelContext['basic']['species'].length + speciesIndex]);
        experimentData.push(data);
        minVal = data ? (minVal ? Math.min(minVal, data) : data) : minVal;
        maxVal = data ? (maxVal ? Math.max(maxVal, data) : data) : maxVal;
      })
      var gap = (maxVal - minVal) / 10;
      var leftVal = minVal - gap / 2;
      var rightVal = maxVal + gap / 2;
      minVal = minVal - gap;
      maxVal = maxVal + gap;
      var parityData = [
        {
          data: experimentData.map(function(d, i) {return [d, simulationData[i]];}), 
          points: {show: true, radius: 3, fill: true},
          lines: {show: false},
        }, {
          data: [[minVal, minVal], [maxVal, maxVal]],
          points: {show: false},
          lines: {show: true}
        }
      ]
      var mape = 0
      $.each(parityData[0]["data"], function(_, data) {
        if (data[0] > data[1])
          var error = (data[0] - data[1]) / data[0];
        else
          var error = (data[1] - data[0]) / data[0];
        mape = mape + error;
      })
      mape = mape / parityData[0]["data"].length;
      console.log(mape);
      
      $.plot($('#parity'), 
        parityData, {
          grid: {
            hoverable: true,
          },
          xaxis: {
            ticks:6,
            tickDecimals: 4,
            axisLabel: 'Experiment c (mol/L)',
            autoScale: 'none',
            min: minVal,
            max: maxVal,
          },
          yaxis: {
            ticks:6,
            tickDecimals: 5,
            axisLabel: 'Simulation c (mol/L)',
            autoScale: 'none',
            min: minVal,
            max: maxVal,
          },
        }
      );
      var title_padding_left = $('#parity').parent().find('.flot-y-axis')[0].getBoundingClientRect().width + $('#parity').parent().find('.y1LabelLayer')[0].getBoundingClientRect().width;
      $('#parity').parent().find('.plot-title').css('padding-left', title_padding_left);
    }
    $(document).on('change', '#parity-sample', plotParity);

    $(document).on('click', '#export-model', function() {
      if (!$('#model').val()) {
        alert('Model Not Selected!');
        return;
      }
      
      var modelContext = explorationResult['model_contexts'][$('#model').val()];
      var calibratedParameter = explorationResult['model_calibration_results'][$('#model').val()]['parameter'];
      var modelRequest = {
        'model_type': $('#model-type').val(),
        'model_context': modelContext,
        'calibrated_parameter': calibrated_parameter,
      }
      var modelRequestJson = JSON.stringify(modelRequest);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.model_export") }}', false);
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          const downloadLink = document.createElement('a');
          let content = xhr.response;
          let blob = new Blob([content]);
          downloadLink.href = URL.createObjectURL(blob);
          if (modelRequest['model_type'] == 'scipy') {
            downloadLink.setAttribute('download', 'model.py');
          } else {
            downloadLink.setAttribute('download', 'model');
          }
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        }
      };
      xhr.send(modelRequestJson);
    });

    $(document).on('change', '#model', function() {
      $('#result-parameter-law').children().remove();
      $.each(explorationResult['model_contexts'][$('#model').val()]['description']['parameter_law'], function(parameter, law) {
        $('#result-parameter-law').append($('<li>' + parameter.replaceAll('_', ' ') + '</li>'));
        $('#result-parameter-law').append($('<div><span class="ml-2">' + law.replaceAll('_', ' ') + '</span></div>'));
        $('#result-parameter-law').append($('<div><a class="ml-2" href="https://doi.org/' + entity['law'][law]['doi'] + '">' + entity['law'][law]['doi'] + '</a></div>'));
      });
      $('#result-rmse').find('b').html(explorationResult['model_calibration_results'][$('#model').val()]['rmse'].toFixed(6));
      $('#result-rmse').css('display', 'flex');
      simulationResult = explorationResult['model_calibration_results'][$('#model').val()]['simulation'];
      $('#plot').css('display', 'flex');
      $('#profile-sample').children().remove();
      $.each(simulationResult, function(index, elem) {
        if (index == 0) {
          $('#profile-sample').append($('<option value=' + index.toString() + ' selected>' + 'Sample ' + (index + 1).toString() + '</option>'))
        } else {
          $('#profile-sample').append($('<option value=' + index.toString() + '>' + 'Sample ' + (index + 1).toString() + '</option>'))
        }
      })
      $('#profile-sample').selectpicker('refresh').trigger('change');
      
      // concentration profile
      $(document).on('change', '#profile-sample', function() {
        var variableVal = $('#profile-variable').val();
        var variableData = [];
        var sampleSimulationResult = simulationResult[parseInt($('#profile-sample').val())]
        $.each($(sampleSimulationResult), function(index, elem) {
          variableData.push({id: index, text: elem['label']});
        });
        var parentElem = $('#profile-variable').parent();
        $('#profile-variable').remove();
        var select = $('<select></select>')
        $(select).addClass('select2');
        $(select).attr('id', 'profile-variable');
        $(select).attr('multiple', 'multiple');
        $(select).attr('style', 'width: 100%;');
        $(select).attr('data-placeholder', 'Select variables');
        $(select).select2({data: variableData});
        parentElem.append(select);
        $('#profile-variable').select2();
        $(document).on('change', '#profile-variable', function() {
          $(this).next().find('.select2-selection__choice').each(function(_, li) {
            if ($(li).find('span').length == 1) {
              var remove = $(li).children()[0];
              var text = '<span>' + $(li).text().slice(1) + '</span>';
              $(li).html(null);
              $(li).append($(remove));
              $(li).append($(text));
            }
          })
        });
        $('#profile-variable').val(variableVal).trigger('change');
      })
      $('#profile-sample').trigger('change');

      // inlet-outlet concentration statistics
      $('#statistics-sample').children().remove();
      $.each(simulationResult, function(index, elem) {
        if (index == 0) {
          $('#statistics-sample').append($('<option value=' + index.toString() + ' selected>' + 'Sample ' + (index + 1).toString() + '</option>'))
        } else {
          $('#statistics-sample').append($('<option value=' + index.toString() + '>' + 'Sample ' + (index + 1).toString() + '</option>'))
        }
      })
      $('#statistics-sample').selectpicker('refresh').trigger('change');

      $(document).on('change', '#statistics-sample', function() {
        var speciesVal = $('#statistics-species').val();
        var speciesData = [];
        var sampleSimulationResult = simulationResult[parseInt($('#statistics-sample').val())]
        $.each($(modelContext['basic']['species']), function(index, elem) {
          speciesData.push({id: index, text: elem});
        });
        var parentElem = $('#statistics-species').parent();
        $('#statistics-species').remove();
        var select = $('<select></select>')
        $(select).addClass('select2');
        $(select).attr('id', 'statistics-species');
        $(select).attr('multiple', 'multiple');
        $(select).attr('style', 'width: 100%;');
        $(select).attr('data-placeholder', 'Select species');
        $(select).select2({data: speciesData});
        parentElem.append(select);
        $('#statistics-species').select2();
        $(document).on('change', '#statistics-species', function() {
          $(this).next().find('.select2-selection__choice').each(function(_, li) {
            if ($(li).find('span').length == 1) {
              var remove = $(li).children()[0];
              var text = '<span>' + $(li).text().slice(1) + '</span>';
              $(li).html(null);
              $(li).append($(remove));
              $(li).append($(text));
            }
          })
        });
        $('#statistics-species').val(speciesVal).trigger('change');
      })
      $('#statistics-sample').trigger('change');
      $('#statistics-species').val(Array.from({length: modelContext['basic']['species'].length}, (_, i) => i.toString())).trigger('change');

      // simulation vs. experiment
      $('#parity-sample').children().remove();
      $.each($(modelContext['basic']['species']), function(index, elem) {
        $('#parity-sample').append($('<option value=' + index.toString() + '>' + elem + '</option>'))
      })
      $('#parity-sample').selectpicker('refresh').trigger('change');
      $('#parity-sample').next().find('.filter-option-inner-inner').text('Nothing selected');
      setTimeout(function() {
        $('#parity-sample').next().next().find('li a').each(function(index, elem) {
          $(elem).find('span').html(modelContext['basic']['species'][index]);
        })
      }, 100);
      $(document).on('change', '#parity-sample', function() {
        var sampleSimulationSpeciesIndex = $('#parity-sample').val();
        if (sampleSimulationSpeciesIndex) {
          var sampleSimulationSpeciesSymbol = modelContext['basic']['species'][sampleSimulationSpeciesIndex];
          $('#parity-sample').next().find('.filter-option-inner-inner').html(sampleSimulationSpeciesSymbol);
        } else {
          $('#parity-sample').next().find('.filter-option-inner-inner').text('Nothing selected');
        }
      })
      $('#parity-sample').selectpicker('refresh').trigger('change');
    });
    
    function modelExploration() {
      var data = getData(true);
      var parameter = getParameter();
      var modelContext = getModelContext();
      var explorationRequest = {
        'task': 'exploration',
        'data': data,
        'parameter': parameter,
        'model_type': $('#model-type').val(),
        'model_context': modelContext,
      }
      var explorationRequestJson = JSON.stringify(explorationRequest);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '{{ url_for("home.model_exploration") }}', true);
      xhr.timeout = 120000; // timeout in 2 minutes
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          explorationResult = JSON.parse(xhr.response);
          
          $('#model').children().remove();
          $.each(explorationResult['model_contexts'], function(index, _) {
            $('#model').append('<option value=' + index.toString() + '>' + 'Model ' + (index + 1).toString() + '</option>');
          })
          $('#model').selectpicker('refresh');

          $('#result').css('display', 'flex');
          $('#result-rmse').css('display', 'none');
          plotRMSE();
        } else {
          $('input').attr('disabled', false);
          $('select').attr('disabled', false);
          $('button').attr('disabled', false);
        }
      };
      $('input').attr('disabled', true);
      $('select').attr('disabled', true);
      $('button').attr('disabled', true);
      xhr.send(explorationRequestJson);
    }
    $(document).on('click', '#exploration-run-button', modelExploration);

    if (modelContext) {
      table = loadInputSheet(modelContext, null);
    }
  </script>
{% endblock javascripts %}
