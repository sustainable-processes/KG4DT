# ---------------------------------------------
# Extract GraphDB distribution (x86 compatible)
# ---------------------------------------------
	FROM --platform=linux/amd64 alpine:3.12 AS ZipExtractor

	ARG GDB_VERSION=10.6.3
	RUN apk add unzip
	
	COPY "graphdb/dist/graphdb-${GDB_VERSION}-dist.zip" /dist/
	RUN unzip -q "/dist/graphdb-${GDB_VERSION}-dist.zip" \
		&& mv "graphdb-${GDB_VERSION}" /opt/graphdb \
		&& rm -rf /dist
	
	# ----------------------------------------------
	# Repository/SPARQL Initialization (x86 compatible)
	# ----------------------------------------------
	FROM --platform=linux/amd64 golang:1.18-buster AS GoCompiler
	
	RUN mkdir -p /binaries
	
	# Compile program to initialize GraphDB repositories
	COPY graphdb/graphdb-repository-init /opt/go/app/graphdb-repository-init
	WORKDIR /opt/go/app/graphdb-repository-init
	RUN go mod vendor \
		&& go build \
		&& mv graphdb-repository-init /binaries/graphdb-repository-init
	
	# Compile program that pre-queries SPARQL queries
	COPY graphdb/repo-presparql-query /opt/go/app/repo-presparql-query
	WORKDIR /opt/go/app/repo-presparql-query
	RUN go mod vendor \
		&& go build \
		&& mv repo-presparql-query /binaries/repo-presparql-query
	
	RUN rm -rf /opt/go/app
	
	# -----------------------------------------------
	# Main Image (x86 compatible)
	# -----------------------------------------------
	FROM --platform=linux/amd64 openjdk:11-jdk-slim
	
	LABEL maintainer="Kevin Haller <contact@kevinhaller.dev>"
	
	ENV PATH="$PATH:/opt/graphdb/bin"
	
	# GraphDB data volumes (optional, useful for ECS)
	VOLUME /opt/graphdb/data
	VOLUME /opt/graphdb/log
	VOLUME /opt/graphdb/conf
	VOLUME /opt/graphdb/work
	
	EXPOSE 7200
	EXPOSE 7300
	
	# Copy scripts and binaries
	COPY graphdb/set-ownership.sh /usr/bin/set-ownership
	COPY graphdb/run-graphdb.sh /usr/bin/run-graphdb
	COPY graphdb/docker-entrypoint.sh /usr/bin/docker-entrypoint.sh
	COPY --from=GoCompiler /binaries/* /usr/bin/
	
	# Set executable permissions for entrypoint scripts
	RUN apt-get update \
		&& apt-get install -y --no-install-recommends \
			gosu \
			iproute2 \
			tini \
		&& chmod +x /usr/bin/docker-entrypoint.sh \
		&& chmod +x /usr/bin/run-graphdb \
		&& chmod +x /usr/bin/set-ownership \
		&& rm -rf /var/lib/apt/lists/*
	
	ARG DFILE_VERSION
	ARG GDB_VERSION
	
	LABEL version="${DFILE_VERSION}-graphdb${GDB_VERSION}"
	LABEL description="GraphDB ${GDB_VERSION} (free version)"
	
	# Copy extracted GraphDB distribution
	COPY --from=ZipExtractor /opt/graphdb /opt/graphdb
	
	# âœ… Include ontology files directly in the image
	COPY ontology /ontology
	
	ENTRYPOINT ["docker-entrypoint.sh"]