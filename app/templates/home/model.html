{% extends "layouts/base.html" %}

{% block title %} KG4DT {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} sidebar-mini sidebar-collapse {% endblock body_class %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="/static/assets/plugins/select2/css/select2.css">
  <link rel="stylesheet" href="/static/assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.css">
  <!-- TagsInput -->
  <link rel="stylesheet" href="/static/assets/plugins/bootstrap4-tagsinput/tagsinput.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="/static/assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- Bootstrap-select -->
  <link rel="stylesheet" href="/static/assets/plugins/bootstrap-select/dist/css/bootstrap-select.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="/static/assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="/static/assets/plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="/static/assets/plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="/static/assets/plugins/daterangepicker/daterangepicker.css">
  <!-- summernote -->
  <link rel="stylesheet" href="/static/assets/plugins/summernote/summernote-bs4.min.css">

{% endblock stylesheets %}

{% block content %}
  
  <div class="content-wrapper">

    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="row ml-1">
        <div class="col-sm-6">
          <h1 class="text-dark">KG4DT</h1>
        </div>
        <div class="col-sm-6">
          <div class="float-sm-right mr-2" style="display: flex">
            <select id="export-model-type" title="Model Type">
              <option selected data-thumbnail="../../static/assets/img/model_type/scipy.png">scipy</option>
              {% if pyomo %}
                <option data-thumbnail="../../static/assets/img/model_type/pyomo.png">pyomo</option>
              {% endif %}
              {% if julia %}
                <option data-thumbnail="../../static/assets/img/model_type/julia.png">julia</option>
              {% endif %}
            </select>
            <button id="export-model" class="btn btn-primary ml-3">Export</button>
          </div>
        </div>
      </div>
    </div>
    <!-- /.content-header -->

    <section class="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-body">

            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Species</b>
                <!-- : used as species identifier, name or formula, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="species"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Reaction</b>
                <!-- : reaction formula, A + 2 B > 3 C, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="reaction"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Stream</b>
                <!-- : used as stream identifier, stream 1, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="stream"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Solvent</b>
                <!-- : used as solvent identifier, water, e.g. -->
              </a>
              <input multiple data-role="tagsinput" id="solvent"></input>
            </div>
            <div class="form-group mb-2">
              <a style="color: gray;">
                <b style="font-size:20px; color: black;">Catalyst</b>
                <!-- : used as catalyst identifier, Enzyme, e.g. -->
              </a>
              <input data-role="tagsinput" maxTags=1 id="catalyst"></input>
            </div>
            <div style="text-align: right;" class="mb-2">
              <button id="generate-button" class="btn btn-primary">Generate</button>
            </div>
          </div>
        </div>

        <div id="solvent-miscibility" class="card card-primary card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#solvent-miscibility-body" aria-expanded="true" style="color: black; display: flex;">
                Solvent Miscibility
              </a>
            </h4>
          </div>
          <div id="solvent-miscibility-body" class="collapse">
            <div class="card-body" style="display: flex;">
              <ul class="mb-2">
                <li>
                  <div style="display: flex;">
                    <a id="solvent-miscibility-reference" class="mr-4" style="color: black; display: block;">
                      Sigma Aldrich
                      <img src="/static/assets/img/data_source/sigma_aldrich.png" class="ml-1" style="height: 24px;">
                    </a>
                    <div id="solvent-miscibility-value"></div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div id="solute-solubility" class="card card-primary card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#solute-solubility-body" aria-expanded="true" style="color: black; display: flex;">
                Solute Solubility
              </a>
            </h4>
          </div>
          <div id="solute-solubility-body" class="collapse">
            <div class="card-body" style="display: flex;">
              <ul class="mb-2">
                <div style="display: block;">
                  <li>
                    <div class="mb-2">
                      <a id="solute-solubility-rmg-reference" class="mr-2" style="color: black;">
                        RMG
                        <img src="/static/assets/img/ai_model/rmg.png" class="ml-1" style="height: 24px;">
                      </a>
                      <span style="color: #999;" class="mr-4">(mol/L)</span>
                      <span style="color: #999;">temperature: 25 Â°C</span>
                    </div>
                    <div id="solute-solubility-rmg-value"></div>
                  </li>
                </div>
              </ul>
            </div>
          </div>
        </div>

        <div id="physical-property-pubchem" class="card card-warning card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#physical-property-pubchem-body" aria-expanded="true" style="color: black; display: flex;">
                PubChem
                <img src="/static/assets/img/data_source/pubchem.png" class="ml-2" style="height: 24px;">
              </a>
            </h4>
          </div>
          <div id="physical-property-pubchem-body" class="collapse">
            <div id="physical-property-pubchem-value" class="card-body"></div>
          </div>
        </div>

        <div id="physical-property-chemspider" class="card card-warning card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#physical-property-chemspider-body" aria-expanded="true" style="color: black; display: flex;">
                ChemSpider
                <img src="/static/assets/img/data_source/chemspider.png" class="ml-2" style="height: 24px;">
              </a>
            </h4>
          </div>
          <div id="physical-property-chemspider-body" class="collapse">
            <div id="physical-property-chemspider-value" class="card-body"></div>
          </div>
        </div>

        <div id="physical-property-wikipedia" class="card card-warning card-outline" style="display: block;">
          <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
            <h4 class="card-title">
              <a data-toggle="collapse" href="#physical-property-wikipedia-body" aria-expanded="true" style="color: black; display: flex;">
                Wikipedia
                <img src="/static/assets/img/data_source/wikipedia.png" class="ml-2" style="height: 24px;">
              </a>
            </h4>
          </div>
          <div id="physical-property-wikipedia-body" class="collapse">
            <div id="physical-property-wikipedia-value" class="card-body"></div>
          </div>
        </div>

        <div class="row">
          <!-- Phenomenon -->
          <div class="col-md-6">
            <blockquote class="quote-info mt-0">
              <h5>Description</h5>
            </blockquote>

            <div class="card card-info">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Mass Balance</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <select id="accumulation-select" class="select2" style="width: 100%;" data-placeholder="Select an option">
                    <option disabled hidden selected></option>
                    {% for k, attr in entity["phenomenon"].items() %}
                      {% if attr["class"] == "Accumulation" %}
                      <option value="{{ k }}">{{ k.replace("_", " ") }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>

            <div class="card card-info">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Flow Pattern</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <select id="flow-pattern-select" class="select2" style="width: 100%;" data-placeholder="Select an option">
                    <option disabled hidden selected></option>
                    {% for k, attr in entity["phenomenon"].items() %}
                      {% if attr["class"] == "FlowPattern" %}
                      <option value="{{ k }}">{{ k.replace("_", " ") }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>

            <div class="card card-info">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Molecular Transport</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <select id="molecular-transport-select" class="select2" multiple="multiple" style="width: 100%;" data-placeholder="Select options">
                  </select>
                </div>
              </div>
            </div>

            <div class="card card-info">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Model Parameter Laws</h3>
              </div>
              <div class="card-body">
                <div class="form-group" id="model-parameter-laws">
                </div>
              </div>
            </div>

            <div id="reaction-cards">
            </div>

            <div id="reaction-card-template" class="card card-info reaction-card" style="display: none;">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Chemical Reaction Template</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <select class="reaction-select select2" multiple="multiple" style="width: 100%;" data-placeholder="Select options">
                    {% for k, attr in entity["phenomenon"].items() %}
                      {% if attr["class"] == "ChemicalReactionPhenomenon" %}
                      <option>{{ k.replace("_", " ") }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Information -->
          <div class="col-md-6">
            <blockquote class="quote-success mt-0">
              <h5>Information</h5>
            </blockquote>

            <div id="species-info-card" class="card card-success">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Species</h3>
              </div>
              <div class="card-body">
                <form>
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["PhysicalParameter"] and "Species" in attr["dimensions"] %}
                    <div class="species-info-parameter" style="display: none;">
                      <div class="mb-1" style="width: 45%; display: flex;">
                        <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                        <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                      </div>
                      <div class="mb-2 parameter-value" style="width: 55%;">
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </form>
              </div>
            </div>

            <div id="reactor-info-card" class="card card-success">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Reactor</h3>
              </div>
              <div class="card-body">
                <form>
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["ReactorParameter"] %}
                    <div class="reactor-info-parameter" style="display: none;">
                      <div class="mb-1" style="width: 45%; display: flex;">
                        <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                        <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                      </div>
                      <div style="position: relative; width: 55%; display: flex;">
                        <div style="width: 100%;">
                          <input type="number" class="form-control" style="width: 100%; height: 24px; padding-left: 2px;" step="any">
                        </div>
                        <a class="unit" style="text-align: center; width: 60px; height: 24px; color: #999;"></a>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </form>
              </div>
            </div>

            <div id="molecular-transport-info-card" class="card card-success">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Molecular Transport</h3>
              </div>
              <div class="card-body">
                <form>
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["MolecularTransportParameter"] and attr["laws"] == [] %}
                      {% if attr["dimensions"] == [] %}
                      <div class="molecular-transport-info-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div style="position: relative; width: 55%; display: flex;">
                          <div style="width: 100%;">
                            <input type="number" class="form-control" style="width: 100%; height: 24px; padding-left: 2px;" step="any">
                          </div>
                          <a class="unit" style="text-align: center; width: 60px; height: 24px; color: #999;"></a>
                        </div>
                      </div>
                      {% endif %}
                      {% if "Stream" not in attr["dimensions"] and "Species" in attr["dimensions"] %}
                      <div class="molecular-transport-info-species-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div class="parameter-value" style="width: 55%;">
                        </div>
                      </div>
                      {% endif %}
                      {% if "Stream" in attr["dimensions"] and "Species" in attr["dimensions"] %}
                      <div class="molecular-transport-info-stream-species-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div class="parameter-value" style="width: 55%;">
                        </div>
                      </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </form>
              </div>
            </div>

            <div id="stream-info-cards">
            </div>

            <div id="stream-info-card-template" class="card card-success stream-info-card" style="display: none;">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem">
                <h3 class="card-title">Stream Template</h3>
              </div>
              <div class="card-body">
                <div class="stream-info-input">
                  <div style="display: flex; vertical-align: middle;">
                    <div style="display: flex; width: 45%; padding-right: 10px;">
                      <p class="mt-1 mb-0" style="padding-right: 10px;">State</p>
                      <select class="select2 stream-info-state-select" style="width: 100%;" data-placeholder="Select an option">
                        <option selected>liquid</option>
                        <option>gaseous</option>
                      </select>
                    </div>
                    <div style="display: flex; width: 55%; padding-left: 10px;">
                      <p class="mt-1 mb-0" style="padding-right: 10px;">Solvent</p>
                      <select class="select2 stream-info-solvent-select" style="width: 100%;">
                      </select>
                    </div>
                  </div>
                  <div class="mt-2 mb-2" style="display: flex; vertical-align: middle;">
                    <p class="mt-1 mb-0" style="padding-right: 10px;">Reaction</p>
                    <select class="select2 stream-info-reaction-select" multiple="multiple" style="width: 100%;" data-placeholder="Select options"></select>
                  </div>
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["PhysicalParameter"] and "Stream" in attr["dimensions"] and not attr["definition"] %}
                      {% if "Gas" in k %}
                      <div class="stream-info-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div style="position: relative; width: 55%; display: flex;">
                          <div style="width: 100%;">
                            <input type="number" class="form-control" style="width: 100%; height: 24px; padding-left: 2px;" step="any">
                          </div>
                          <a class="unit" style="text-align: center; width: 60px; height: 24px; color: #999;"></a>
                        </div>
                      </div>
                      {% else %}
                      <div class="stream-info-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div style="position: relative; width: 55%; display: flex;">
                          <div style="width: 100%;">
                            <input type="number" class="form-control" style="width: 100%; height: 24px; padding-left: 2px;" step="any">
                          </div>
                          <a class="unit" style="text-align: center; width: 60px; height: 24px; color: #999;"></a>
                        </div>
                      </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>

            <div id="reaction-info-cards">
            </div>

            <div id="reaction-info-card-template" class="card card-success reaction-info-card" style="display: none;">
              <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                <h3 class="card-title">Reaction Template</h3>
              </div>
              <div class="card-body">
                <form>
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["ReactionParameter"] and k != "Coefficient" %}
                      {% if entity["model_variable"][k]["dimensions"] == ["Reaction"] %}
                      <div class="reaction-info-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div class="mb-1 parameter-value" style="width: 55%;">
                        </div>
                      </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["ReactionParameter"] and k != "Coefficient" %}
                      {% if "Species" in entity["model_variable"][k]["dimensions"] %}
                      <div class="reaction-info-species-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div class="parameter-value" style="width: 55%;">
                        </div>
                      </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% for k, attr in entity["model_variable"].items() %}
                    {% if attr["class"] in ["ReactionParameter"] and k != "Coefficient" %}
                      {% if "Solvent" in entity["model_variable"][k]["dimensions"] %}
                      <div class="reaction-info-solvent-parameter" style="display: none;">
                        <div class="mb-1" style="width: 45%; display: flex;">
                          <div class="parameter-name">{{ k.replace("_", " ") }}</div>
                          <div>&nbsp;&nbsp;{{ attr["symbol"] | safe }}</div>
                        </div>
                        <div class="parameter-value" style="width: 55%;">
                        </div>
                      </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% for k, attr in entity["law"].items() %}
                    {% if attr["formula"] and "specifically defined" in attr["formula"] %}
                    <div class="reaction-info-specific-law" style="display: none;">
                      <div class="mb-1" style="width: 45%; display: flex;">
                        <div class="law-phenomenon">{{ "for " + attr["phenomenon"].replace("_", " ") }}</div>
                      </div>
                      <textarea class="form-control mb-2" style="width: 55%; height: 80px; line-height: 1; font-size: 16px; padding: 4px;"></textarea>
                    </div>
                    {% endif %}
                  {% endfor %}
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- jQuery -->
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="/static/assets/plugins/jquery-ui/jquery-ui.min.js"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Bootstrap-select -->
  <script src="/static/assets/plugins/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
  <!-- Select2 -->
  <script src="/static/assets/plugins/select2/js/select2.full.min.js"></script>
  <!-- TagsInput -->
  <script src="/static/assets/plugins/bootstrap4-tagsinput/tagsinput.js"></script>
  <!-- Bootstrap4 Duallistbox -->
  <script src="/static/assets/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js"></script>
  <!-- InputMask -->
  <script src="/static/assets/plugins/moment/moment.min.js"></script>
  <script src="/static/assets/plugins/inputmask/jquery.inputmask.min.js"></script>
  <!-- date-range-picker -->
  <script src="/static/assets/plugins/daterangepicker/daterangepicker.js"></script>
  <!-- bootstrap color picker -->
  <script src="/static/assets/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="/static/assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
  <!-- Bootstrap Switch -->
  <script src="/static/assets/plugins/bootstrap-switch/js/bootstrap-switch.min.js"></script>
  <!-- ChartJS -->
  <script src="/static/assets/plugins/chart.js/Chart.min.js"></script>
  <!-- Sparkline -->
  <script src="/static/assets/plugins/sparklines/sparkline.js"></script>
  <!-- JQVMap -->
  <script src="/static/assets/plugins/jqvmap/jquery.vmap.min.js"></script>
  <script src="/static/assets/plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
  <!-- jQuery Knob Chart -->
  <script src="/static/assets/plugins/jquery-knob/jquery.knob.min.js"></script>
  <!-- daterangepicker -->
  <script src="/static/assets/plugins/moment/moment.min.js"></script>
  <script src="/static/assets/plugins/daterangepicker/daterangepicker.js"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="/static/assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
  <!-- Summernote -->
  <script src="/static/assets/plugins/summernote/summernote-bs4.min.js"></script>
  <!-- overlayScrollbars -->
  <script src="/static/assets/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
  <!-- AdminLTE App -->
  <script src="/static/assets/js/adminlte.js"></script>

  <script type="text/javascript">{{ entity_json | safe }}</script>
  <script type="text/javascript">{{ model_context_json | safe }}</script>

  <script>
    if (modelContext) {
      loadModelContext(modelContext);
    }

    $(document).on('click', '.bottom-up-link', function() {
      sessionStorage.setItem('modelContext', JSON.stringify(getModelContext()));
    });

    $(document).on('click', '.top-down-rule-link', function() {
      sessionStorage.removeItem('modelContext');
    });

    $(document).on('click', '.top-down-exploration-link', function() {
      sessionStorage.removeItem('modelContext');
    });

    var generateState = false;

    $('.select2').select2()

    $('#export-model-type').find('option').each((idx, elem) => {
      if ($(elem).attr('data-thumbnail')) {
        $(elem).attr('data-content', '<img width="20px" src=' + $(elem).attr('data-thumbnail') + '/>&nbsp;&nbsp;&nbsp;' + $(elem).text());
      }
    });
    $('#export-model-type').selectpicker();

    $(document).ready(function() {
      $('.reactor-info-parameter').each(function(index, parameterNode) {
        var parameter = $(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_');
        var unit = entity['model_variable'][parameter]['unit'];
        if (unit)
          $(parameterNode).find('.unit').html(entity['unit'][unit]['symbol']);
      });
      $('.molecular-transport-info-parameter').each(function(index, parameterNode) {
        var parameter = $(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_');
        var unit = entity['model_variable'][parameter]['unit'];
        if (unit)
          $(parameterNode).find('.unit').html(entity['unit'][unit]['symbol']);
      });
      $('.stream-info-parameter').each(function(index, parameterNode) {
        var parameter = $(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_');
        var unit = entity['model_variable'][parameter]['unit'];
        if (unit)
          $(parameterNode).find('.unit').html(entity['unit'][unit]['symbol']);
      });
    })

    function speciesValid() {
      var species = $('#species').val().split(',');
      $('#species').prev().children().each(function(index, elem) {
        var symbol = document.createElement('a');
        var span = document.createElement('span');
        symbol.innerHTML = species[index];
        span.setAttribute('data-role', 'remove');
        $(elem).empty().append(symbol).append(span);
      })
    }
    $(document).on('change', '#species', speciesValid);

    function reactionValid() {
      var species = $('#species').val().split(',');
      var reactions = $('#reaction').val().split(',');
      var reactionVal = [];
      var re = new RegExp("^((\\d+ )?.+ \\+ )*(\\d+ )?.+ > ((\\d+ )?.+ \\+ )*(\\d+ )?.+$");
      var reNum = new RegExp("^\\d+$");
      $('#reaction').prev().children().each(function(index, elem) {
        var reaction = reactions[index];
        if (re.test(reaction)) {
          var lhs_species = $.map(reaction.split(' > ')[0].split(' + '), function(s, i) {
            if (reNum.test(s.split(' ')[0])) {
              return s.split(' ').slice(1).join(' ');
            } else {
              return s;
            }
          });
          var rhs_species = $.map(reaction.split(' > ')[1].split(' + '), function(s, i) {
            if (reNum.test(s.split(' ')[0])) {
              return s.split(' ').slice(1).join(' ');
            } else {
              return s;
            }
          });
          var reaction_species = $.merge(lhs_species, rhs_species);
          if (reaction_species.every(function(s) {return species.includes(s);})) {
            var formula = document.createElement('a');
            var span = document.createElement('span');
            formula.innerHTML = reaction;
            span.setAttribute('data-role', 'remove');
            $(elem).empty().append(formula).append(span);
            reactionVal.push(reaction);
          } else {
            $('#reaction').prev().remove(elem);
          }
        }
      })
      $('#reaction').val(reactionVal.join(','));
    }
    $(document).on('change', '#reaction', reactionValid);

    function catalystValid() {
      var catalysts = $('#catalyst').val().split(',').filter((x) => {return x;});
      if (catalysts.length > 1) {
        $('#catalyst').val(catalysts[0]).trigger('change');
        $('#catalyst').prev().children('span').each(function(index, elem) {
          if (index > 0) {
            $(elem).remove();
          }
        });
      } else {
        $('#catalyst').prev().children().each(function(index, elem) {
          var symbol = document.createElement('a');
          var span = document.createElement('span');
          symbol.innerHTML = catalysts[index];
          span.setAttribute('data-role', 'remove');
          $(elem).empty().append(symbol).append(span);
        });
      }
    }
    $(document).on('change', '#catalyst', catalystValid);

    $(document).on('change', '#species', function() {generateState = false;})
    $(document).on('change', '#reacton', function() {generateState = false;})
    $(document).on('change', '#stream', function() {generateState = false;})
    $(document).on('change', '#solvent', function() {generateState = false;})
    $(document).on('change', '#catalyst', function() {generateState = false;})

    function getPubChemPhysicalProperty() {
      var solvents = $('#solvent').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      if (!solvents) {
        $('#physical-property-pubchem').css('display', 'none');
      };
      var physicalPropertyRequestJson = JSON.stringify(solvents);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '/physical_property_pubchem', true);
      xhr.timeout = 30000; // timeout in 30 seconds
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var physicalPropertyResult = JSON.parse(xhr.response);
          $('#physical-property-pubchem-value').children().remove();
          for (var solvent in physicalPropertyResult) {
            var solventPhysicalPropertyResult = physicalPropertyResult[solvent];
            var solventDiv = $('<div class="ml-3 mb-3"></div>');
            var solventHeadDiv = $('<div style="display: flex"></div>');
            $(solventHeadDiv).append($('<label style="margin-bottom: 0;">' + solvent + '</label>'));
            $(solventHeadDiv).append($('<span class="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;</span>'));
            $(solventHeadDiv).append($('<span style="color: #999">SMILES: ' + physicalPropertyResult[solvent]['canonical_smiles'] + '</span>'));
            $(solventDiv).append(solventHeadDiv);
            for (var solventPhysicalProperty in solventPhysicalPropertyResult['property']) {
              var solventPhysicalPropertyDiv = $('<div class="ml-3"></div>');
              var solventPhysicalPropertyList = solventPhysicalPropertyResult['property'][solventPhysicalProperty];
              $(solventPhysicalPropertyDiv).append($('<a>' + solventPhysicalProperty + '</a>'));
              var solventPhysicalPropertyUL = $('<ul class="mb-0"></ul>');
              for (var i in solventPhysicalPropertyList) {
                var solventPhysicalPropertyLI = $('<li></li>');
                $(solventPhysicalPropertyLI).append($('<div>' + solventPhysicalPropertyList[i]['value'] + '</div>'));
                $(solventPhysicalPropertyLI).append($('<div style="color: #999;">' + solventPhysicalPropertyList[i]['reference'] + '</div>'));
                $(solventPhysicalPropertyUL).append(solventPhysicalPropertyLI);
              }
              $(solventPhysicalPropertyDiv).append(solventPhysicalPropertyUL);
              $(solventDiv).append(solventPhysicalPropertyDiv);
            }
            $('#physical-property-pubchem-value').append(solventDiv);
          }
          $('#physical-property-pubchem').css('display', 'block')
        } else {
          $('#physical-property-pubchem').css('display', 'none');
        }
      };
      xhr.send(physicalPropertyRequestJson);
    }

    function getChemSpiderPhysicalProperty() {
      var solvents = $('#solvent').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      if (!solvents) {
        $('#physical-property-chemspider').css('display', 'none');
      };
      var physicalPropertyRequestJson = JSON.stringify(solvents);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '/physical_property_chemspider', true);
      xhr.timeout = 30000; // timeout in 30 seconds
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var physicalPropertyResult = JSON.parse(xhr.response);
          $('#physical-property-chemspider-value').children().remove();
          for (var solvent in physicalPropertyResult) {
            var solventPhysicalPropertyResult = physicalPropertyResult[solvent];
            var solventDiv = $('<div class="ml-3 mb-3"></div>');
            var solventHeadDiv = $('<div style="display: flex"></div>');
            $(solventHeadDiv).append($('<label style="margin-bottom: 0;">' + solvent + '</label>'));
            $(solventHeadDiv).append($('<span class="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;</span>'));
            $(solventHeadDiv).append($('<span style="color: #999">SMILES: ' + physicalPropertyResult[solvent]['canonical_smiles'] + '</span>'));
            $(solventDiv).append(solventHeadDiv);
            for (var solventPhysicalProperty in solventPhysicalPropertyResult['property']) {
              var solventPhysicalPropertyDiv = $('<div class="ml-3"></div>');
              var solventPhysicalPropertyList = solventPhysicalPropertyResult['property'][solventPhysicalProperty];
              $(solventPhysicalPropertyDiv).append($('<a>' + solventPhysicalProperty + '</a>'));
              var solventPhysicalPropertyUL = $('<ul class="mb-0"></ul>');
              for (var i in solventPhysicalPropertyList) {
                var solventPhysicalPropertyLI = $('<li></li>');
                $(solventPhysicalPropertyLI).append($('<div>' + solventPhysicalPropertyList[i]['value'] + '</div>'));
                $(solventPhysicalPropertyLI).append($('<div style="color: #999;">' + solventPhysicalPropertyList[i]['reference'] + '</div>'));
                $(solventPhysicalPropertyUL).append(solventPhysicalPropertyLI);
              }
              $(solventPhysicalPropertyDiv).append(solventPhysicalPropertyUL);
              $(solventDiv).append(solventPhysicalPropertyDiv);
            }
            $('#physical-property-chemspider-value').append(solventDiv);
          }
          $('#physical-property-chemspider').css('display', 'block')
        } else {
          $('#physical-property-chemspider').css('display', 'none');
        }
      };
      xhr.send(physicalPropertyRequestJson);
    }

    function getWikipediaPhysicalProperty() {
      var solvents = $('#solvent').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      if (!solvents) {
        $('#physical-property-wikipedia').css('display', 'none');
      };
      var physicalPropertyRequestJson = JSON.stringify(solvents);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '/physical_property_wikipedia', true);
      xhr.timeout = 30000; // timeout in 30 seconds
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var physicalPropertyResult = JSON.parse(xhr.response);
          $('#physical-property-wikipedia-value').children().remove();
          for (var solvent in physicalPropertyResult) {
            var solventPhysicalPropertyResult = physicalPropertyResult[solvent];
            var solventDiv = $('<div class="ml-3 mb-3"></div>');
            var solventHeadDiv = $('<div style="display: flex"></div>');
            $(solventHeadDiv).append($('<label style="margin-bottom: 0;">' + solvent + '</label>'));
            $(solventHeadDiv).append($('<span class="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;</span>'));
            $(solventHeadDiv).append($('<span style="color: #999">SMILES: ' + physicalPropertyResult[solvent]['canonical_smiles'] + '</span>'));
            $(solventDiv).append(solventHeadDiv);
            for (var solventPhysicalProperty in solventPhysicalPropertyResult['property']) {
              var solventPhysicalPropertyDiv = $('<div class="ml-3"></div>');
              var solventPhysicalPropertyList = solventPhysicalPropertyResult['property'][solventPhysicalProperty];
              $(solventPhysicalPropertyDiv).append($('<a>' + solventPhysicalProperty + '</a>'));
              var solventPhysicalPropertyUL = $('<ul class="mb-0"></ul>');
              for (var i in solventPhysicalPropertyList) {
                var solventPhysicalPropertyLI = $('<li></li>');
                $(solventPhysicalPropertyLI).append($('<div>' + solventPhysicalPropertyList[i]['value'] + '</div>'));
                $(solventPhysicalPropertyLI).append($('<div style="color: #999;">' + solventPhysicalPropertyList[i]['reference'] + '</div>'));
                $(solventPhysicalPropertyUL).append(solventPhysicalPropertyLI);
              }
              $(solventPhysicalPropertyDiv).append(solventPhysicalPropertyUL);
              $(solventDiv).append(solventPhysicalPropertyDiv);
            }
            $('#physical-property-wikipedia-value').append(solventDiv);
          }
          $('#physical-property-wikipedia').css('display', 'block')
        } else {
          $('#physical-property-wikipedia').css('display', 'none');
        }
      };
      xhr.send(physicalPropertyRequestJson);
    }

    function getSolventMiscibility() {
      var solvents = $('#solvent').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      if (!solvents) {
        $('#solvent-miscibility').css('display', 'none');
      };
      var solventMiscibilityRequestJson = JSON.stringify(solvents);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '/solvent_miscibility', true);
      xhr.timeout = 30000; // timeout in 30 seconds
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var solventMiscibilityResult = JSON.parse(xhr.response);
          $('#solvent-miscibility-value').text(solventMiscibilityResult[0]);
          $('#solvent-miscibility-reference').attr('href', solventMiscibilityResult[1]);
          if (solventMiscibilityResult[1]) {
            $('#solvent-miscibility-reference').css('display', 'block')
          } else {
            $('#solvent-miscibility-reference').css('display', 'none')
          }
          $('#solvent-miscibility').css('display', 'block');
        } else {
          $('#solvent-miscibility').css('display', 'none');
        }
      };
      xhr.send(solventMiscibilityRequestJson);
    }

    function getSoluteSolubility() {
      var solvents = $('#solvent').val().split(',');
      var solutes = $('#species').val().split(',');
      solvents = $(solvents).filter(function(index, solvent) {return solvent.length > 0}).toArray();
      solutes = $(solutes).filter(function(index, solute) {return solute.length > 0}).toArray();
      if (!solvents || !solutes) {
        $('#solute-solubility').css('display', 'none');
      };
      var soluteSolubilityRequestJson = JSON.stringify({"solvents": solvents, "solutes": solutes});
      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '/solute_solubility', true);
      xhr.timeout = 120000; // timeout in 2 minutes
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var soluteSolubilityResult = JSON.parse(xhr.response);
          $('#solute-solubility-rmg-reference').closest('div').css('display', 'block');
          $('#solute-solubility-rmg-reference').attr('href', soluteSolubilityResult["reference"]);
          $('#solute-solubility-rmg-value').children().remove();
          var table = $('<table class="table table-bordered" style="color: black; text-align: center"><thead><tr><th></th></tr></thead></table>')
          $(solutes).each(function(_, solute) {
            $(table).find('thead').find('tr').append($('<th style="font-weight: normal;">' + solute + '</th>'));
          });
          var tbody = $('<tbody></tbody>');
          $(solvents).each(function(index, solvent) {
            $(tbody).append($('<tr>' + solvent + '</tr>'));
            $(tbody).find('tr:eq(' + index.toString() + ')').append($('<td>' + solvent + '</td>'))
            $(soluteSolubilityResult["value"][index]).each(function(_, value) {
              $(tbody).find('tr:eq(' + index.toString() + ')').append($('<td>' + value + '</td>'))
            });
          });
          $(table).append(tbody);
          $('#solute-solubility-rmg-value').append(table);
          $('#solute-solubility').css('display', 'block');
        } else {
          $('#solute-solubility').css('display', 'none');
        }
      };
      xhr.send(soluteSolubilityRequestJson);
    }

    $(document).on('click', '#generate-button', function() {
      var streams = $('#stream').val().split(',');
      var solvents = $('#solvent').val().split(',');
      var catalysts = $('#catalyst').val().split(',').filter((x) => {return x;});
      if (catalysts.length > 1) {
        if (streams.length > 1 || solvents.length > 1) {
          alert('Multiple solvents/streams not supported with multiple catalysts!');
          return;
        }
      }

      $('#accumulation-select').val(null).trigger('change');
      $('#flow-pattern-select').val(null).trigger('change');
      $('#molecular-transport-select').val(null).trigger('change');
      $('#reaction-cards').empty();
      $.each($('#reaction').val().split(','), function(index, reaction) {
        var reactionCard = $('#reaction-card-template').clone();
        reactionCard.attr('id', 'reaction-card-' + index);
        reactionCard.attr('style', '');
        reactionCard.find('span').remove();
        reactionCard.find('.select2').select2();
        var formula = document.createElement('a');
        formula.innerHTML = reaction;
        reactionCard.find('.card-title').first().text('Chemical Reaction: ');
        $(formula).appendTo(reactionCard.find('.card-title').first());
        reactionCard.appendTo("#reaction-cards");
      });

      $('#species-info-card').find('input').val(null).trigger('change');
      $('.species-info-parameter').css('display', 'none').trigger('change');
      var reactionData = []
      $.each($('#reaction').val().split(','), function(index, reaction) {
        reactionData.push({id: reaction, text: '<a>' + reaction + '</a>'});
      })
      $('#stream-info-cards').empty();
      $.each($('#stream').val().split(','), function(index, stream) {
        var streamInfoCard = $('#stream-info-card-template').clone();
        streamInfoCard.attr('id', 'stream-info-card-' + index);
        streamInfoCard.attr('style', '');
        streamInfoCard.find('span').remove();
        streamInfoCard.find('.select2').select2();
        streamInfoCard.find('.card-title').first().text('Stream: ' + stream);
        $.each($('#solvent').val().split(','), function(index, solvent) {
          var solventOption = new Option(solvent, solvent);
          streamInfoCard.find('.stream-info-solvent-select').first().append(solventOption);
        })
        streamInfoCard.find('.stream-info-solvent-select').val(null);
        streamInfoCard.find('.stream-info-reaction-select').select2({
          data: reactionData,
          templateResult: function (d) { return $(d.text); },
          templateSelection: function (d) { return $(d.text); },
        })
        streamInfoCard.find('.stream-info-reaction-select').val(null);
        streamInfoCard.appendTo("#stream-info-cards");
      });

      $('#reaction-info-cards').empty();
      $.each($('#reaction').val().split(','), function(index, reaction) {
        var reactionInfoCard = $('#reaction-info-card-template').clone();
        reactionInfoCard.attr('id', 'reaction-info-card-' + index);
        reactionInfoCard.attr('style', '');
        var formula = document.createElement('a');
        formula.innerHTML = reaction;
        reactionInfoCard.find('.card-title').first().text('Chemical Reaction: ');
        $(formula).appendTo(reactionInfoCard.find('.card-title').first());
        reactionInfoCard.appendTo("#reaction-info-cards");
      });

      getSolventMiscibility();
      getSoluteSolubility();
      getPubChemPhysicalProperty();
      getChemSpiderPhysicalProperty();
      getWikipediaPhysicalProperty();

      generateState = true;
    })

    $(document).on('change', '#accumulation-select', function() {
      var accumulationPhenomenon = $('#accumulation-select').val();
      if (accumulationPhenomenon) {
        accumulationPhenomenon = accumulationPhenomenon.replaceAll(' ', '_');
        var flowPatternPhenomena = entity['phenomenon'][accumulationPhenomenon]['flow_patterns'].slice();
        var phenomenonData = [];
        $.each(flowPatternPhenomena, function(_, phenomenon) {
          phenomenonData.push({id: phenomenon, text: phenomenon.replaceAll('_', ' ')});
        });
        var parentElem = $('#flow-pattern-select').parent();
        $('#flow-pattern-select').remove();
        var select = $('<select></select>')
        $(select).addClass('select2');
        $(select).attr('id', 'flow-pattern-select');
        $(select).attr('style', 'width: 100%;');
        $(select).attr('data-placeholder', 'Select an option');
        $(select).select2({data: phenomenonData});
        parentElem.append(select);
        $('#flow-pattern-select').select2();
        $('#flow-pattern-select').val(null).trigger('change');
      }
    })

    $(document).on('change', '#flow-pattern-select', function() {
      var flowPatternPhenomenon = $('#flow-pattern-select').val();
      if (flowPatternPhenomenon) {
        flowPatternPhenomenon = flowPatternPhenomenon.replaceAll(' ', '_');
        var molecularTransportPhenomena = entity['phenomenon'][flowPatternPhenomenon]['molecular_transport_phenomena'].slice();
        var phenomenonData = [];
        $.each(molecularTransportPhenomena, function(_, phenomenon) {
          phenomenonData.push({id: phenomenon, text: phenomenon.replaceAll('_', ' ')});
        });
        var parentElem = $('#molecular-transport-select').parent();
        $('#molecular-transport-select').remove();
        var select = $('<select></select>')
        $(select).addClass('select2');
        $(select).attr('id', 'molecular-transport-select');
        $(select).attr('multiple', 'multiple');
        $(select).attr('style', 'width: 100%;');
        $(select).attr('data-placeholder', 'Select options');
        $(select).select2({data: phenomenonData});
        parentElem.append(select);
        $('#molecular-transport-select').select2();
        $(document).on('change', '#molecular-transport-select', triggerMolecularTransportInfoCard);
        $('#molecular-transport-select').val(null).trigger('change');
      }
    })

    $(document).on('change', '#molecular-transport-select', function() {
      $('#model-parameter-laws').children().remove();
      if ($('#molecular-transport-select').val().length == 0) return;
      var flowPatternPhenomenon = $('#flow-pattern-select').val();
      if (flowPatternPhenomenon) {
        flowPatternPhenomenon = flowPatternPhenomenon.replaceAll(' ', '_');
        var molecularTransportPhenomena = $('#molecular-transport-select').val();
        var parameters = [];
        $.each(entity['law'], function(law, lawDict) {
          if (lawDict['phenomenon'] == flowPatternPhenomenon) {
            parameters = parameters.concat(lawDict['model_variables']);
          }
        });
        $.each(entity['law'], function(law, lawDict) {
          if (molecularTransportPhenomena.includes(lawDict['phenomenon'])) {
            parameters = parameters.concat(lawDict['model_variables']);
          }
        });
        parameters = new Set(parameters);
        parameters = Array.from(parameters);
        parameters = parameters.filter((parameter) => {
          var lawWithRules = entity['model_variable'][parameter]['laws'].filter((law) => {
            return entity['law'][law]['rule'];
          })
          return lawWithRules.length > 0;
        });
        var phenomena = molecularTransportPhenomena;
        phenomena.push(flowPatternPhenomenon);
        phenomena = new Set(phenomena);

        var parameterLawDict = {};
        $(parameters).each(function(_, parameter) {
          var laws = [];
          $.each(entity['model_variable'][parameter]['laws'], function(_, law) {
            var lawRule = entity['law'][law]['rule'];
            var lawRulePhenomena = new Set(entity['rule'][lawRule]['phenomena']);
            if (lawRulePhenomena.isSubsetOf(phenomena)) {
              laws.push(law);
            }
          });
          if (laws.length > 0) {
            parameterLawDict[parameter] = laws;
          }
        });

        $.each(parameterLawDict, function(parameter, laws) {
          var parameterDiv = $('<div class="mt-2"><div>' + parameter.replaceAll('_', ' ') + '&nbsp;&nbsp;' + entity['model_variable'][parameter]['symbol'] + '</div></div>');
          var lawData = [];
          $.each(laws, function(_, law) {
            var text = law.split('by_')[0].replaceAll('_', ' ') + '(' + law.split('by_')[1].replaceAll('_', ' ') + ')';
            lawData.push({id: law, text: text});
          })
          var lawSelect = $('<select></select>')
          $(lawSelect).addClass('select2');
          $(lawSelect).attr('id', parameter.replaceAll('_', '-').toLowerCase() + '-law-select');
          $(lawSelect).attr('parameter', parameter);
          $(lawSelect).attr('class', 'molecular-transport-parameter-law');
          $(lawSelect).attr('style', 'width: 100%;');
          $(lawSelect).attr('data-placeholder', 'Select an option');
          $(lawSelect).select2({data: lawData});
          $(lawSelect).val(null);
          lawSelect.appendTo(parameterDiv);
          parameterDiv.appendTo('#model-parameter-laws');
          $('#' + parameter.replaceAll('_', '-').toLowerCase() + '-law-select').select2();
        });
        $('#model-parameter-laws').find('div:eq(0)').removeClass('mt-2');
        $(document).on('change', '.molecular-transport-parameter-law', triggerReactorInfoCard);
        $(document).on('change', '.molecular-transport-parameter-law', triggerMolecularTransportInfoCard);
      }
    })

    function triggerReactorInfoCard() {
      $('.reactor-info-parameter').find('input').val(null);
      $('.reactor-info-parameter').css('display', 'none');

      var parameters = [];
      var laws = [];
      var accumulationPhenomenon = $('#accumulation-select').val();
      if (accumulationPhenomenon) {
        accumulationPhenomenon = accumulationPhenomenon.replaceAll(' ', '_');
        for (var li in entity['law']) {
          var law = entity['law'][li];
          if (law['phenomenon'] == accumulationPhenomenon) {
            for (var pi in law['model_variables']) {
              var parameter = law['model_variables'][pi]
              if (!parameters.includes(parameter))
                parameters.push(parameter);
            }
          }
        }
      }
      var flowPatternPhenomenon = $('#flow-pattern-select').val()
      if (flowPatternPhenomenon) {
        flowPatternPhenomenon = flowPatternPhenomenon.replaceAll(' ', '_');
        for (var li in entity['law']) {
          var law = entity['law'][li];
          if (law['phenomenon'] == flowPatternPhenomenon) {
            for (var pi in law['model_variables']) {
              var parameter = law['model_variables'][pi]
              if (!parameters.includes(parameter))
                parameters.push(parameter);
            }
          }
        }
      }
      $.each($('.molecular-transport-parameter-law'), function(_, elem) {
        var law = $(elem).val();
        if (law) {
          laws.push(law);
          for (var pi in entity.law[law]['model_variables']) {
            var parameter = entity.law[law]['model_variables'][pi]
            if (!parameters.includes(parameter))
              parameters.push(parameter);
          }
        }
      })

      $.each($('.reactor-info-parameter'), function(index, parameterNode) {
        if (parameters.includes($(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_')))
          parameterNode.style.display = 'flex';
      })
    }
    $(document).on('change', '#accumulation-select', triggerReactorInfoCard)
    $(document).on('change', '#flow-pattern-select', triggerReactorInfoCard)

    function triggerMolecularTransportInfoCard() {
      $('.molecular-transport-info-parameter').find('input').val(null);
      $('.molecular-transport-info-parameter').css('display', 'none');
      $('.molecular-transport-info-species-parameter').find('input').val(null);
      $('.molecular-transport-info-species-parameter').css('display', 'none');
      $('.molecular-transport-info-stream-species-parameter').find('input').val(null);
      $('.molecular-transport-info-stream-species-parameter').css('display', 'none');

      var streams = $('#stream').val().split(',');
      var species = $('#species').val().split(',');

      var parameters = [];
      var molecularTransportPhenomena = $('#molecular-transport-select').val();
      $.each(entity['law'], function(law, lawDict) {
        if (molecularTransportPhenomena.includes(lawDict['phenomenon'])) {
          parameters = parameters.concat(entity['law'][law]['model_variables']);
        }
      });
      $.each($('.molecular-transport-parameter-law'), function(_, elem) {
        var law = $(elem).val();
        if (law) {
          parameters = parameters.concat(entity['law'][law]['model_variables']);
        }
      });
      $.each($('.molecular-transport-info-parameter'), function(index, parameterNode) {
        if (parameters.includes($(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_')))
          parameterNode.style.display = 'flex';
      });
      $.each($('.molecular-transport-info-species-parameter'), function(index, parameterNode) {
        if (parameters.includes($(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_'))) {
          parameterNode.style.display = 'flex';
          var unit = entity['model_variable'][$(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_')]['unit'];
          var parameterValueDiv = $(parameterNode).children('div:eq(1)');
          $(parameterValueDiv).children().remove();
          $.each($(species), function(index, s) {
            var div = document.createElement('div');
            div.style.display = 'flex';
            div.style.float = 'left';
            div.style.width = '100%';
            div.classList.add('mb-1');
            $(div).append($('<a style="width: 35%; color: #999; text-align: center;"></a>'));
            $(div).append($('<a style="width: 45%; color: #999; text-align: center;"></a>'));
            $(div).append($('<input class="form-control" type="number" style="width: 20%; padding-left: 2px; margin-left: 4px; height: 24px" step="any"/>'));
            $(div).append($('<a class="unit" style="text-align: center; width: 60px; height: 24px; color: #999;"></a>'));
            div.childNodes[1].innerHTML = s;
            if (unit) {
              div.childNodes[3].innerHTML = entity['unit'][unit]['symbol'];
            }
            parameterValueDiv.append(div);
          });
        }
      });
      $.each($('.molecular-transport-info-stream-species-parameter'), function(index, parameterNode) {
        if (parameters.includes($(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_'))) {
          parameterNode.style.display = 'flex';
          var unit = entity['model_variable'][$(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_')]['unit'];
          var parameterValueDiv = $(parameterNode).children('div:eq(1)');
          $(parameterValueDiv).children().remove();
          $.each($(streams), function(index, stream) {
            $.each($(species), function(index, s) {
              var div = document.createElement('div');
              div.style.display = 'flex';
              div.style.float = 'left';
              div.style.width = '100%';
              div.classList.add('mb-1');
              $(div).append($('<a style="width: 35%; color: #999; text-align: center;"></a>'));
              $(div).append($('<a style="width: 45%; color: #999; text-align: center;"></a>'));
              $(div).append($('<input class="form-control" type="number" style="width: 20%; padding-left: 2px; margin-left: 4px; height: 24px" step="any"/>'));
              $(div).append($('<a class="unit" style="text-align: center; width: 60px; height: 24px; color: #999;"></a>'));
              div.childNodes[0].innerHTML = stream;
              div.childNodes[1].innerHTML = s;
              if (unit) {
                div.childNodes[3].innerHTML = entity['unit'][unit]['symbol'];
              }
              parameterValueDiv.append(div);
            });
          });
        }
      });
    }

    function triggerStreamInfoCard() {
      $('.stream-info-parameter').find('input').val(null);
      $('.stream-info-parameter').css('display', 'none');

      var parameters = [];
      var laws = [];
      var flowPatternPhenomenon = $('#flow-pattern-select').val()
      if (flowPatternPhenomenon) {
        flowPatternPhenomenon = flowPatternPhenomenon.replaceAll(' ', '_');
        for (var law in entity.law) {
          if (entity.law[law]['phenomenon'] == flowPatternPhenomenon) {
            for (var pi in entity.law[law]['model_variables']) {
              var parameter = entity.law[law]['model_variables'][pi]
              if (!parameters.includes(parameter))
                parameters.push(parameter);
            }
            laws.push(law);
          }
        }
        for (var pi in parameters) {
          parameter = parameters[pi];
          var intersect = $.grep(entity.model_variable[parameter]['laws'], function(element) {
            return $.inArray(element, laws) != -1;
          });
          if (intersect.length > 0)
            parameters.splice(parameters.indexOf(parameter), 1);
        }
      }

      var re = new RegExp('Gas');
      $.each($('.stream-info-parameter'), function(index, parameterNode) {
        var streamState = $(parameterNode).closest('.stream-info-input').find('.stream-info-state-select').val();
        var parameter = $(parameterNode).find('.parameter-name').first().text().replaceAll(' ', '_');
        if (streamState == 'gaseous' & re.test(parameter) & parameters.includes(parameter)) {
          parameterNode.style.display = 'flex';
        }
        if (streamState == 'liquid' & !re.test(parameter) & parameters.includes(parameter)) {
          parameterNode.style.display = 'flex';
        }
      })
    }
    $(document).on('change', '#flow-pattern-select', triggerStreamInfoCard)

    $(document).on('change', '.reaction-select', function() {
      var reactionPhenomena = $(this).val().map((x) => {return x.replaceAll(' ', '_')});
      var reactionInfoCard = $('#reaction-info-card-' + $('.reaction-select').index($(this)).toString());
      var reaction = $('#reaction').val().split(',')[$('.reaction-select').index($(this))];
      var reNum = new RegExp("^\\d+$");
      var reagents = $.map(reaction.split(' > ')[0].split(' + '), function(s, i) {
        if (reNum.test(s.split(' ')[0])) {
          return s.split(' ').slice(1).join(' ');
        } else {
          return s;
        }
      });
      var solvents = $('#solvent').val().split(',');

      // reaction info card
      $(reactionInfoCard).find('.reaction-info-parameter').val(null);
      $(reactionInfoCard).find('.reaction-info-parameter').css('display', 'none');
      var parameters = [];
      for (var li in entity.law) {
        var law = entity.law[li];
        if (reactionPhenomena.includes(law['phenomenon'])) {
          for (var pi in law['model_variables']) {
            parameter = law['model_variables'][pi];
            if (!parameters.includes(parameter) & !entity.model_variable[parameter]['definition'])
              parameters.push(parameter);
            if (entity.model_variable[parameter]['definition']) {
              var definition = entity.model_variable[parameter]['definition'];
              for (var dpi in entity.definition[definition]['model_variables']) {
                dparameter = entity.definition[definition]['model_variables'][dpi];
                if (!parameters.includes(dparameter))
                  parameters.push(dparameter);
              }
            }
          }
        }
      }

      $(reactionInfoCard).find('.reaction-info-parameter .parameter-value').empty();
      $.each($(reactionInfoCard).find('.reaction-info-parameter'), function(index, parameterNode) {
        var parameterName = $(parameterNode).find('.parameter-name:eq(0)').text().replaceAll(' ', '_');
        if (parameters.includes(parameterName))
          parameterNode.style.display = 'flex';
          var parameterValueDiv = $(parameterNode).children('div:eq(1)');
          var div = document.createElement('div');
          div.style.display = 'flex';
          div.style.float = 'left';
          div.style.width = '100%';
          div.classList.add('mb-1');
          $(div).append($('<a style="width: 50%; color: #999; text-align: center;"></a>'));
          $(div).append($('<input class="form-control" type="number" style="width: 50%; padding-left: 2px; margin-left: 4px; height: 24px" step="any"/>'));
          parameterValueDiv.append(div)
      })

      $(reactionInfoCard).find('.reaction-info-species-parameter .parameter-value').empty();
      $(reactionInfoCard).find('.reaction-info-species-parameter').css('display', 'none');
      $.each($(reactionInfoCard).find('.reaction-info-species-parameter'), function(index, parameterNode) {
        var parameterName = $(parameterNode).find('.parameter-name:eq(0)').text().replaceAll(' ', '_');
        if (parameters.includes(parameterName)) {
          parameterNode.style.display = 'flex';
          var parameterValueDiv = $(parameterNode).children('div:eq(1)');
          $.each($(reagents), function(index, reagent) {
            var div = document.createElement('div');
            div.style.display = 'flex';
            div.style.float = 'left';
            div.style.width = '100%';
            div.classList.add('mb-1');
            $(div).append($('<a style="width: 50%; color: #999; text-align: center;"></a>'));
            $(div).append($('<input class="form-control" type="number" style="width: 50%; padding-left: 2px; margin-left: 4px; height: 24px" step="any"/>'));
            div.childNodes[0].innerHTML = reagent;
            parameterValueDiv.append(div)
          })
        }
      })

      $(reactionInfoCard).find('.reaction-info-solvent-parameter .parameter-value').empty();
      $(reactionInfoCard).find('.reaction-info-solvent-parameter').css('display', 'none');
      $.each($(reactionInfoCard).find('.reaction-info-solvent-parameter'), function(index, parameterNode) {
        var parameterName = $(parameterNode).find('.parameter-name:eq(0)').text().replaceAll(' ', '_');
        if (parameters.includes(parameterName)) {
          parameterNode.style.display = 'flex';
          var parameterValueDiv = $(parameterNode).children('div:eq(1)');
          $.each($(solvents), function(index, solvent) {
            var div = document.createElement('div');
            div.style.display = 'flex';
            div.style.float = 'left';
            div.style.width = '100%';
            div.classList.add('mb-1');
            $(div).append($('<a style="width: 50%; color: #999; text-align: center;"></a>'));
            $(div).append($('<input class="form-control" type="number" style="width: 50%; padding-left: 2px; margin-left: 4px; height: 24px" step="any"/>'));
            div.childNodes[0].innerHTML = solvent;
            parameterValueDiv.append(div)
          })
        }
      })

      $(reactionInfoCard).find('.reaction-info-specific-law textarea').val(null);
      $(reactionInfoCard).find('.reaction-info-specific-law').css('display', 'none');
      $.each($(reactionInfoCard).find('.reaction-info-specific-law'), function(index, lawNode) {
        var lawPhenomenon = $(lawNode).find('.law-phenomenon').first().text().substring(4).replaceAll(' ', '_');
        if (reactionPhenomena.includes(lawPhenomenon))
          lawNode.style.display = 'flex';
      })

      // species info card
      $.each($('.species-info-parameter'), function(index, parameterNode) {
        var parameterName = $(parameterNode).find('.parameter-name:eq(0)').text().replaceAll(' ', '_');
        if (parameters.includes(parameterName)) {
          parameterNode.style.display = 'flex';
          var parameterValueDiv = $(parameterNode).children('div:eq(1)');
          $(parameterValueDiv).children().remove();
          $.each($('#species').val().split(','), function(index, species) {
            var div = document.createElement('div');
            div.style.display = 'flex';
            div.style.float = 'left';
            div.style.width = '100%';
            div.classList.add('mb-1');
            $(div).append($('<a style="width: 50%; color: #999; text-align: center;"></a>'));
            $(div).append($('<input class="form-control" type="number" style="width: 50%; padding-left: 2px; margin-left: 4px; height: 24px" step="any"/>'));
            div.childNodes[0].innerHTML = species;
            parameterValueDiv.append(div)
          })
        }
      })
    })

    $(document).on('change', '.stream-info-state-select', function() {
      if ($(this).closest('.stream-info-input').find('.stream-info-state-select').first().val() == 'gaseous') {
        $(this).closest('.stream-info-input').find('.stream-info-solvent-select').prop("disabled", true).val(null).trigger('change');
        $(this).closest('.stream-info-input').find('.stream-info-reaction-select').prop("disabled", true).val(null).trigger('change');
        $(this).closest('.stream-info-input').find('input').val(null).trigger('change');
        var re = new RegExp("Gas");
        $.each($(this).closest('.stream-info-input').find('.stream-info-parameter'), function(index, streamParameterNode) {
          if (re.test($(streamParameterNode).find('.parameter-name').first().text())) {
            streamParameterNode.style.display = "flex";
          }
          else
            streamParameterNode.style.display = "none";
        })
      }
      else {
        $(this).closest('.stream-info-input').find('.stream-info-solvent-select').prop("disabled", false).val(null).trigger('change');
        $(this).closest('.stream-info-input').find('.stream-info-reaction-select').prop("disabled", false).val(null).trigger('change');
        $(this).closest('.stream-info-input').find('input').val(null).trigger('change');
        var re = new RegExp("Gas");
        $.each($(this).closest('.stream-info-input').find('.stream-info-parameter'), function(index, streamParameterNode) {
          if (re.test($(streamParameterNode).find('.parameter-name').first().text()))
            streamParameterNode.style.display = "none";
          else
            streamParameterNode.style.display = "flex";
        })
      }
    })
    
    // TODO
    function checkValidation() {
      return true;
    }

    function getModelContext() {
      var species = $('#species').val().split(',');
      var reactions = $('#reaction').val().split(',');
      var streams = $('#stream').val().split(',');
      var solvents = $('#solvent').val().split(',');
      var catalysts = $('#catalyst').val().split(',').filter((x) => {return x;});
      var accumulationPhenomenon = $('#accumulation-select').val();
      accumulationPhenomenon = accumulationPhenomenon ? accumulationPhenomenon.replaceAll(' ', '_') : accumulationPhenomenon;
      var flowPatternPhenomenon = $('#flow-pattern-select').val()
      flowPatternPhenomenon = flowPatternPhenomenon ? flowPatternPhenomenon.replaceAll(' ', '_') : flowPatternPhenomenon;
      var molecularTransportPhenomena = $('#molecular-transport-select').val().map((x) => {return x.replaceAll(' ', '_')});
      var reactionPhenomena = {};
      $(reactions).each(function(index, reaction) {
        reactionPhenomena[reactions[index]] = $('#reaction-card-' + index.toString()).find('.reaction-select').val().map((x) => {return x.replaceAll(' ', '_')});
      })

      var speciesParameter = {}
      $('.species-info-parameter[style*="display: flex"]').each(function(_, parameter) {
        var p = $(parameter).find('.parameter-name').text().replaceAll(' ', '_');
        var v = {};
        $(parameter).find('.parameter-value').children().each(function (_, div) {
          v[$(div).children(':eq(0)').html()] = parseFloat($(div).children(':eq(1)').val());
        })
        speciesParameter[p] = v;
      })
      var reactorParameter = {};
      $('.reactor-info-parameter[style*="display: flex"]').each(function(_, parameter) {
        var p = $(parameter).find('.parameter-name').text().replaceAll(' ', '_');
        var v = parseFloat($(parameter).find('input').val());
        reactorParameter[p] = v;
      })
      var molecularTransportParameter = {};
      $('.molecular-transport-info-parameter[style*="display: flex"]').each(function(_, parameter) {
        var p = $(parameter).find('.parameter-name').text().replaceAll(' ', '_');
        var v = parseFloat($(parameter).find('input').val());
        molecularTransportParameter[p] = v;
      })
      $('.molecular-transport-info-species-parameter[style*="display: flex"]').each(function(_, parameter) {
        var p = $(parameter).find('.parameter-name').text().replaceAll(' ', '_');
        molecularTransportParameter[p] = {};
        $(parameter).find('.parameter-value').children().each(function(_, parameterValue) {
          var species = parameterValue.childNodes[1].innerHTML;
          var v = parseFloat($(parameterValue).find('input').val());
          molecularTransportParameter[p][species] = v;
        });
      })
      $('.molecular-transport-info-stream-species-parameter[style*="display: flex"]').each(function(_, parameter) {
        var p = $(parameter).find('.parameter-name').text().replaceAll(' ', '_');
        molecularTransportParameter[p] = {};
        $(parameter).find('.parameter-value').children().each(function(_, parameterValue) {
          var stream = parameterValue.childNodes[0].innerHTML;
          var species = parameterValue.childNodes[1].innerHTML;
          var v = parseFloat($(parameterValue).find('input').val());
          if (!molecularTransportParameter[p][stream]) {
            molecularTransportParameter[p][stream] = {};
          }
          molecularTransportParameter[p][stream][species] = v;
        });
      })
      var parameterLaw = {};
      $('.molecular-transport-parameter-law').each(function(_, law) {
        parameterLaw[$(law).attr('parameter')] = $(law).val();
      });
      var streamParameter = {};
      $('#stream-info-cards').children().each(function(_, streamInfoCard) {
        var stream = $.trim($(streamInfoCard).find('.card-title').text().split(':').slice(-1));
        var streamDict = {};
        streamDict['state'] = $(streamInfoCard).find('.stream-info-state-select').val();
        streamDict['solvent'] = $(streamInfoCard).find('.stream-info-solvent-select').val();
        streamDict['reactions'] = $(streamInfoCard).find('.stream-info-reaction-select').val().map((x) => {return x.replaceAll('&gt;', '>')});
        $(streamInfoCard).find('.stream-info-parameter[style*="display: flex"]').each(function(_, elem) {
          streamDict[$(elem).find('.parameter-name').text().replaceAll(' ', '_')] = parseFloat($(elem).find('input').val());
        })
        streamParameter[stream] = streamDict;
      })
      var reactionParameter = {};
      $('#reaction-info-cards').children().each(function(index, reactionInfoCard) {
        var reaction = $('#reaction').val().split(',')[index];
        var reactionDict = {};
        $(reactionInfoCard).find('.reaction-info-parameter[style*="display: flex"]').each(function (_, elem) {
          var parameterName = $(elem).find('.parameter-name').text().replaceAll(' ', '_');
          reactionDict[parameterName] = {};
          $(elem).find('.parameter-value').find('div').each(function (_, div) {
            reactionDict[parameterName] = parseFloat($(div).children(':eq(1)').val());
          });
        });
        $(reactionInfoCard).find('.reaction-info-species-parameter[style*="display: flex"]').each(function (_, elem) {
          var parameterName = $(elem).find('.parameter-name').text().replaceAll(' ', '_');
          reactionDict[parameterName] = {};
          $(elem).find('.parameter-value').find('div').each(function (_, div) {
            reactionDict[parameterName][div.childNodes[0].innerHTML] = parseFloat($(div).children(':eq(1)').val());
          });
        });
        $(reactionInfoCard).find('.reaction-info-solvent-parameter[style*="display: flex"]').each(function (_, elem) {
          var parameterName = $(elem).find('.parameter-name').text().replaceAll(' ', '_');
          reactionDict[parameterName] = {};
          $(elem).find('.parameter-value').find('div').each(function (_, div) {
            reactionDict[parameterName][div.childNodes[0].textContent] = parseFloat($(div).children(':eq(1)').val());
          });
        });
        $(reactionInfoCard).find('.reaction-info-specific-law[style*="display: flex"]').each(function (_, elem) {
          var lawPhenomenon = $(elem).find('.law-phenomenon').first().text().substring(4).replaceAll(' ', '_');
          reactionDict[lawPhenomenon] = $(elem).find('textarea').val();
        });
        reactionParameter[reaction] = reactionDict;
      })

      var model_context = {
        'method': 'bottom-up',
        'basic': {
          'species': species,
          'reactions': reactions,
          'streams': streams,
          'solvents': solvents,
          'catalysts': catalysts,
        },
        'description': {
          'accumulation': accumulationPhenomenon,
          'flow_pattern': flowPatternPhenomenon,
          'molecular_transport': molecularTransportPhenomena,
          'parameter_law': parameterLaw,
          'reaction': reactionPhenomena,
        },
        'information': {
          'species': speciesParameter,
          'reactor': reactorParameter,
          'molecular_transport': molecularTransportParameter,
          'streams': streamParameter,
          'reactions': reactionParameter,
        }
      };
      return model_context;
    }

    function loadModelContext(modelContext) {
      $('#species').val(modelContext['basic']['species']);
      $('#reaction').val(modelContext['basic']['reactions']);
      $('#stream').val(modelContext['basic']['streams']);
      $('#solvent').val(modelContext['basic']['solvents']);
      $('#catalyst').val(modelContext['basic']['catalysts']);
      setTimeout(function() {
        $('#generate-button').click();
        $('#accumulation-select').val(modelContext['description']['accumulation']).trigger('change');
        $('#flow-pattern-select').val(modelContext['description']['flow_pattern']).trigger('change');
        $('#molecular-transport-select').val(modelContext['description']['molecular_transport']).trigger('change');
        $.each(modelContext['description']['parameter_law'], function(parameter, law) {
          $('#' + parameter.replaceAll('_', '-').toLowerCase() + '-law-select').val(law).trigger('change');
        });
        $.each(modelContext['basic']['reactions'], function(_, reaction) {
          $.each($('.reaction-card'), function(_, reactionCard) {
            if ($(reactionCard).find('.card-title a').html() && $(reactionCard).find('.card-title a').html().replaceAll('&gt;', '>') == reaction) {
              $(reactionCard).find('.reaction-select').val(
                $.map(modelContext['description']['reaction'][reaction], (x) => {return x.replaceAll('_', ' ')})
              ).trigger('change');
            }
          });
        });
        $.each(modelContext['information']['species'], function(parameterName, parameterValue) {
          $('.species-info-parameter').each(function(_, parameterDiv) {
            if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
              $(parameterDiv).find('.parameter-value input').each(function(index, parameterInput){
                $(parameterInput).val(parameterValue[modelContext['basic']['species'][index]]);
              });
            }
          });
        });
        $.each(modelContext['information']['reactor'], function(parameterName, parameterValue) {
          $('.reactor-info-parameter').each(function(_, parameterDiv) {
            if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
              $(parameterDiv).find('input').val(parameterValue);
            }
          });
        });
        $.each(modelContext['information']['molecular_transport'], function(parameterName, parameterValue) {
          $('.molecular-transport-info-parameter').each(function(_, parameterDiv) {
            if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
              $(parameterDiv).find('input').val(parameterValue);
            }
          });
          $('.molecular-transport-info-species-parameter').each(function(_, parameterDiv) {
            if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
              $(parameterDiv).find('.parameter-value div').each(function(index, parameterInputDiv) {
                var species = parameterInputDiv.childNodes[1].innerHTML;
                $(parameterInputDiv).find('input').val(parameterValue[species]);
              });
            }
          });
          $('.molecular-transport-info-stream-species-parameter').each(function(_, parameterDiv) {
            if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
              $(parameterDiv).find('.parameter-value div').each(function(index, parameterInputDiv) {
                var stream = parameterInputDiv.childNodes[0].innerHTML;
                var species = parameterInputDiv.childNodes[1].innerHTML;
                $(parameterInputDiv).find('input').val(parameterValue[stream][species]);
              });
            }
          });
          $('.molecular-transport-info-stream-species-parameter').each(function(_, parameterDiv) {
            if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
              $(parameterDiv).find('.parameter-value div').each(function(index, parameterInputDiv) {
                var stream = parameterInputDiv.childNodes[0].innerHTML;
                var species = parameterInputDiv.childNodes[1].innerHTML;
                $(parameterInputDiv).find('input').val(parameterValue[stream][species]);
              });
            }
          });
        });
        $.each(modelContext['information']['streams'], function(stream, streamValue) {
          $.each($('.stream-info-card'), function(_, streamInfoCard) {
            if ($(streamInfoCard).find('.card-title').text() && $(streamInfoCard).find('.card-title').text().replaceAll('Stream: ', '') == stream) {
              $(streamInfoCard).find('.stream-info-state-select').val(streamValue['state']).trigger('change');
              $(streamInfoCard).find('.stream-info-solvent-select').val(streamValue['solvent']);
              $(streamInfoCard).find('.stream-info-reaction-select').val(streamValue['reactions']).trigger('change');
              $.each(streamValue, function(parameterName, parameterValue) {
                $(streamInfoCard).find('.stream-info-parameter').each(function(_, parameterDiv) {
                  if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
                    $(parameterDiv).find('input').val(parameterValue);
                  }
                });
              });
            }
          });
        });
        $.each(modelContext['information']['reactions'], function(reaction, reactionValue) {
          $.each($('.reaction-info-card'), function(_, reactionInfoCard) {
            if ($(reactionInfoCard).find('.card-title a').html() && $(reactionInfoCard).find('.card-title a').html().replaceAll('&gt;', '>') == reaction) {
              $.each(reactionValue, function(parameterName, parameterValue) {
                $(reactionInfoCard).find('.reaction-info-parameter').each(function(_, parameterDiv) {
                  if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
                    $(parameterDiv).find('input').val(parameterValue);
                  }
                });
                $(reactionInfoCard).find('.reaction-info-species-parameter').each(function(_, parameterDiv) {
                  if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
                    $(parameterDiv).find('.parameter-value').children().each(function(_, parameterSpeciesInputDiv){
                      $(parameterSpeciesInputDiv).find('input').val(parameterValue[$(parameterSpeciesInputDiv).children(':eq(0)').html()]);
                    });
                  }
                });
                $(reactionInfoCard).find('.reaction-info-solvent-parameter').each(function(_, parameterDiv) {
                  if ($(parameterDiv).find('.parameter-name').text().replaceAll(' ', '_') == parameterName) {
                    $(parameterDiv).find('.parameter-value').children().each(function(_, parameterSolventInputDiv){
                      $(parameterSolventInputDiv).find('input').val(parameterValue[$(parameterSolventInputDiv).children(':eq(0)').html()]);
                    });
                  }
                });
                $(reactionInfoCard).find('.reaction-info-specific-law').each(function(_, LawDiv) {
                  if ($(LawDiv).find('.law-phenomenon').text().substring(4).replaceAll(' ', '_') == parameterName) {
                    $(LawDiv).find('textarea').val(parameterValue);
                  }
                });
              });
            }
          });
        });
      }, 100);
    }

    $(document).on('click', '#export-model', function() {
      if (!generateState) {
        alert('Model Not Generated!');
        return;
      }
      
      var modelContext = getModelContext();
      var modelRequest = {
        'model_type': $('#export-model-type').val(),
        'model_context': modelContext,
      }
      var modelRequestJson = JSON.stringify(modelRequest);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.origin + '/model_export', false);
      xhr.setRequestHeader('Content-type','application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          const downloadLink = document.createElement('a');
          let content = xhr.response;
          let blob = new Blob([content]);
          downloadLink.href = URL.createObjectURL(blob);
          if (modelRequest['model_type'] == 'scipy') {
            downloadLink.setAttribute('download', 'model.py');
          } else if (modelRequest['model_type'] == 'pyomo') {
            downloadLink.setAttribute('download', 'model.py');
          } else if (modelRequest['model_type'] == 'julia') {
            downloadLink.setAttribute('download', 'model.jl');
          } else {
            downloadLink.setAttribute('download', 'model');
          }
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        }
      };
      xhr.send(modelRequestJson);
    })
  </script>
{% endblock javascripts %}
